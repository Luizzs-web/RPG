<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WRPG</title>s
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap"
        rel="stylesheet">

    <style type="text/tailwindcss">
        .attribute-mode-btn.active {
    @apply bg-[#543C32] ring-2 ring-[#A1887F]; 
}
    #character-setup-screen.hidden {
        display: none;
    }

    body {
        background-color: #3B2E26; 
        font-family: 'Merriweather', serif;
        color: #D7CCC8; 
        transition: background-image 0.7s ease-in-out;
    }

    .bg-theme-default {
        background-color: #3B2E26 !important; 
    }
    .bg-theme-forest {
        background-image: url('https://source.unsplash.com/random/1920x1080/?dark,fantasy,forest,night') !important; 
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    .bg-theme-battle {
        background-image: url('https://source.unsplash.com/random/1920x1080/?battlefield,fantasy,medieval,gloomy') !important; 
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    .bg-theme-dungeon {
        background-image: url('https://source.unsplash.com/random/1920x1080/?dungeon,dark,stone,corridor,shadows') !important; 
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    .bg-theme-boss-hall {
        background-image: url('https://source.unsplash.com/random/1920x1080/?throne,room,boss,hall,fantasy,epic,dark') !important; 
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    header.bg-slate-900 { 
        @apply bg-[#2A1F1B] border-b-2 border-[#1F1611]; 
    }
    header h1 { 
        @apply text-[#E0C097]; 
    }
    header nav button, header nav button i { 
        @apply text-[#D7CCC8] hover:text-[#FFF8E1]; 
        font-family: 'Merriweather', serif;
    }
    header nav button#btn-save-google, header nav button#btn-save-google i { 
        @apply text-[#FFCA28] hover:text-[#FFB300]; 
    }
    header nav button#btn-signout-google, header nav button#btn-signout-google i,
    header nav button#btn-sair, header nav button#btn-sair i { 
        @apply text-[#BCAAA4] hover:text-[#A1887F]; 
    }
    #google-user-greeting { 
        @apply text-[#D7CCC8]; 
    }

    #story-text, .bg-slate-700, .bg-slate-800, .bg-slate-600 {
        background-color: rgba(60, 45, 38, 0.6); 
        border: 1px solid rgba(83, 64, 55, 0.5); 
        @apply shadow-md;
    }
    #story-text {
        background-color: rgba(74, 59, 50, 0.65); 
        border: 1px solid #6D4C41; 
        @apply text-lg leading-relaxed select-text text-[#E0C097]; 
    }

    #choices button,
    #battle-main-commands button,
    #btn-salvar-atributos,
    #btn-comprar-mercador {
        @apply bg-[#6D4C41] hover:bg-[#543C32] text-[#FFF8E1] border border-[#4E342E] shadow-sm; 
        @apply focus:ring-[#A1887F] focus:ring-offset-2 focus:ring-offset-[#3B2E26]; 
        font-family: 'Merriweather', serif;
    }
    #choices button:disabled,
    #battle-main-commands button:disabled,
    #btn-comprar-mercador:disabled {
        @apply bg-[#5A4A44] text-[#887972] border-[#4A3A34] cursor-default; 
        font-family: 'Merriweather', serif;
    }

    .atributos-fundo {
        background-color: #31251E;  
        border: 2px solid #1F1611;  
        padding: 1rem;
    }
    #atributos-screen h2, #atributos-screen h4 {
        @apply text-[#E0C097];  
    }
    #atributos-screen .bg-slate-700, #atributos-screen .bg-slate-600 {  
        background-color: rgba(93, 64, 55, 0.4);
        border: 1px solid #4E342E;  
    }
    #status-nivel, #status-rank, #status-classe, #status-moedas,
    #bonus-dano-fisico, #bonus-dano-magico, #bonus-resistencia span, #bonus-fuga span, #bonus-esquiva span,
    #forca-val, #agilidade-val, #inteligencia-val, #resistencia-val, #vitalidade-val, #percepcao-val,
    #pontos-disponiveis {
        @apply text-[#D7CCC8];  
    }
    #status-nivel { @apply text-[#A5D6A7]; }  
    #status-rank { @apply text-[#FFCA28]; }  
    #status-classe { @apply text-[#BCAAA4]; }  
    #status-moedas { @apply text-[#FFCA28]; }  

    #atributos-screen .text-slate-400 {  
        @apply text-[#A1887F];  
    }
    #atributos-screen .text-purple-300 { @apply text-[#CE93D8]; }  
    #atributos-screen .text-red-400 { @apply text-[#EF9A9A]; }  
    #atributos-screen .text-blue-400 { @apply text-[#90CAF9]; }  

    #bonus-dano-fisico { @apply text-[#FFAB91]; }  
    #bonus-dano-magico { @apply text-[#81D4FA]; }  
    #bonus-resistencia span { @apply text-[#A5D6A7]; }
    #bonus-esquiva span, #bonus-fuga span { @apply text-[#BCAAA4]; }  

    #forca-rank, #agilidade-rank, #inteligencia-rank, #resistencia-rank, #vitalidade-rank, #percepcao-rank {
        @apply text-[#FFCA28];  
    }
    #pontos-disponiveis { @apply text-[#FFCA28]; }

    #status-xp-bar, #status-vida-bar, #status-mana-bar {
        border: 1px solid #543C32;  
    }
    
    #atributos-screen .btn-attr {
        font-family: 'Merriweather', serif;
        @apply text-[#FFF8E1] transition-colors px-3 py-1 rounded-md focus:outline-none focus:ring-2;
    }
    #atributos-screen button[data-action="dec"].btn-attr {  
        @apply bg-[#8D6E63] hover:bg-[#6D4C41] focus:ring-[#795548];  
    }
    #atributos-screen button[data-action="inc"].btn-attr {  
        @apply bg-[#6D4C41] hover:bg-[#543C32] focus:ring-[#6D4C41];  
    }

    #status-xp-bar { @apply bg-[#9C27B0]; }  
    #status-vida-bar { @apply bg-[#D32F2F]; }  
    #status-mana-bar { @apply bg-[#1976D2]; }

    #player-battle-hp-bar { @apply bg-[#D32F2F]; }
    #player-battle-mp-bar { @apply bg-[#1976D2]; }
    #player-battle-xp-bar { @apply bg-[#9C27B0]; }
    #summon-battle-hp-bar { @apply bg-[#795548]; }
    #enemy-battle-hp-bar { @apply bg-[#E64A19]; }  

    #player-battle-name, #summon-battle-name { @apply text-[#FFCA28]; }  
    #enemy-battle-name { @apply text-[#FF8A65]; }  
    #player-battle-hp-text, #player-battle-mp-text, #player-battle-xp-text,
    #summon-battle-hp-text,
    #enemy-battle-hp-text,
    #enemy-battle-rank {
        @apply text-[#E0C097];  
    }
    
    #player-battle-display .text-xs.text-slate-300,
    #summon-battle-display .text-xs.text-slate-300,
    #enemy-battle-display .text-xs.text-slate-300 {
        @apply text-[#BCAAA4]; 
    }

    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #2A1F1B; 
    }
    ::-webkit-scrollbar-thumb {
        background: #6D4C41; 
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #543C32; 
    }

    #lista-sombras-recipiente li { margin-bottom: 8px; }

    .equipment-slot-label {
        @apply font-semibold text-sm text-[#BCAAA4] block mb-1; 
    }
    .equipment-slot-display {
        @apply text-xs text-[#D7CCC8] italic bg-[rgba(93,64,55,0.4)] p-2 rounded min-h-[38px] flex items-center justify-center text-center border border-[#4E342E]; 
    }
    .character-placeholder-container i {
        @apply text-[#A1887F]; 
    }

    #skills-screen h2 { @apply text-[#E0C097] border-b-2 border-[#6D4C41] pb-2; } 
    #classe-info-skills { @apply mb-4 text-lg text-[#D7CCC8]; } 
    #classe-info-skills p:first-child { @apply font-bold text-[#E0C097]; }
    #lista-skills {
        background-color: rgba(60, 45, 38, 0.3); 
        border: 1px solid #786054; 
        @apply rounded-lg p-4 max-h-[450px] overflow-y-auto space-y-4;
    }
    #lista-skills > div {
        background-color: rgba(83, 60, 47, 0.6) !important; 
        border: 1px solid #6D4C41; 
        @apply rounded-md p-4 shadow;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    #lista-skills > div.opacity-60 { 
        background-color: rgba(74, 59, 50, 0.5) !important; 
        border-color: #543C32;
    }
    #lista-skills .skill-title {
        @apply font-bold text-lg text-[#FFCA28]; 
    }
    #lista-skills .skill-description {
        @apply text-sm text-[#D7CCC8] mt-1 mb-1 leading-relaxed; 
    }
    #lista-skills .skill-meta {
        @apply text-xs text-[#BCAAA4] italic mt-1; 
    }
    #lista-skills .skill-actions button {
        @apply bg-[#8D6E63] hover:bg-[#6D4C41] text-[#FFF8E1] text-xs px-3 py-1.5 rounded; 
        font-family: 'Merriweather', serif;
    }
    #skills-screen p.italic { @apply text-[#BCAAA4]; } 

    #inventario-screen h2, #inventario-screen h3 { @apply text-[#E0C097] border-b-2 border-[#6D4C41] pb-1; }
    #inventario-screen .bg-slate-700 { 
        background-color: rgba(93, 64, 55, 0.4); 
        border: 1px solid #4E342E;
    }
    #lista-itens li, #lista-sombras-recipiente li {
        background-color: rgba(83, 60, 47, 0.5) !important; 
        border: 1px solid #786054; 
    }
    #lista-itens .font-semibold, #lista-sombras-recipiente .text-purple-300 { 
        @apply text-[#FFCA28]; 
    }
    #lista-sombras-recipiente .text-purple-300 { @apply text-[#CE93D8]; } 

    #lista-itens .text-xs.text-slate-300, 
    #recipiente-sombras-container .text-slate-400 { 
        @apply text-[#BCAAA4]; 
    }

    #mercador-screen h2 { @apply text-[#E0C097] border-b-2 border-[#6D4C41] pb-2; }
    #mercador-screen .bg-slate-700 { 
        background-color: rgba(93, 64, 55, 0.4);
        border: 1px solid #4E342E;
    }
    #mercador-screen #lista-mercador li {
        background-color: rgba(83, 60, 47, 0.5) !important;
        border: 1px solid #786054;
    }
    #mercador-screen #lista-mercador .font-semibold.text-sky-400 { 
        @apply text-[#90CAF9]; 
    }
    #mercador-screen #lista-mercador .text-xs.text-slate-300 { 
        @apply text-[#BCAAA4]; 
    }
    #mercador-screen #lista-mercador .font-semibold.text-amber-300 { 
        @apply text-[#FFCA28]; 
    }

    #battle-interface-container {
        background-color: rgba(60, 45, 38, 0.4); 
    }
    #player-battle-display, #enemy-battle-display, #summon-battle-display {
        background-color: rgba(93, 64, 55, 0.5) !important; 
        border: 1px solid #4E342E; 
    }

    footer.bg-slate-900 { 
        @apply bg-[#2A1F1B] border-t-2 border-[#1F1611]; 
    }
    #chat-command-input {
        @apply bg-[#4E342E] text-[#E0C097] border-[#6D4C41] placeholder-[#A1887F]; 
        @apply focus:ring-[#786054] focus:border-[#786054];
        font-family: 'Merriweather', serif;
    }
    #btn-send-command {
        @apply bg-[#6D4C41] hover:bg-[#543C32] text-[#FFF8E1]; 
        font-family: 'Merriweather', serif;
    }

    #boss-door-visual {
        border: 5px solid #1F1611; 
    }

    #character-setup-screen {
        background-color: #31251E !important; 
        border: 2px solid #1F1611 !important;
    }
    #character-setup-screen h2 { @apply text-[#E0C097]; }
    #character-setup-screen label { @apply text-[#BCAAA4]; }
    #character-setup-screen input[type="text"] {
        @apply bg-[#4E342E] text-[#E0C097] border-[#6D4C41] placeholder-[#A1887F] focus:ring-[#786054] focus:border-[#786054];
    }
    #character-setup-screen p.text-xs { @apply text-[#A1887F]; }
    #btn-save-character-setup {
        @apply bg-[#6D4C41] hover:bg-[#543C32] text-[#FFF8E1] border border-[#4E342E];
    }

    </style>
</head>

<body class="min-h-screen flex flex-col bg-theme-default">
    <header class="bg-slate-900 p-4 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <h1 class="text-2xl font-extrabold tracking-wide select-none">Arkham</h1>
        <nav class="flex space-x-4 items-center">
            <button id="btn-inicio" aria-label="Início" class="p-2 disabled:opacity-50 disabled:cursor-not-allowed"
                title="Início">
                <i class="fas fa-home fa-lg"></i>
            </button>
            <button id="btn-atributos" aria-label="Distribuir Atributos"
                class="p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Distribuir Atributos">
                <i class="fas fa-dumbbell fa-lg"></i>
            </button>
            <button id="btn-skills" aria-label="Habilidades" class="p-2 disabled:opacity-50 disabled:cursor-not-allowed"
                title="Habilidades">
                <i class="fas fa-book fa-lg"></i>
            </button>
            <button id="btn-inventario" aria-label="Inventário"
                class="p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Inventário">
                <i class="fas fa-box-open fa-lg"></i>
            </button>
            <button id="btn-mercador" aria-label="Mercador" class="p-2 hidden" title="Mercador">
                <i class="fas fa-store fa-lg"></i>
            </button>

            <button id="btn-save-google" aria-label="Salvar Progresso Google" class="p-2 hidden"
                title="Salvar Progresso Google">
                <i class="fas fa-save fa-lg"></i>
            </button>
            <div id="google-signin-button-container" class="mx-1">
                 <div id="g_id_signin_button_div"></div> 
            </div>
            <span id="google-user-greeting" class="hidden text-sm"></span>
            <button id="btn-signout-google" aria-label="Sair da Conta Google" class="p-2 hidden"
                title="Sair da Conta Google">
                <i class="fas fa-door-open fa-lg"></i>
            </button>

            <button id="btn-sair" aria-label="Sair do Jogo" class="p-2 disabled:opacity-50 disabled:cursor-not-allowed"
                title="Sair do Jogo">
                <i class="fas fa-sign-out-alt fa-lg"></i>
            </button>
        </nav>
    </header>

    <div id="game-container" class="flex-1 flex flex-col overflow-hidden">
        <section id="character-setup-screen"
            class="max-w-xl mx-auto p-6 space-y-6 bg-[#f5e8c8] border-2 border-[#4e342e] rounded-lg shadow-xl hidden"
            style="background-image: none;">
            <h2 class="text-3xl font-extrabold text-center tracking-wider">Crie seu Herói</h2>
            <div class="space-y-4">
                <div>
                    <label for="player-name-input" class="block text-sm font-medium mb-1">Nome do Personagem:</label>
                    <input type="text" id="player-name-input" value="Herói" class="w-full p-2 rounded"
                        placeholder="Digite o nome do seu herói">
                </div>
                <div>
                    <label for="player-portrait-input" class="block text-sm font-medium mb-1">URL da Imagem do Retrato
                        (opcional):</label>
                    <input type="text" id="player-portrait-input" class="w-full p-2 rounded"
                        placeholder="https://exemplo.com/imagem.png">
                    <p class="text-xs mt-1">Deixe em branco para usar o retrato padrão. Use uma URL de imagem quadrada
                        (ex: 48x48px).</p>
                </div>
            </div>
            <div class="text-center">
                <button id="btn-save-character-setup" class="rounded-lg px-8 py-3 font-semibold text-lg">
                    Confirmar e Iniciar Aventura
                </button>
            </div>
        </section>
        <main id="main-content" class="flex-1 p-6 overflow-y-auto max-h-screen pb-20">
            <section id="game-screen" class="max-w-4xl mx-auto space-y-6">
                <div id="story-text" class="rounded-lg p-6 min-h-[180px] select-text">Texto da história apareceria
                    aqui...</div>
                <div id="choices" class="flex flex-col space-y-3"></div>

                <div id="battle-interface-container" class="hidden mt-4 p-4 rounded-lg shadow-xl">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div id="battle-party-pane" class="flex-grow space-y-3 md:w-3/5">
                            <div id="player-battle-display" class="p-3 rounded">
                                <div class="flex items-center mb-2">
                                    <img id="player-battle-portrait" src="https://via.placeholder.com/48?text=P"
                                        alt="Player" class="w-12 h-12 rounded-full mr-3 border-2 border-[#A1887F]">
                                    <div id="player-battle-name" class="text-xl font-semibold">Herói</div>
                                </div>
                                <div class="mb-1">
                                    <div class="flex justify-between text-xs text-slate-300"><span>HP</span><span
                                            id="player-battle-hp-text">100/100</span></div>
                                    <div class="w-full bg-slate-600 rounded-full h-3 overflow-hidden">
                                        <div id="player-battle-hp-bar"
                                            class="h-3 rounded-full transition-all duration-300 ease-out"
                                            style="width:100%"></div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="flex justify-between text-xs text-slate-300"><span>MP</span><span
                                            id="player-battle-mp-text">50/50</span></div>
                                    <div class="w-full bg-slate-600 rounded-full h-3 overflow-hidden">
                                        <div id="player-battle-mp-bar"
                                            class="h-3 rounded-full transition-all duration-300 ease-out"
                                            style="width:100%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-slate-300"><span>XP</span><span
                                            id="player-battle-xp-text">0/100</span></div>
                                    <div class="w-full bg-slate-600 rounded-full h-3 overflow-hidden">
                                        <div id="player-battle-xp-bar"
                                            class="h-3 rounded-full transition-all duration-300 ease-out"
                                            style="width:0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="summon-battle-display" class="p-3 rounded hidden">
                                <div class="flex items-center mb-2">
                                    <img id="summon-battle-portrait" src="https://via.placeholder.com/40?text=S"
                                        alt="Summon" class="w-10 h-10 rounded-full mr-3 border-2 border-[#8D6E63]">
                                    <div id="summon-battle-name" class="text-lg font-semibold">Sombra</div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-slate-300"><span>HP</span><span
                                            id="summon-battle-hp-text">50/50</span></div>
                                    <div class="w-full bg-slate-600 rounded-full h-2.5 overflow-hidden">
                                        <div id="summon-battle-hp-bar"
                                            class="h-2.5 rounded-full transition-all duration-300 ease-out"
                                            style="width:100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="enemy-battle-display" class="p-3 rounded md:w-2/5">
                            <div class="flex items-center mb-2">
                                <img id="enemy-battle-portrait" src="https://via.placeholder.com/48?text=E" alt="Enemy"
                                    class="w-12 h-12 rounded-full mr-3 border-2 border-[#A1887F]">
                                <div id="enemy-battle-name" class="text-xl font-semibold">Monstro</div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs text-slate-300"><span>HP</span><span
                                        id="enemy-battle-hp-text">120/120</span></div>
                                <div class="w-full bg-slate-600 rounded-full h-3 overflow-hidden">
                                    <div id="enemy-battle-hp-bar"
                                        class="h-3 rounded-full transition-all duration-300 ease-out"
                                        style="width:100%"></div>
                                </div>
                                <div id="enemy-battle-rank" class="text-xs mt-1">Rank E</div>
                            </div>
                        </div>
                    </div>

                    <div id="battle-main-commands" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button id="btn-battle-fight">Usar Arma</button>
                        <button id="btn-battle-skill">Habilidade</button>
                        <button id="btn-battle-item">Item</button>
                        <button id="btn-battle-escape">Fugir</button>
                    </div>
                    <div id="battle-submenu-choices" class="mt-3 flex flex-col space-y-2"></div>
                </div>
            </section>

            <section id="atributos-screen" class="max-w-4xl mx-auto space-y-6 hidden atributos-fundo">
                <div class="aetherLay">
                    <h2 class="text-3xl font-extrabold mb-6 text-center tracking-wider">VISÃO GERAL DO HERÓI</h2>
                    <div class="atributosLay">
                        <div class="bg-slate-700 rounded-xl shadow-xl p-6 mb-8">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                                <div class="bg-slate-600 p-3 rounded-lg shadow-md">
                                    <div class="text-sm uppercase tracking-wider text-slate-400">Nível</div>
                                    <div id="status-nivel" class="text-2xl font-bold">1</div>
                                </div>
                                <div class="bg-slate-600 p-3 rounded-lg shadow-md">
                                    <div class="text-sm uppercase tracking-wider text-slate-400">Rank</div>
                                    <div id="status-rank" class="text-2xl font-bold">E</div>
                                </div>
                                <div class="bg-slate-600 p-3 rounded-lg shadow-md">
                                    <div class="text-sm uppercase tracking-wider text-slate-400">Classe</div>
                                    <div id="status-classe" class="text-lg font-bold truncate" title="Nenhuma">Nenhuma
                                    </div>
                                </div>
                                <div class="bg-slate-600 p-3 rounded-lg shadow-md">
                                    <div class="text-sm uppercase tracking-wider text-slate-400">Moedas</div>
                                    <div id="status-moedas" class="text-2xl font-bold">0</div>
                                </div>
                            </div>
                            <div class="mb-6 bg-slate-600 p-4 rounded-lg shadow-md">
                                <div class="flex justify-between text-sm mb-1 items-center">
                                    <span class="font-semibold text-purple-300"><i
                                            class="fas fa-dice-d20 mr-2"></i>EXPERIÊNCIA</span>
                                    <span class="font-mono"><span id="status-xp">0</span> / <span
                                            id="status-xpProximo">100</span></span>
                                </div>
                                <div
                                    class="w-full bg-slate-800 rounded-full h-4 overflow-hidden border-2 border-slate-500 shadow-inner">
                                    <div id="status-xp-bar"
                                        class="h-full rounded-full transition-all duration-300 ease-out"
                                        style="width:0%"></div>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-slate-600 p-4 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-lg font-semibold text-red-400"><i
                                                class="fas fa-heart mr-2"></i>VIDA</span>
                                        <span id="status-vida" class="text-lg font-mono">0/0</span>
                                    </div>
                                    <div
                                        class="w-full bg-slate-800 rounded-full h-5 overflow-hidden border-2 border-slate-500 shadow-inner mb-2">
                                        <div id="status-vida-bar"
                                            class="h-full rounded-full transition-all duration-300 ease-out"
                                            style="width:100%"></div>
                                    </div>
                                    <div class="text-xs text-slate-400 text-right">Bônus de Vitalidade: +<span
                                            id="bonus-vida-max-val">0</span> HP</div>
                                </div>
                                <div class="bg-slate-600 p-4 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-lg font-semibold text-blue-400"><i
                                                class="fas fa-bolt mr-2"></i>MANA</span>
                                        <span id="status-mana" class="text-lg font-mono">0/0</span>
                                    </div>
                                    <div
                                        class="w-full bg-slate-800 rounded-full h-5 overflow-hidden border-2 border-slate-500 shadow-inner mb-2">
                                        <div id="status-mana-bar"
                                            class="h-full rounded-full transition-all duration-300 ease-out"
                                            style="width:100%"></div>
                                    </div>
                                    <div class="text-xs text-slate-400 text-right">Bônus de Inteligência: +<span
                                            id="bonus-mana-max-val">0</span> MP</div>
                                </div>
                            </div>
                            <h4 class="text-xl font-semibold mb-4 mt-8 text-center tracking-wide">ATRIBUTOS DE COMBATE
                            </h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm select-none">
                                <div class="bg-slate-600 p-3 rounded-lg text-center shadow-md">
                                    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Dano Físico</div>
                                    <div id="bonus-dano-fisico" class="text-xl font-bold">0</div>
                                </div>
                                <div class="bg-slate-600 p-3 rounded-lg text-center shadow-md">
                                    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Dano Mágico</div>
                                    <div id="bonus-dano-magico" class="text-xl font-bold">0</div>
                                </div>
                                <div class="bg-slate-600 p-3 rounded-lg text-center shadow-md">
                                    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Redução de Dano
                                    </div>
                                    <div class="text-xl font-bold"><span id="bonus-resistencia">0</span>%</div>
                                </div>
                                <div class="bg-slate-600 p-3 rounded-lg text-center shadow-md">
                                    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Esquiva / Fuga
                                    </div>
                                    <div>
                                        <span class="text-lg font-semibold" title="Chance de Esquiva"><i
                                                class="fas fa-shield-alt mr-1"></i><span
                                                id="bonus-esquiva">0</span>%</span> /
                                        <span class="text-lg font-semibold" title="Chance de Fuga"><i
                                                class="fas fa-shoe-prints mr-1"></i><span
                                                id="bonus-fuga">0</span>%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="mb-2 text-center">Você tem <span id="pontos-disponiveis"
                                class="font-semibold text-xl">0</span> pontos para distribuir.</p>
                        <div class="mb-4 text-center">
                            <h4 class="text-lg font-semibold mb-2">Definir Adição por Clique:</h4>
                            <div id="attribute-add-mode" class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button"
                                    class="px-4 py-2 text-sm font-medium border border-gray-600 rounded-l-lg hover:bg-[#543C32] focus:z-10 focus:ring-2 focus:ring-[#A1887F] bg-[#6D4C41] text-[#FFF8E1] attribute-mode-btn"
                                    data-amount="1">
                                    +1
                                </button>
                                <button type="button"
                                    class="px-4 py-2 text-sm font-medium border-t border-b border-gray-600 hover:bg-[#543C32] focus:z-10 focus:ring-2 focus:ring-[#A1887F] bg-[#6D4C41] text-[#FFF8E1] attribute-mode-btn"
                                    data-amount="5">
                                    +5
                                </button>
                                <button type="button"
                                    class="px-4 py-2 text-sm font-medium border-t border-b border-gray-600 hover:bg-[#543C32] focus:z-10 focus:ring-2 focus:ring-[#A1887F] bg-[#6D4C41] text-[#FFF8E1] attribute-mode-btn"
                                    data-amount="10">
                                    +10
                                </button>
                                <button type="button"
                                    class="px-4 py-2 text-sm font-medium border border-gray-600 rounded-r-lg hover:bg-[#543C32] focus:z-10 focus:ring-2 focus:ring-[#A1887F] bg-[#6D4C41] text-[#FFF8E1] attribute-mode-btn"
                                    data-amount="100">
                                    +100
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-slate-700 p-4 rounded-lg flex flex-col items-center space-y-2 shadow-lg">
                                <span class="font-semibold text-lg"><i
                                        class="fas fa-fist-raised mr-2 text-red-400"></i>Força</span>
                                <div class="flex items-center space-x-2">
                                    <button data-attr="forca" data-action="dec" class="btn-attr"><i
                                            class="fas fa-minus"></i></button>
                                    <span id="forca-val" class="w-12 text-center font-mono text-xl">0.0</span>
                                    <span id="forca-rank" class="w-8 text-center text-sm font-mono">(E)</span>
                                    <button data-attr="forca" data-action="inc" class="btn-attr"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-slate-700 p-4 rounded-lg flex flex-col items-center space-y-2 shadow-lg">
                                <span class="font-semibold text-lg"><i
                                        class="fas fa-running mr-2 text-green-400"></i>Agilidade</span>
                                <div class="flex items-center space-x-2">
                                    <button data-attr="agilidade" data-action="dec" class="btn-attr"><i
                                            class="fas fa-minus"></i></button>
                                    <span id="agilidade-val" class="w-12 text-center font-mono text-xl">0.0</span>
                                    <span id="agilidade-rank" class="w-8 text-center text-sm font-mono">(E)</span>
                                    <button data-attr="agilidade" data-action="inc" class="btn-attr"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-slate-700 p-4 rounded-lg flex flex-col items-center space-y-2 shadow-lg">
                                <span class="font-semibold text-lg"><i
                                        class="fas fa-brain mr-2 text-blue-400"></i>Inteligência</span>
                                <div class="flex items-center space-x-2">
                                    <button data-attr="inteligencia" data-action="dec" class="btn-attr"><i
                                            class="fas fa-minus"></i></button>
                                    <span id="inteligencia-val" class="w-12 text-center font-mono text-xl">0.0</span>
                                    <span id="inteligencia-rank" class="w-8 text-center text-sm font-mono">(E)</span>
                                    <button data-attr="inteligencia" data-action="inc" class="btn-attr"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-slate-700 p-4 rounded-lg flex flex-col items-center space-y-2 shadow-lg">
                                <span class="font-semibold text-lg"><i
                                        class="fas fa-shield-alt mr-2 text-gray-400"></i>Resistência</span>
                                <div class="flex items-center space-x-2">
                                    <button data-attr="resistencia" data-action="dec" class="btn-attr"><i
                                            class="fas fa-minus"></i></button>
                                    <span id="resistencia-val" class="w-12 text-center font-mono text-xl">0.0</span>
                                    <span id="resistencia-rank" class="w-8 text-center text-sm font-mono">(E)</span>
                                    <button data-attr="resistencia" data-action="inc" class="btn-attr"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-slate-700 p-4 rounded-lg flex flex-col items-center space-y-2 shadow-lg">
                                <span class="font-semibold text-lg"><i
                                        class="fas fa-heartbeat mr-2 text-pink-400"></i>Vitalidade</span>
                                <div class="flex items-center space-x-2">
                                    <button data-attr="vitalidade" data-action="dec" class="btn-attr"><i
                                            class="fas fa-minus"></i></button>
                                    <span id="vitalidade-val" class="w-12 text-center font-mono text-xl">0.0</span>
                                    <span id="vitalidade-rank" class="w-8 text-center text-sm font-mono">(E)</span>
                                    <button data-attr="vitalidade" data-action="inc" class="btn-attr"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-slate-700 p-4 rounded-lg flex flex-col items-center space-y-2 shadow-lg">
                                <span class="font-semibold text-lg"><i
                                        class="fas fa-eye mr-2 text-yellow-400"></i>Percepção</span>
                                <div class="flex items-center space-x-2">
                                    <button data-attr="percepcao" data-action="dec" class="btn-attr"><i
                                            class="fas fa-minus"></i></button>
                                    <span id="percepcao-val" class="w-12 text-center font-mono text-xl">0.0</span>
                                    <span id="percepcao-rank" class="w-8 text-center text-sm font-mono">(E)</span>
                                    <button data-attr="percepcao" data-action="inc" class="btn-attr"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-8">
                            <button id="btn-salvar-atributos" class="rounded-lg px-8 py-3 font-semibold text-lg">Salvar
                                Atributos e Voltar</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="skills-screen" class="max-w-4xl mx-auto space-y-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Habilidades de Classe</h2>
                <div id="classe-info-skills" class="mb-4 text-lg"></div>
                <div id="lista-skills" class="rounded-lg p-4 max-h-[450px] overflow-y-auto space-y-4">
                </div>
                <p class="mt-4 text-sm italic">Habilidades são desbloqueadas ao atingir certos níveis após sua classe
                    ser definida. Você pode equipar até 4 habilidades.</p>
            </section>

            <section id="inventario-screen" class="max-w-4xl mx-auto space-y-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Inventário</h2>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 bg-slate-700 rounded-lg p-4 max-h-[500px] overflow-y-auto">
                        <h3 class="font-semibold mb-3 text-lg border-b pb-2">Itens</h3>
                        <ul id="lista-itens" class="space-y-2 text-sm"></ul>
                    </div>
                    <div class="flex-1 bg-slate-700 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-lg border-b pb-2">Equipamentos</h3>
                        <div class="inventory-equip-layout">
                            <div
                                class="character-placeholder-container bg-slate-600 p-4 rounded-lg items-center justify-center flex">
                                <i class="fas fa-male fa-9x"></i>
                            </div>
                            <div class="equipment-grid-container">
                                <div class="equipment-grid">
                                    <div>
                                        <span class="equipment-slot-label">Capacete:</span>
                                        <div id="equip-capacete" class="equipment-slot-display">Nenhum</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Colar:</span>
                                        <div id="equip-colar" class="equipment-slot-display">Nenhum</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Peitoral:</span>
                                        <div id="equip-peitoral" class="equipment-slot-display">Nenhum</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Arma:</span>
                                        <div id="equip-arma" class="equipment-slot-display">Nenhuma</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Calça:</span>
                                        <div id="equip-calca" class="equipment-slot-display">Nenhuma</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Anel:</span>
                                        <div id="equip-anel" class="equipment-slot-display">Nenhum</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Botas:</span>
                                        <div id="equip-botas" class="equipment-slot-display">Nenhuma</div>
                                    </div>
                                    <div>
                                        <span class="equipment-slot-label">Escudo:</span>
                                        <div id="equip-escudo" class="equipment-slot-display">Nenhum</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="recipiente-sombras-container" class="mt-6 hidden">
                    <h3 class="text-xl font-bold mb-3 border-b pb-2">Recipiente de Sombras</h3>
                    <div class="bg-slate-700 rounded-lg p-4 max-h-[300px] overflow-y-auto">
                        <ul id="lista-sombras-recipiente" class="space-y-2 text-sm"></ul>
                    </div>
                </div>
            </section>

            <section id="mercador-screen" class="max-w-4xl mx-auto space-y-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Mercador</h2>
                <p class="mb-4">O mercador aparece a cada 5 níveis e oferece itens para venda.</p>
                <div class="bg-slate-700 rounded-lg p-4 max-h-[400px] overflow-y-auto">
                    <ul id="lista-mercador" class="space-y-4"></ul>
                </div>
                <button id="btn-comprar-mercador"
                    class="mt-4 rounded px-6 py-2 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>Comprar Selecionados</button>
            </section>
        </main>
    </div>

    <footer class="p-2 fixed bottom-0 left-0 right-0 z-50 shadow-lg hidden">
        <div class="max-w-4xl mx-auto flex items-center space-x-2">
            <input type="text" id="chat-command-input" class="flex-1 rounded px-3 py-1.5 text-sm"
                placeholder="Digite um comando...">
            <button id="btn-send-command" class="rounded px-4 py-1.5 text-sm font-semibold">Enviar</button>
        </div>
    </footer>

    <div id="boss-door-visual" class="hidden"> <img
            src="https://source.unsplash.com/random/800x600/?fantasy,gate,door,ancient,stone,dark" alt="Porta do Chefe">
    </div>
   <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyA9XI8CH63q8IIiXFlbUDhmW22A1EBN6FE",
        authDomain: "wrpg-acb0e.firebaseapp.com",
        projectId: "wrpg-acb0e",
        storageBucket: "wrpg-acb0e.appspot.com",
        messagingSenderId: "568658104266",
        appId: "1:568658104266:web:b661e534384993c3f7c933",
        measurementId: "G-DPHGLVYQ5S"
    };
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth(); // Usar 'var' para torná-las acessíveis globalmente ao próximo script
    var db = firebase.firestore();
    var currentFirebaseUser = null; // Declarar globalmente e inicializar
</script>

    <script>
        (() => {
            const commandFooter = document.querySelector('footer');
            const chatInputForFocus = document.getElementById('chat-command-input');

            document.addEventListener('keydown', function (event) {
                if (event.shiftKey && (event.key === 'W' || event.key === 'w')) {
                    event.preventDefault();

                    if (commandFooter) {
                        commandFooter.classList.toggle('hidden');
                        if (!commandFooter.classList.contains('hidden') && chatInputForFocus) {
                            chatInputForFocus.focus();
                        }
                    }
                }
            });

            document.getElementById("btn-inicio")?.addEventListener("click", abrirInicio);


            const RANKS = ["E", "D", "C", "B", "A", "S"];
            const RANK_MIN_TOTAL = { E: 0, D: 55, C: 140, B: 320, A: 460, S: 660 };
            const BASE_STATS = { forca: 0, agilidade: 0, inteligencia: 0, resistencia: 0, vitalidade: 0, percepcao: 0 };
            const BASE_HP = 100;
            const BASE_MANA = 10;
            const BASE_DANO_FISICO = 10;
            const BASE_DANO_MAGICO = 10;
            const BASE_RESISTENCIA = 0;
            const FUGIR_PCT_DECREMENTO = 0.07;
            const XP_BONUS_GLOBAL = 1.0;

            const MANA_GASTO_PCT = { E: 0.10, D: 0.15, C: 0.20, B: 0.25, A: 0.30, S: 0.35 };

            const PLAYER_CLASSES_LIST = ["Guerreiro", "Arqueiro", "Mago", "Assassino", "Paladino", "Bardo", "Necromante"];

            const ATTR_RANK_THRESHOLDS_MAP = [
                { rank: "S", min: 660 },
                { rank: "A", min: 460 },
                { rank: "B", min: 320 },
                { rank: "C", min: 140 },
                { rank: "D", min: 55 },
                { rank: "E", min: 0 }
            ];
            const INDIVIDUAL_ATTRIBUTE_RANK_THRESHOLDS = [
                { rank: "S", min: RANK_MIN_TOTAL.S / 6 }, 
                { rank: "A", min: RANK_MIN_TOTAL.A / 6 }, 
                { rank: "B", min: RANK_MIN_TOTAL.B / 6 }, 
                { rank: "C", min: RANK_MIN_TOTAL.C / 6 }, 
                { rank: "D", min: RANK_MIN_TOTAL.D / 6 }, 
                { rank: "E", min: RANK_MIN_TOTAL.E / 6 }  
            ];
            const TIPOS_DE_ARMAS = {
                "Nenhuma": { 
                    nomeDisplay: "Desarmado",
                    habilidades: [
                        { id: "desarmado_soco", nome: "Soco Certeiro", descricao: "Um soco rápido no alvo.", danoMultiplicador: 0.8, custoMana: 0, rank: "E" },
                        { id: "desarmado_chute", nome: "Chute Baixo", descricao: "Um chute nas pernas do inimigo.", danoMultiplicador: 1.0, custoMana: 0, rank: "E" },
                        { id: "desarmado_empurrao", nome: "Empurrão", descricao: "Tenta desequilibrar o alvo, causando pouco dano.", danoMultiplicador: 0.5, custoMana: 0, rank: "E" }
                    ]
                },
                "Espada": {
                    nomeDisplay: "Espada",
                    habilidades: [
                        { id: "espada_corte_rapido", nome: "Corte Rápido", descricao: "Um golpe veloz e preciso.", danoMultiplicador: 1.2, custoMana: 0, rank: "C" },
                        { id: "espada_estocada", nome: "Estocada Perfurante", descricao: "Uma estocada que busca um ponto vital.", danoMultiplicador: 1.4, custoManaPercent: 0.15, rank: "B" },
                        { id: "espada_lamina_giratoria", nome: "Lâmina Giratória", descricao: "Um ataque amplo que pode desorientar.", danoMultiplicador: 1.7, custoManaPercent: 0.35, rank: "A", efeito: { tipo: "debuff_precisao_inimigo", valor: 0.1, duracao: 2 } }
                    ]
                },
                "Clava": {
                    nomeDisplay: "Clava",
                    habilidades: [
                        { id: "clava_pancada", nome: "Pancada Pesada", descricao: "Um golpe lento, mas com força.", danoMultiplicador: 1.2, custoMana: 0, rank: "C" },
                        { id: "clava_esmagar_cranio", nome: "Esmagar Crânio", descricao: "Um golpe poderoso com chance de atordoar.", danoMultiplicador: 1.4, custoManaPercent: 0.15, rank: "B", efeito: { tipo: "chance_atordoar", chance: 0.25 } },
                        { id: "clava_impacto_brutal", nome: "Impacto Brutal", descricao: "Reduz a defesa do alvo com um golpe esmagador.", danoMultiplicador: 1.7, custoManaPercent: 0.35, rank: "A", efeito: { tipo: "debuff_defesa_inimigo", valor: 0.15, duracao: 3 } }
                    ]
                },
                "Lança": {
                    nomeDisplay: "Lança",
                    habilidades: [
                        { id: "lanca_investida", nome: "Investida de Lança", descricao: "Avança rapidamente para perfurar.", danoMultiplicador: 1.2, custoMana: 0, rank: "C" },
                        { id: "lanca_empalar", nome: "Empalar", descricao: "Causa dano e sangramento.", danoMultiplicador: 1.4, custoManaPercent: 0.15, rank: "B", efeito: { tipo: "dot", dano_por_turno: 5, duracao: 3, tipoDanoDot: "fisico" } },
                        { id: "lanca_varredura", nome: "Varredura Defensiva", descricao: "Um golpe para manter distância, chance de recuar.", danoMultiplicador: 1.7, custoManaPercent: 0.35, rank: "A" }
                    ]
                },
                "Arco": {
                    nomeDisplay: "Arco",
                    habilidades: [
                        { id: "arco_tiro_preciso", nome: "Tiro Preciso", descricao: "Um disparo focado no ponto fraco.", danoMultiplicador: 1.2, custoMana: 0, rank: "C" },
                        { id: "arco_flecha_farpada", nome: "Flecha Farpada", descricao: "Causa sangramento ao ser removida.", danoMultiplicador: 1.4, custoManaPercent: 0.15, rank: "B", efeito: { tipo: "dot", dano_por_turno: 4, duracao: 3, tipoDanoDot: "fisico" } },
                        { id: "arco_tiro_duplo", nome: "Tiro Duplo", descricao: "Dispara duas flechas em rápida sucessão.", danoMultiplicador: 1.7, custoManaPercent: 0.35, rank: "A", hits: 2 }
                    ]
                },
                "Besta": {
                    nomeDisplay: "Besta",
                    habilidades: [
                        { id: "besta_virote_pesado", nome: "Virote Pesado", descricao: "Um tiro potente que ignora parte da armadura.", danoMultiplicador: 1.2, custoMana: 0, rank: "C", efeito: { tipo: "ignora_defesa_parcial", valor: 0.1 } },
                        { id: "besta_tiro_incapacitante", nome: "Tiro Incapacitante", descricao: "Mira nas juntas para dificultar o movimento.", danoMultiplicador: 1.4, custoManaPercent: 0.15, rank: "B", efeito: { tipo: "debuff_agilidade_inimigo", valor: 0.1, duracao: 2 } },
                        { id: "besta_recarga_rapida", nome: "Recarga Rápida", descricao: "Prepara um tiro extra para o próximo turno ou causa dano extra imediato.", danoMultiplicador: 1.7, custoManaPercent: 0.35, rank: "A" }
                    ]
                },
                "Manoplas": {
                    nomeDisplay: "Manoplas",
                    habilidades: [
                        { id: "manoplas_soco_veloz", nome: "Soco Veloz", descricao: "Uma sequência rápida de golpes.", danoMultiplicador: 1.2, custoMana: 0, rank: "C", hits: 2 },
                        { id: "manoplas_quebra_guarda", nome: "Quebra-Guarda", descricao: "Um golpe forte para abrir a defesa inimiga.", danoMultiplicador: 1.4, custoManaPercent: 0.15, rank: "B", efeito: { tipo: "debuff_defesa_inimigo", valor: 0.1, duracao: 2 } },
                        { id: "manoplas_impacto_feroz", nome: "Impacto Feroz", descricao: "Concentra energia em um golpe devastador.", danoMultiplicador: 1.7, custoManaPercent: 0.35, rank: "A" }
                    ]
                },
                "Atomic": { 
                    nomeDisplay: "Atomic",
                    habilidades: [
                        {
                            id: "atomic_speed_slash",
                            nome: "Speed Slash",
                            descricao: "Um ataque padrão ultra-rápido que usa seu atributo de ataque e adiciona 600 de dano.", 
                            danoMultiplicador: 1.0, 
                            danoBase: 600,     
                            custoMana: 0,      
                            rank: "SSS",
                            tipoDano: "fisico"
                        },
                        { 
                            id: "atomic_time_stop",
                            nome: "Time Stop",
                            descricao: "Para o tempo, fazendo o inimigo não atacar por 2 turnos.",
                            custoManaPercent: 0.50,
                            rank: "SSS",
                            efeito: { tipo: "enemy_stun_turns", duracao: 2 }
                        },
                        {
                            id: "atomic_im_atomic",
                            nome: "I'm Atomic",
                            descricao: "Uma explosão de mana que tira 90% da vida ATUAL do monstro.",
                            custoManaPercent: 0.70,
                            rank: "SSS",
                            efeito: { tipo: "damage_percentage_current_hp", valor: 0.90 }
                        },
                        {
                            id: "atomic_devastation",
                            nome: "Devastation",
                            descricao: "Múltiplos cortes devastadores. 3 cortes de 300 de dano cada.",
                            danoBase: 300,
                            custoManaPercent: 0.40,
                            rank: "SSS",
                            hits: 3,
                            tipoDano: "fisico"
                        }
                    ]
                }
            };

            function getAtributoRank(valor) {
                for (const entry of INDIVIDUAL_ATTRIBUTE_RANK_THRESHOLDS) {
                    if (valor >= entry.min) {
                        return `(${entry.rank})`;
                    }
                }
                return "(E)"; 
            }

            const CLASSES_DATA = {
                "Guerreiro": {
                    nomeDisplay: "Guerreiro",
                    descricao: "Mestre do combate corpo a corpo, focado em dano físico e resistência.",
                    habilidades: [
                        { id: "g_golpe_poderoso", nome: "Golpe Poderoso", rank: "E", danoBase: 20, manaBase: 50, unlockLevel: 1, descricao: "Um golpe concentrado que causa dano físico adicional." },
                        { id: "g_grito_guerra", nome: "Grito de Guerra", rank: "D", manaBase: 20, unlockLevel: 20, efeito: { tipo: "buff_dano_fisico", valor: 0.25, duracao: 3 }, descricao: "Aumenta o dano físico em 25% por 3 turnos." },
                        { id: "g_furia_berserker", nome: "Fúria Berserker", rank: "C", danoBase: 45, manaBase: 100, unlockLevel: 50, descricao: "Um ataque selvagem que ignora parte da defesa inimiga (causa dano verdadeiro adicional)." }
                    ]
                },
                "Arqueiro": {
                    nomeDisplay: "Arqueiro",
                    descricao: "Perito em ataques à distância, utilizando precisão e agilidade.",
                    habilidades: [
                        { id: "a_flecha_precisa", nome: "Flecha Precisa", rank: "E", danoBase: 22, manaBase: 50, unlockLevel: 1, descricao: "Um disparo certeiro com alta chance de acerto." },
                        { id: "a_chuva_flechas", nome: "Chuva de Flechas", rank: "D", danoBase: 15, manaBase: 20, unlockLevel: 20, efeito: { tipo: "multi_hit", hits: 3 }, descricao: "Dispara múltiplas flechas em rápida sucessão (3 hits)." },
                        { id: "a_tiro_perfurante", nome: "Tiro Perfurante", rank: "C", danoBase: 50, manaBase: 100, unlockLevel: 50, descricao: "Um tiro poderoso que pode perfurar a armadura do inimigo." }
                    ]
                },
                "Mago": {
                    nomeDisplay: "Mago",
                    descricao: "Conjurador de energias arcanas, especializado em dano mágico elemental.",
                    habilidades: [
                        { id: "m_seta_gelo", nome: "Seta de Gelo", rank: "E", danoBase: 25, manaBase: 15, unlockLevel: 1, descricao: "Lança uma seta de gelo que causa dano e pode desacelerar (efeito não implementado).", tipoDano: "magico" },
                        { id: "m_bola_fogo", nome: "Bola de Fogo", rank: "D", danoBase: 40, manaBase: 30, unlockLevel: 20, descricao: "Conjura uma bola de fogo explosiva.", tipoDano: "magico" },
                        { id: "m_raio_arcano", nome: "Raio Arcano", rank: "C", danoBase: 60, manaBase: 45, unlockLevel: 50, descricao: "Dispara um raio de pura energia arcana.", tipoDano: "magico" }
                    ]
                },
                "Assassino": {
                    nomeDisplay: "Assassino",
                    descricao: "Especialista em furtividade e golpes críticos, eliminando alvos rapidamente.",
                    habilidades: [
                        { id: "as_ataque_furtivo", nome: "Ataque Furtivo", rank: "E", danoBase: 18, manaBase: 10, unlockLevel: 1, efeito: { tipo: "chance_critico_bonus", valor: 0.3 }, descricao: "Golpe rápido com chance aumentada de crítico." },
                        { id: "as_golpe_venenoso", nome: "Golpe Venenoso", rank: "D", danoBase: 25, manaBase: 25, unlockLevel: 20, efeito: { tipo: "dot", dano_por_turno: 5, duracao: 3 }, descricao: "Aplica veneno que causa dano por 3 turnos." },
                        { id: "as_execucao", nome: "Execução", rank: "C", danoBase: 30, manaBase: 40, unlockLevel: 50, efeito: { tipo: "dano_bonus_vida_baixa", multiplicador: 1.5, limiar_vida: 0.3 }, descricao: "Causa dano massivo a alvos com menos de 30% de vida." }
                    ]
                },
                "Paladino": {
                    nomeDisplay: "Paladino",
                    descricao: "Guerreiro sagrado que combina proeza marcial com poderes divinos de proteção e cura.",
                    habilidades: [
                        { id: "p_golpe_divino", nome: "Golpe Divino", rank: "E", danoBase: 18, manaBase: 15, unlockLevel: 1, descricao: "Um ataque imbuído com energia sagrada.", tipoDano: "magico" },
                        { id: "p_cura_leve", nome: "Cura Leve", rank: "D", manaBase: 30, unlockLevel: 20, efeito: { tipo: "cura", valor_base: 30, escala_inteligencia: 0.5 }, descricao: "Recupera uma pequena quantidade de vida." },
                        { id: "p_escudo_santo", nome: "Escudo Santo", rank: "C", manaBase: 40, unlockLevel: 50, efeito: { tipo: "buff_resistencia", valor: 0.2, duracao: 3 }, descricao: "Aumenta a resistência do jogador em 20% por 3 turnos." }
                    ]
                },
                "Bardo": {
                    nomeDisplay: "Bardo",
                    descricao: "Mestre da música e da persuasão, usando canções para inspirar aliados e debilitar inimigos.",
                    habilidades: [
                        { id: "b_cancao_magica", nome: "Canção Mágica", rank: "C", danoBase: 50, manaCostPercent: 0.20, unlockLevel: 1, tipoDano: "magico", descricao: "Causa 50 de dano mágico. Custa 20% da mana máxima." },
                        { id: "b_milagre_musica", nome: "Milagre de Música", rank: "S", manaCostPercent: 0.50, unlockLevel: 20, efeito: { tipo: "cura_percentual_vida_max", valor: 0.4 }, descricao: "Recupera 40% da vida máxima. Custa 50% da mana máxima." },
                        { id: "b_melodia_caos", nome: "Melodia do Caos", rank: "A", danoBase: 30, manaCostPercent: 0.30, unlockLevel: 50, efeito: { tipo: "dano_caotico" }, tipoDano: "magico", descricao: "Dano e efeitos colaterais variam drasticamente com a diferença de Rank entre você e o monstro." }
                    ]
                },
                "Necromante": {
                    nomeDisplay: "Necromante",
                    descricao: "Mestre das sombras e da morte, comanda os mortos-vivos e manipula energias profanas. Pode reviver da morte sacrificando sombras.",
                    habilidades: [
                        {
                            id: "n_extracao_sombras", nome: "Extração de Sombras", rank: "D", manaBase: 25, unlockLevel: 10,
                            descricao: "Após derrotar um inimigo (não-chefe), use esta habilidade para tentar extrair sua sombra, que será armazenada no Recipiente de Sombras, um rank abaixo do original. Requer que o último monstro derrotado seja elegível.",
                            efeito: { tipo: "extracao_sombra" }
                        },
                        {
                            id: "n_invocar_sombra", nome: "Invocar Sombra", rank: "E", manaBase: 10, unlockLevel: 10,
                            descricao: "Invoca uma sombra do seu Recipiente para lutar ao seu lado (substitui a ativa, se houver). Apenas uma sombra pode estar ativa. Sombras invocadas possuem atributos baseados em sua força original.",
                            efeito: { tipo: "invocar_sombra" }
                        },
                        {
                            id: "n_dominio_sombras", nome: "Domínio das Sombras", rank: "C", manaBase: 30, unlockLevel: 20,
                            descricao: "(ATIVA) Fortalece sua sombra ativa, aumentando seu dano em 50% por 3 turnos. Requer uma sombra ativa. Desbloqueada ao vencer o Desafio do Lorde da Morte (Domínio).",
                            efeito: { tipo: "buff_dano_sombra_ativa", valor: 0.5, duracao: 3 },
                            requerDesafio: "lorde_dominio"
                        },
                        {
                            id: "n_exercito_sombras", nome: "Exército de Sombras", rank: "A", manaCostPercent: 0.60, unlockLevel: 30,
                            descricao: "Invoca temporariamente TODAS as sombras do seu Recipiente. Elas desferem um ataque conjunto devastador e depois retornam ao recipiente. Causa dano massivo baseado no número e força das sombras. Desbloqueada ao vencer o Desafio do Lorde da Morte (Exército).",
                            efeito: { tipo: "ataque_exercito_sombras_completo" },
                            tipoDano: "magico",
                            requerDesafio: "lorde_exercito"
                        },
                        {
                            id: "ms_troca_sombras", nome: "[Monarca] Troca de Sombras", rank: "S", manaBase: 100, unlockLevel: 1,
                            descricao: "Troca de lugar com uma sombra distante, permitindo escapar de qualquer batalha ou masmorra instantaneamente para o início. Custa 100 Mana.",
                            efeito: { tipo: "escape_battle_dungeon" },
                            monarcaOnly: true 
                        },
                        {
                            id: "ms_acerto_critico", nome: "[Monarca] Acerto Crítico", rank: "A", manaBase: 75, unlockLevel: 1,
                            descricao: "Desfere um golpe poderoso. Se o seu Rank for maior que o do monstro, o dano é (Dano Físico + Dano Mágico) * 2. Caso contrário, causa Dano Físico normal. Custa 75 Mana.",
                            efeito: { tipo: "critical_strike_conditional" },
                            monarcaOnly: true
                        },
                        {
                            id: "ms_recuperacao_total", nome: "[Monarca] Recuperação Total", rank: "B", manaBase: 150, unlockLevel: 1,
                            descricao: "Canaliza o poder das sombras para recuperar totalmente a Vida e a Mana. Custa 150 Mana.",
                            efeito: { tipo: "full_restore" },
                            monarcaOnly: true
                        }
                    ]
                }
            };

            const ITEM_RANKS = ["E", "D", "C", "B", "A", "S", "SS", "SSS"];
            const ITEM_BASE_PRICE = { E: 10, D: 25, C: 50, B: 100, A: 200, S: 400, SS: 600, SSS: 1000 };
            const ITEM_ATRIBUTOS_POR_RANK = {
                E: { min: 5, max: 10 },
                D: { min: 12, max: 20 },
                C: { min: 22, max: 30 },
                B: { min: 32, max: 40 },
                A: { min: 60, max: 75 },
                S: { min: 100, max: 115 },
                SS: { min: 130, max: 150 },
                SSS: { min: 150, max: 200 },
            };

            const POTIONS = {
                drop: { id: "potion_drop", nome: "Poção Básica", curaVidaPct: 0.4, curaManaPct: 0.2, descricao: "Recupera 40% da vida e 20% da mana." },
                compra: { id: "potion_compra", nome: "Poção Avançada", curaVidaPct: 0.7, curaManaPct: 0.5, descricao: "Recupera 70% da vida e 50% da mana." }
            };
            const ARQUITETO_STATS = {
                nome: "Arquiteto",
                rank: "SSS",
                vidaMax: 9999,
                danoFisico: 9999,
                danoMagico: 9999,
                xpGanho: 10000,
                fugaPct: 0,
                isBoss: true,
                isArquiteto: true,
                habilidades: []
            };
            const MONARCH_BOSS_STATS = {
                "Gelo": { nomeDisplay: "Monarca do Gelo", vida: 10000, dano: 1000, rank: "S", xp: 15000, portrait: "https://source.unsplash.com/random/48x48/?ice,monster,king,evil" },
                "Gigante": { nomeDisplay: "Monarca Gigante", vida: 15000, dano: 700, rank: "S", xp: 18000, portrait: "https://source.unsplash.com/random/48x48/?giant,monster,king,evil" },
                "Metal": { nomeDisplay: "Monarca do Metal", vida: 11000, dano: 950, rank: "S", xp: 16000, portrait: "https://source.unsplash.com/random/48x48/?metal,monster,king,evil" },
                "Transfiguracao": { nomeDisplay: "Monarca da Transfiguração", vida: 5000, dano: 500, rank: "A", xp: 12000, portrait: "https://source.unsplash.com/random/48x48/?magic,monster,king,evil" },
                "Destruicao": { nomeDisplay: "Monarca da Destruição", vida: 17000, dano: 1500, rank: "SS", xp: 25000, portrait: "https://source.unsplash.com/random/48x48/?destruction,monster,king,evil" },
                "Insetos": { nomeDisplay: "Monarca dos Insetos", vida: 8000, dano: 766, rank: "S", xp: 14000, portrait: "https://source.unsplash.com/random/48x48/?insect,monster,king,evil" },
                "Bestas": { nomeDisplay: "Monarca das Bestas", vida: 10000, dano: 900, rank: "S", xp: 15000, portrait: "https://source.unsplash.com/random/48x48/?beast,monster,king,evil" },
                "Demonio": { nomeDisplay: "Monarca Demoníaco", vida: 10666, dano: 1066, rank: "SS", xp: 22000, portrait: "https://source.unsplash.com/random/48x48/?demon,monster,king,evil" }
            };
            const DUNGEON_CONFIG = {
                "E": { name: "Masmorra Esquecida", roomsMin: 4, roomsMax: 6, monsterRank: "D", bossRank: "C", bossBaseStats: { vidaMin: 580, vidaMax: 850, danoMin: 70, danoMax: 80, xpMin: 1200, xpMax: 1800 } },
                "D": { name: "Covil Profundo", roomsMin: 5, roomsMax: 7, monsterRank: "C", bossRank: "B", bossBaseStats: { vidaMin: 1050, vidaMax: 1700, danoMin: 105, danoMax: 165, xpMin: 3500, xpMax: 5000 }, arquitetoChance: 0.05 },
                "C": { name: "Cidadela Sombria", roomsMin: 6, roomsMax: 8, monsterRank: "B", bossRank: "A", bossBaseStats: { vidaMin: 1900, vidaMax: 2500, danoMin: 170, danoMax: 205, xpMin: 7000, xpMax: 10000 } },
                "B": { name: "Fortaleza Dracônica", roomsMin: 7, roomsMax: 9, monsterRank: "A", bossRank: "S", bossBaseStats: { vidaMin: 2600, vidaMax: 4000, danoMin: 255, danoMax: 360, xpMin: 14000, xpMax: 25000 }, lordeDaMorteChance: 0.75 },
                "A": { name: "Abismo Infernal", roomsMin: 8, roomsMax: 10, monsterRank: "S", bossRank: "SS", bossBaseStats: { vidaMin: 4800, vidaMax: 7000, danoMin: 500, danoMax: 600, xpMin: 20000, xpMax: 35000 }, lordeDaMorteChance: 1 }, // Boss can now be SS
                "S": { name: "Domínio Celestial Despedaçado", roomsMin: 9, roomsMax: 12, monsterRank: "SS", bossRank: "SSS", bossBaseStats: { vidaMin: 8000, vidaMax: 11000, danoMin: 700, danoMax: 850, xpMin: 40000, xpMax: 60000 }, lordeDaMorteChance: 1.5 } // Monsters and Boss can now be SS/SSS
            };

            function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
            function randomChoice(arr) { return arr[randomInt(0, arr.length - 1)]; }
            function clamp(num, min, max) { return Math.min(Math.max(num, min), max); }
            function rankToIndex(rank) { return RANKS.indexOf(rank); }
            function indexToRank(index) { return RANKS[clamp(index, 0, RANKS.length - 1)]; }

            let game = {
                player: {
                    nome: "Herói",
                    classe: null,
                    nivel: 1,
                    xp: 0,
                    xpProximoNivel: 100,
                    rank: "E",
                    atributos: { ...BASE_STATS },
                    pontosDistribuir: 0,
                    attributeAddAmount: 1, // Padrão: adicionar 1 ponto por clique
                    vidaMax: BASE_HP,
                    vidaAtual: BASE_HP,
                    manaMax: BASE_MANA,
                    manaAtual: BASE_MANA,
                    danoFisicoBase: BASE_DANO_FISICO,
                    danoMagicoBase: BASE_DANO_MAGICO,
                    resistenciaPct: BASE_RESISTENCIA,
                    refinoMagicoPct: 0,
                    percepcaoPct: 0,
                    agilidadePctFuga: 0,
                    forcaPctDano: 0,
                    isMarcado: false,
                    isMonarcaDasSombras: false,
                    inventario: [],
                    equipamento: { capacete: null, peitoral: null, calca: null, botas: null, arma: null, escudo: null, anel: null, colar: null },
                    moedas: 100,
                    rodadas: 0,
                    xpBonus: XP_BONUS_GLOBAL,
                    magiasAdquiridas: [],
                    magiasEquipadas: [],
                    currentArea: "E",
                    currentDanoFisico: BASE_DANO_FISICO,
                    currentReducaoDano: BASE_RESISTENCIA,
                    currentChanceFuga: 0,
                    currentChanceEsquiva: 0,
                    currentDanoMagico: BASE_DANO_MAGICO,
                    activeBuffs: [],
                    recipienteSombras: [],
                    sombraAtiva: null,
                    maxActiveShadows: 1,
                    recipienteCapacity: 10,
                    lastDefeatedMonsterInfo: null,
                    metLordeDaMorte: false,
                    vitalidadeBonusVida: 0,
                    inteligenciaBonusMana: 0,
                },
                mundo: "Arkham",
                estado: "inicio",
                monstroAtual: null,
                batalha: {
                    emBatalha: false, monstro: null, turnoJogador: true, danoRecebido: 0, isBossBattle: false, isDesafioClasse: false,
                    skillEmDesafioId: null,
                    desafioBossOriginalStats: null, tipoDesafioLorde: null, jogadorAgiuNoTurno: false
                },
                mercador: { itens: [], selecionados: new Set() },
                dungeon: { active: false, name: "", typeRank: "E", totalRooms: 0, currentRoom: 0, monsterRankForRooms: "D", bossRankForDungeon: "C", bossDefeated: false, isBossRoomConfirmation: false }
            };

            const MONSTRO_NOMES = {
                E: ["Goblin Fraco", "Rato Gigante", "Lobo Selvagem", "Esqueleto Fraco", "Aranha Venenosa"],
                D: ["Goblin Guerreiro", "Lobo Alfa", "Esqueleto Guerreiro", "Aranha Gigante", "Zumbi"],
                C: ["Orc Brutal", "Troll", "Mago Sombrio", "Lobo Fantasma", "Zumbi Corrompido", "Guardião da Masmorra"],
                B: ["Orc Chefe", "Troll Ancião", "Mago Negro", "Dragão Jovem", "Zumbi Rei", "Grão-Guardião"],
                A: ["Dragão Adulto", "Lorde Orc", "Mago Supremo", "Demônio Menor", "Zumbi Lendário", "Protetor Ancestral"],
                S: ["Dragão Ancião", "Lorde Demônio", "Mago Lendário", "Deus Caído", "Zumbi Imortal", "Avatar da Destruição"],
                SS: ["Cavaleiro Abissal", "Beemote Corrompido", "Arquimago Lich", "Serpente Titânica", "Anjo Caído Vingativo"], // << NOVO
                SSS: ["Avatar Primordial", "Devorador de Mundos", "Ancião Cósmico", "Arauto do Vazio", "Deidade Esquecida"], // << NOVO
                LORDE_DA_MORTE: ["Lorde da Morte"]
            };

            function getBarPercentage(current, max) {
                if (max <= 0) return "0%";
                return clamp((current / max) * 100, 0, 100).toFixed(2) + "%";
            }

            function updatePlayerBattleDisplay() {
                const player = game.player;
                document.getElementById("player-battle-name").textContent = player.nome;
                document.getElementById("player-battle-hp-text").textContent = `${player.vidaAtual} / ${player.vidaMax}`;
                document.getElementById("player-battle-hp-bar").style.width = getBarPercentage(player.vidaAtual, player.vidaMax);
                document.getElementById("player-battle-mp-text").textContent = `${player.manaAtual} / ${player.manaMax}`;
                document.getElementById("player-battle-mp-bar").style.width = getBarPercentage(player.manaAtual, player.manaMax);
                document.getElementById("player-battle-xp-text").textContent = `${player.xp} / ${player.xpProximoNivel}`;
                document.getElementById("player-battle-xp-bar").style.width = getBarPercentage(player.xp, player.xpProximoNivel);
            }

            function updateEnemyBattleDisplay(monstro) {
                if (!monstro) return;
                document.getElementById("enemy-battle-name").textContent = monstro.nome;
                document.getElementById("enemy-battle-hp-text").textContent = `${monstro.vidaAtual} / ${monstro.vidaMax}`;
                document.getElementById("enemy-battle-hp-bar").style.width = getBarPercentage(monstro.vidaAtual, monstro.vidaMax);
                document.getElementById("enemy-battle-rank").textContent = `Rank ${monstro.rank}`;
            }

            function updateSummonBattleDisplay() {
                const summonDisplay = document.getElementById("summon-battle-display");
                if (game.player.sombraAtiva && game.player.sombraAtiva.statsAtuais) {
                    const sombra = game.player.sombraAtiva;
                    document.getElementById("summon-battle-name").textContent = sombra.nomeSombra;
                    document.getElementById("summon-battle-hp-text").textContent = `${sombra.statsAtuais.vidaAtual} / ${sombra.statsAtuais.vidaMax}`;
                    document.getElementById("summon-battle-hp-bar").style.width = getBarPercentage(sombra.statsAtuais.vidaAtual, sombra.statsAtuais.vidaMax);
                    summonDisplay.classList.remove("hidden");
                } else {
                    summonDisplay.classList.add("hidden");
                }
            }

            function showBattleInterface(show) {
                const battleContainer = document.getElementById("battle-interface-container");
                const choicesDiv = document.getElementById("choices");
                const storyText = document.getElementById("story-text");

                if (show) {
                    battleContainer.classList.remove("hidden");
                    choicesDiv.classList.add("hidden");
                    storyText.classList.remove("min-h-[180px]", "text-lg", "leading-relaxed");
                    storyText.classList.add("min-h-[100px]", "max-h-[200px]", "overflow-y-auto", "text-sm", "leading-normal");
                    updatePlayerBattleDisplay();
                    updateEnemyBattleDisplay(game.batalha.monstro);
                    updateSummonBattleDisplay();
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                } else {
                    battleContainer.classList.add("hidden");
                    choicesDiv.classList.remove("hidden");
                    storyText.classList.add("min-h-[180px]", "text-lg", "leading-relaxed");
                    storyText.classList.remove("min-h-[100px]", "max-h-[200px]", "overflow-y-auto", "text-sm", "leading-normal");
                }
            }


            function gerarMonstro(rank, isLordeDaMorte = false) {
                const customMonsterStats = {};

                if (isLordeDaMorte) {
                    return {
                        nome: "Lorde da Morte", rank: "S", vidaMax: 4000, vidaAtual: 4000,
                        danoFisico: 200, danoMagico: 150, xpGanho: 5000,
                        fugaPct: 0,
                        isBoss: true, isLordeDaMorte: true
                    };
                }

                if (game.estado === "inicio" &&
                    game.player.currentArea === "E" &&
                    rank === "E" &&
                    !game.dungeon.active) {
                    const nomesAreaE = MONSTRO_NOMES["E"] || ["Criatura Frágil da Área E"];
                    const nomeMonstroEspecial = randomChoice(nomesAreaE);
                    return {
                        nome: `${nomeMonstroEspecial} (Exploração)`, rank: "E",
                        vidaMax: 120, vidaAtual: 120,
                        danoFisico: 15, danoMagico: Math.floor(15 * 0.3),
                        xpGanho: 10,
                        fugaPct: 0.67, isBoss: false, isLordeDaMorte: false
                    };
                }

                const rankIndex = RANKS.indexOf(rank);
                const nomesDisponiveis = MONSTRO_NOMES[rank] || [`Monstro Desconhecido Rank ${rank}`];
                const nomeMonstro = randomChoice(nomesDisponiveis);

                let vidaBase, danoBaseFisico;

                if (game.dungeon.active && customMonsterStats[rank]) {
                    vidaBase = customMonsterStats[rank].vida || Math.floor(50 * Math.pow(1.9, rankIndex) + randomInt(0, 20 * Math.pow(1.6, rankIndex)));
                    danoBaseFisico = customMonsterStats[rank].dano || Math.floor(8 * Math.pow(1.85, rankIndex));
                } else {
                    vidaBase = Math.floor(50 * Math.pow(1.9, rankIndex) + randomInt(0, 20 * Math.pow(1.6, rankIndex)));
                    danoBaseFisico = Math.floor(8 * Math.pow(1.85, rankIndex));
                }

                const vidaMax = vidaBase + randomInt(0, Math.floor(vidaBase * 0.15));
                const danoFisico = danoBaseFisico + randomInt(0, Math.floor(danoBaseFisico * 0.1));
                const danoMagico = Math.max(0, Math.floor(danoFisico * 0.5));

                let xpGanho;
                switch (rank) {
                    case "E": xpGanho = 10; break;
                    case "D": xpGanho = 24; break;
                    case "C": xpGanho = 99; break;
                    case "B": xpGanho = 258; break;
                    case "A": xpGanho = 1083; break;
                    case "S": xpGanho = 10672; break;
                    case "SS": xpGanho = 37350; break;
                    case "SSS": xpGanho = 130700; break;
                    default: xpGanho = 10 * Math.pow(3, rankIndex < 0 ? 0 : rankIndex);
                }

                if (rank === "E" && !game.dungeon.active && !isLordeDaMorte) {
                    xpGanho = 10;
                }

                const fugaPctMonstro = clamp(0.67 - 0.07 * rankIndex, 0.05, 0.67);

                return {
                    nome: nomeMonstro, rank, vidaMax, vidaAtual: vidaMax,
                    danoFisico, danoMagico, xpGanho,
                    fugaPct: fugaPctMonstro, isBoss: false, isLordeDaMorte: false
                };
            }
            function gerarMonstroMasmorra(monsterRank) {
                const monstro = gerarMonstro(monsterRank);
                monstro.danoFisico = Math.floor(monstro.danoFisico * 1.40);
                monstro.danoMagico = Math.floor(monstro.danoMagico * 1.40);
                monstro.xpGanho = Math.floor(monstro.xpGanho * 1.10);
                return monstro;
            }
            function gerarMonarcaAleatorio() {
                const monarchKeys = Object.keys(MONARCH_BOSS_STATS);
                if (monarchKeys.length === 0) return null;
                const chosenKey = randomChoice(monarchKeys);
                const monarchData = MONARCH_BOSS_STATS[chosenKey];

                return {
                    nome: monarchData.nomeDisplay,
                    rank: monarchData.rank,
                    vidaMax: monarchData.vida,
                    vidaAtual: monarchData.vida,
                    danoFisico: monarchData.dano,
                    danoMagico: Math.floor(monarchData.dano * 0.3),
                    xpGanho: monarchData.xp,
                    fugaPct: 0,
                    isBoss: true,
                    isMonarchBoss: true,
                    portrait: monarchData.portrait || `https://via.placeholder.com/48?text=${chosenKey.substring(0, 1)}M`
                };
            }
            function gerarBossMasmorra(dungeonTypeRank, actualBossRank) {
                const dungeonConfig = DUNGEON_CONFIG[dungeonTypeRank];

                if (dungeonTypeRank === "D" && dungeonConfig.arquitetoChance && Math.random() < dungeonConfig.arquitetoChance) {
                    if (!game.player.isMarcado) {
                        game.batalha.pendingArquitetoEncounter = true;
                        return { ...ARQUITETO_STATS, vidaAtual: ARQUITETO_STATS.vidaMax };
                    }
                }

                if (dungeonConfig && dungeonConfig.lordeDaMorteChance &&
                    !game.player.classe &&
                    game.player.nivel >= 20 && rankToIndex(game.player.rank) >= rankToIndex("B") &&
                    !game.player.metLordeDaMorte &&
                    Math.random() < dungeonConfig.lordeDaMorteChance) {
                    game.player.metLordeDaMorte = true;
                    return gerarMonstro(null, true);
                }

                const config = DUNGEON_CONFIG[dungeonTypeRank];
                if (!config || !config.bossBaseStats) {
                    console.error(`Configuração de bossBaseStats não encontrada para dungeon rank ${dungeonTypeRank}`);
                    const fallbackBossRank = actualBossRank || "C";
                    const fallbackStats = DUNGEON_CONFIG["E"].bossBaseStats;
                    const fbMon = gerarMonstro(fallbackBossRank);
                    return {
                        ...fbMon,
                        nome: `Boss ${fallbackBossRank} Desconhecido`,
                        isBoss: true,
                        vidaMax: fallbackStats.vidaMin,
                        vidaAtual: fallbackStats.vidaMin,
                        danoFisico: fallbackStats.danoMin,
                        danoMagico: Math.floor(fallbackStats.danoMin * 0.3),
                        xpGanho: calculateXpForNextNLevels(game.player.nivel, game.player.xpProximoNivel, 3)
                    };
                }
                const baseStats = config.bossBaseStats;
                const nome = randomChoice(MONSTRO_NOMES[actualBossRank] || [`Boss ${actualBossRank}`]);
                const vidaMax = randomInt(baseStats.vidaMin, baseStats.vidaMax);

                const baseDanoFisicoRolled = randomInt(baseStats.danoMin, baseStats.danoMax);
                const baseDanoMagicoRolled = Math.floor(baseDanoFisicoRolled * randomInt(30, 70) / 100);

                let strengthMultiplier = 1.20;
                if (rankToIndex(actualBossRank) >= rankToIndex("B")) {
                    strengthMultiplier = 1.50;
                }

                const danoFisico = Math.floor(baseDanoFisicoRolled * strengthMultiplier);
                const danoMagico = Math.floor(baseDanoMagicoRolled * strengthMultiplier);

                let xpParaBoss = calculateXpForNextNLevels(game.player.nivel, game.player.xpProximoNivel, 3);
                xpParaBoss = Math.floor(xpParaBoss * randomInt(100, 110) / 100);

                return {
                    nome: `${nome} (Boss da Masmorra)`,
                    rank: actualBossRank,
                    vidaMax,
                    vidaAtual: vidaMax,
                    danoFisico,
                    danoMagico,
                    xpGanho: xpParaBoss,
                    fugaPct: 0,
                    isBoss: true
                };
            }
            const ITEM_PREFIXOS = {
                E: ["Simples", "Rústico", "Comum", "Velho", "Frágil"],
                D: ["Robusto", "Resistente", "Forte", "Ágil", "Místico"],
                C: ["Encantado", "Sagrado", "Veloz", "Poderoso", "Duradouro"],
                B: ["Épico", "Lendário", "Mágico", "Imponente", "Vibrante"],
                A: ["Divino", "Celestial", "Supremo", "Inquebrável", "Radiante"],
                S: ["Ancestral", "Mítico", "Eterno", "Soberano", "Infinito"],
                // ADICIONE AS LINHAS ABAIXO:
                SS: ["Artefato", "Titânico", "Corrompido", "Santificado", "Abissal", "Espectral"],
                SSS: ["Primordial", "Cósmico", "Absoluto", "Divindade Menor", "Inconcebível", "Paradoxal"]
            };

            const SLOT_EQUIPAVEL = ["Capacete", "Peitoral", "Calça", "Botas", "Arma", "Escudo", "Anel", "Colar"];
            const SUBTIPOS_ARMA = Object.keys(TIPOS_DE_ARMAS).filter(tipo => tipo !== "Nenhuma");
            const ATOMIC_WEAPON_DATA = TIPOS_DE_ARMAS["Atomic"];

            function gerarItem(rankDoItemASerGerado, monstroPermiteDropAtomic) {
                const tipoBase = Math.random() < 0.8 ? randomChoice(SLOT_EQUIPAVEL) : "Poção";
                let tipoFinal = tipoBase;
                let subTipoArma = null;

                if (tipoBase === "Arma" && rankDoItemASerGerado === "SSS" && monstroPermiteDropAtomic) {
                    if (Math.random() < 0.10) {
                        return {
                            id: crypto.randomUUID(),
                            nome: "Atomic",
                            tipo: "Arma",
                            subTipoArma: "Atomic",
                            rank: "SSS",
                            efeitos: {
                                forca: 1000, agilidade: 1000, inteligencia: 1000,
                                resistencia: 1000, vitalidade: 1000, percepcao: 1000,
                                refinoMagico: 1000
                            },
                            preco: 99999999999,
                            isPotion: false,
                            isUnique: true
                        };
                    } else {
                        const availableSubtypes = SUBTIPOS_ARMA.filter(s => s !== "Atomic");
                        if (availableSubtypes.length > 0) {
                            subTipoArma = randomChoice(availableSubtypes);
                        }
                    }
                } else if (tipoBase === "Arma") {
                    const availableSubtypes = SUBTIPOS_ARMA.filter(s => s !== "Atomic");
                    if (availableSubtypes.length > 0) {
                        subTipoArma = randomChoice(availableSubtypes);
                    }
                }

                if (tipoBase === "Poção") {
                    const tipoPocao = Math.random() < 0.5 ? "drop" : "compra";
                    const pocaoBase = POTIONS[tipoPocao];
                    return {
                        id: pocaoBase.id,
                        nome: pocaoBase.nome,
                        tipo: "Poção",
                        rank: rankDoItemASerGerado,
                        efeitos: {},
                        preco: tipoPocao === "compra" ? 50 : (ITEM_BASE_PRICE[rankDoItemASerGerado] || 10),
                        curaVidaPct: pocaoBase.curaVidaPct,
                        curaManaPct: pocaoBase.curaManaPct,
                        descricao: pocaoBase.descricao,
                        isPotion: true
                    };
                }

                const prefixo = randomChoice(ITEM_PREFIXOS[rankDoItemASerGerado]);
                let nomeItem;
                if (subTipoArma) {
                    nomeItem = `${prefixo} ${TIPOS_DE_ARMAS[subTipoArma].nomeDisplay}`;
                } else if (tipoFinal === "Arma" && !subTipoArma) {
                    nomeItem = `${prefixo} Lâmina Poderosa`;
                } else {
                    nomeItem = `${prefixo} ${tipoFinal}`;
                }

                const efeitos = {};
                const { min, max } = ITEM_ATRIBUTOS_POR_RANK[rankDoItemASerGerado];
                const pontos = randomInt(min, max);

                switch (tipoFinal) {
                    case "Capacete": efeitos.percepcao = pontos; efeitos.resistencia = randomInt(Math.floor(min / 3), Math.floor(max / 3)); break;
                    case "Peitoral": efeitos.resistencia = pontos; efeitos.vitalidade = randomInt(Math.floor(min / 2), Math.floor(max / 2)); break;
                    case "Calça": efeitos.vitalidade = pontos; efeitos.agilidade = randomInt(Math.floor(min / 3), Math.floor(max / 3)); break;
                    case "Botas": efeitos.agilidade = pontos; break;
                    case "Arma":
                        efeitos.forca = pontos;
                        if (subTipoArma === "Arco" || subTipoArma === "Besta") efeitos.percepcao = Math.floor(pontos / 3);
                        if (subTipoArma === "Manoplas") efeitos.agilidade = Math.floor(pontos / 4);
                        break;
                    case "Escudo": efeitos.resistencia = pontos + randomInt(1, 3); break;
                    case "Anel": efeitos.inteligencia = pontos; break;
                    case "Colar": efeitos.agilidade = randomInt(Math.floor(min / 2), Math.floor(max / 2)); efeitos.percepcao = randomInt(Math.floor(min / 2), Math.floor(max / 2)); break;
                }

                const preco = ITEM_BASE_PRICE[rankDoItemASerGerado] * (1 + Math.random() * 0.5 + rankToIndex(rankDoItemASerGerado) * 0.1);

                return {
                    id: crypto.randomUUID(),
                    nome: nomeItem,
                    tipo: tipoFinal,
                    subTipoArma: subTipoArma,
                    rank: rankDoItemASerGerado,
                    efeitos,
                    preco: Math.floor(preco),
                    isPotion: false
                };
            }

            function itemsAreIdentical(item1, item2) {
                if (item1.isPotion && item2.isPotion) return item1.id === item2.id;
                if (!item1.isPotion && !item2.isPotion) {
                    if (item1.nome !== item2.nome || item1.tipo !== item2.tipo || item1.rank !== item2.rank) return false;
                    const effects1 = item1.efeitos || {}; const effects2 = item2.efeitos || {};
                    const keys1 = Object.keys(effects1).sort(); const keys2 = Object.keys(effects2).sort();
                    if (keys1.length !== keys2.length) return false;
                    for (let i = 0; i < keys1.length; i++) {
                        if (keys1[i] !== keys2[i] || effects1[keys1[i]] !== effects2[keys2[i]]) return false;
                    }
                    return true;
                }
                return false;
            }

            function addItemToInventory(itemToAdd) {
                let foundStack = false;
                for (let invItem of game.player.inventario) {
                    if (itemsAreIdentical(invItem, itemToAdd)) {
                        invItem.quantity = (invItem.quantity || 1) + 1; foundStack = true; break;
                    }
                }
                if (!foundStack) game.player.inventario.push({ ...itemToAdd, quantity: 1 });
            }

            function atualizarRank() {
                const total = Object.values(game.player.atributos).reduce((a, b) => a + b, 0);
                let novoRank = "E";
                for (let i = RANKS.length - 1; i >= 0; i--) {
                    if (total >= RANK_MIN_TOTAL[RANKS[i]]) { novoRank = RANKS[i]; break; }
                }
                if (novoRank !== game.player.rank) {
                    game.player.rank = novoRank;
                }
            }

            function atualizarAtributosDerivados() {
                const a = game.player.atributos;
                let tempForca = a.forca, tempAgilidade = a.agilidade, tempInteligencia = a.inteligencia,
                    tempResistencia = a.resistencia, tempVitalidade = a.vitalidade, tempPercepcao = a.percepcao;

                for (const equipSlot in game.player.equipamento) {
                    const equip = game.player.equipamento[equipSlot];
                    if (equip && equip.efeitos) {
                        for (const [attr, val] of Object.entries(equip.efeitos)) {
                            switch (attr) {
                                case 'forca': tempForca += val; break; case 'agilidade': tempAgilidade += val; break;
                                case 'inteligencia': tempInteligencia += val; break; case 'resistencia': tempResistencia += val; break;
                                case 'vitalidade': tempVitalidade += val; break; case 'percepcao': tempPercepcao += val; break;
                            }
                        }
                    }
                }

                const vitalidadeBonusVida = tempVitalidade * 5;
                game.player.vidaMax = Math.floor(BASE_HP + vitalidadeBonusVida);
                game.player.vidaAtual = Math.min(game.player.vidaAtual, game.player.vidaMax);
                game.player.vitalidadeBonusVida = vitalidadeBonusVida;
                game.player.maxActiveShadows = 1 + Math.min(4, Math.floor(tempInteligencia / 15));
                game.player.recipienteCapacity = 10 + (Math.floor(tempInteligencia / 15) * 5);
                const inteligenciaBonusMana = tempInteligencia * 10;
                game.player.manaMax = Math.floor(BASE_MANA + inteligenciaBonusMana);
                game.player.manaAtual = Math.min(game.player.manaAtual, game.player.manaMax);
                game.player.inteligenciaBonusMana = inteligenciaBonusMana;

                const forcaBonusDano = tempForca * 2.0; // Changed from 0.5 to 2.0
                game.player.currentDanoFisico = BASE_DANO_FISICO + forcaBonusDano;

                const resistenciaBonusPct = tempResistencia * 0.1;
                game.player.currentReducaoDano = resistenciaBonusPct;
                game.player.resistenciaPct = resistenciaBonusPct / 100;

                const agilidadeBonusFuga = tempAgilidade * 0.0005;
                game.player.currentChanceFuga = agilidadeBonusFuga * 100;
                game.player.agilidadePctFuga = agilidadeBonusFuga;

                const percepcaoBonusEsquiva = tempPercepcao * 0.0005;
                game.player.currentChanceEsquiva = percepcaoBonusEsquiva * 100;
                game.player.percepcaoPct = percepcaoBonusEsquiva;

                const inteligenciaBonusDanoMagico = tempInteligencia * 2.0;
                game.player.currentDanoMagico = BASE_DANO_MAGICO + inteligenciaBonusDanoMagico;

                aplicarEfeitosEquipamento();
                aplicarBuffs();
            }

            function aplicarBuffs() {
                const gritoBuff = game.player.activeBuffs.find(b => b.id === "g_grito_guerra");
                if (gritoBuff) {
                    game.player.currentDanoFisico *= (1 + gritoBuff.valor);
                }
                const escudoSantoBuff = game.player.activeBuffs.find(b => b.id === "p_escudo_santo");
                if (escudoSantoBuff) {
                    game.player.currentReducaoDano += (escudoSantoBuff.valor * 100);
                    game.player.resistenciaPct = game.player.currentReducaoDano / 100;
                }
                const dominioBuff = game.player.activeBuffs.find(b => b.id === "n_dominio_sombras");
                if (dominioBuff && game.player.sombraAtiva && game.player.sombraAtiva.statsAtuais) {
                    game.player.sombraAtiva.statsAtuais.danoBase = Math.floor(game.player.sombraAtiva.statsAtuais.danoBase * (1 + dominioBuff.valor));
                }
            }

            function decrementarBuffs() {
                if (!game.batalha.emBatalha && !(game.dungeon.active && !game.batalha.monstro)) return;
                let buffsChanged = false;
                game.player.activeBuffs = game.player.activeBuffs.filter(buff => {
                    buff.duracao--;
                    if (buff.duracao <= 0) {
                        mostrarMensagem(`O efeito de <span class="font-bold text-amber-400">${buff.nomeSkill || 'buff'}</span> terminou.`);
                        buffsChanged = true;
                        return false;
                    }
                    return true;
                });
                if (buffsChanged) {
                    atualizarAtributosDerivados();
                    atualizarStatusAtributos();
                }
            }

            function calcularDanoFisico() { return Math.floor(game.player.currentDanoFisico); }
            function calcularDanoMagico(skill) { return Math.floor((skill.danoBase || 0) + game.player.currentDanoMagico); }
            function calcularDanoRecebido(dano) { return Math.max(1, Math.floor(dano * (1 - game.player.resistenciaPct))); }

            function calcularChanceFuga(monstro) {
                if (monstro.isBoss) return 0;
                const rankIndex = rankToIndex(monstro.rank);
                const baseFuga = clamp(0.67 - (FUGIR_PCT_DECREMENTO * rankIndex), 0.05, 0.67);
                return clamp(baseFuga + game.player.agilidadePctFuga, 0, 1);
            }
            function calcularGastoManaParaBoss(skill, boss) {
                let custoBase;
                if (skill.manaCostPercent !== undefined) {
                    custoBase = boss.manaMax * skill.manaCostPercent;
                } else if (skill.manaBase !== undefined) {
                    custoBase = skill.manaBase;
                } else if (skill.custoMana !== undefined) {
                    custoBase = skill.custoMana;
                } else {
                    custoBase = Math.floor(boss.manaMax * 0.1);
                }
                return Math.max(1, Math.floor(custoBase));
            }

            function calcularGastoMana(skill) {
                let custoBase;
                if (skill.manaCostPercent !== undefined) {
                    custoBase = game.player.manaMax * skill.manaCostPercent;
                } else if (skill.manaBase !== undefined) {
                    custoBase = skill.manaBase;
                } else {
                    const pctCusto = MANA_GASTO_PCT[skill.rank] || 0.1;
                    custoBase = game.player.manaMax * pctCusto;
                }
                return Math.max(1, Math.floor(custoBase * (1 - game.player.refinoMagicoPct)));
            }

            function atualizarStatusAtributos() {
                document.getElementById("status-nivel").textContent = game.player.nivel;
                document.getElementById("status-rank").textContent = game.player.rank;


                let classeNome = "Nenhuma";
                let classeTitle = "Nenhuma";
                if (game.player.classe) {
                    if (game.player.classe === "Necromante" && game.player.isMarcado) {
                        classeNome = "Monarca das Sombras";
                        classeTitle = "Monarca das Sombras (Marcado)";
                    } else {
                        classeNome = CLASSES_DATA[game.player.classe]?.nomeDisplay || game.player.classe;
                        classeTitle = classeNome;
                        if (game.player.isMarcado) {
                            classeTitle += " (Marcado)";
                        }
                    }
                } else if (game.player.isMarcado) {
                    classeTitle = "Marcado";
                }


                const classeElement = document.getElementById("status-classe");
                classeElement.textContent = classeNome;
                classeElement.title = classeTitle;

                document.getElementById("status-moedas").textContent = game.player.moedas;
                document.getElementById("status-xp").textContent = game.player.xp;
                document.getElementById("status-xpProximo").textContent = game.player.xpProximoNivel;
                const xpBar = document.getElementById("status-xp-bar");
                if (xpBar) xpBar.style.width = getBarPercentage(game.player.xp, game.player.xpProximoNivel);
                document.getElementById("status-vida").textContent = `${game.player.vidaAtual} / ${game.player.vidaMax}`;
                const vidaBar = document.getElementById("status-vida-bar");
                if (vidaBar) vidaBar.style.width = getBarPercentage(game.player.vidaAtual, game.player.vidaMax);
                document.getElementById("bonus-vida-max-val").textContent = game.player.vitalidadeBonusVida.toFixed(0);
                document.getElementById("status-mana").textContent = `${game.player.manaAtual} / ${game.player.manaMax}`;
                const manaBar = document.getElementById("status-mana-bar");
                if (manaBar) manaBar.style.width = getBarPercentage(game.player.manaAtual, game.player.manaMax);
                document.getElementById("bonus-mana-max-val").textContent = game.player.inteligenciaBonusMana.toFixed(0);
                document.getElementById("bonus-dano-fisico").textContent = game.player.currentDanoFisico.toFixed(1);
                document.getElementById("bonus-dano-magico").textContent = game.player.currentDanoMagico.toFixed(1);
                document.getElementById("bonus-resistencia").textContent = (game.player.currentReducaoDano).toFixed(2);
                document.getElementById("bonus-fuga").textContent = (game.player.currentChanceFuga).toFixed(2);
                document.getElementById("bonus-esquiva").textContent = (game.player.currentChanceEsquiva).toFixed(2);
            }
            function mostrarMensagem(html) {
                const storyText = document.getElementById("story-text");
                if (storyText) storyText.innerHTML = html;
            }

            function limparEscolhas() {
                const choices = document.getElementById("choices");
                if (choices) choices.innerHTML = "";

                const battleSubmenu = document.getElementById("battle-submenu-choices");
                if (battleSubmenu) {
                    battleSubmenu.innerHTML = "";
                    battleSubmenu.classList.add("hidden");
                }
                if (game.batalha.emBatalha) {
                    document.getElementById("battle-main-commands")?.classList.remove("hidden");
                }
            }


            function adicionarEscolha(texto, callback, disabled = false, title = null, context = "main") {
    let choicesContainer;
    const battleMainCommands = document.getElementById("battle-main-commands");
    const battleSubmenuChoices = document.getElementById("battle-submenu-choices");

    if (game.batalha.emBatalha && context === "submenu") {
        choicesContainer = battleSubmenuChoices;
        if (choicesContainer) choicesContainer.classList.remove("hidden");
        if (battleMainCommands) battleMainCommands.classList.add("hidden");
    } else {
        choicesContainer = document.getElementById("choices");
        // Se não estiver em batalha ou for contexto 'main', garantir que o submenu de batalha esteja escondido
        if (battleSubmenuChoices) battleSubmenuChoices.classList.add("hidden");
        if (battleMainCommands && game.batalha.emBatalha) battleMainCommands.classList.remove("hidden"); // Mostra comandos principais se estiver em batalha
    }

    if (!choicesContainer) {
        console.error("Container de escolhas não encontrado para contexto:", context);
        return;
    }
    const btn = document.createElement("button");

    // Aplicar classes baseadas nos estilos definidos no <style type="text/tailwindcss">
    // Para botões de escolha principais (fora da batalha ou menu principal da batalha)
    let baseButtonClass = "bg-[#6D4C41] hover:bg-[#543C32] text-[#FFF8E1] border border-[#4E342E] shadow-sm focus:ring-[#A1887F] focus:ring-offset-2 focus:ring-offset-[#3B2E26] font-['Merriweather',_serif] rounded px-4 py-2 font-semibold";
    let disabledButtonClass = "bg-[#5A4A44] text-[#887972] border-[#4A3A34] cursor-default font-['Merriweather',_serif] rounded px-4 py-2 font-semibold";

    // Se for um submenu de batalha, pode ter classes um pouco diferentes ou usar as mesmas.
    // Para este exemplo, usaremos as mesmas classes para simplificar, mas pode ser ajustado.
    // if (context === "submenu") { }

    if (disabled) {
        btn.className = disabledButtonClass;
        btn.disabled = true;
    } else {
        btn.className = baseButtonClass;
    }

    btn.innerHTML = texto;
    if (title) btn.title = title;

    if (callback && !disabled) {
        btn.addEventListener("click", () => {
            // Não limpar escolhas automaticamente se estivermos construindo um submenu de batalha
            // A limpeza/ocultação será gerenciada pela função que chamou adicionarEscolha ou pela ação do botão
            if (!(game.batalha.emBatalha && context === "submenu")) {
                 if (choicesContainer.id === "choices") limparEscolhas(); // Limpa apenas se for o container principal de escolhas
            }
            callback();
        });
    }
    choicesContainer.appendChild(btn);
}


            function toggleHeaderNavButtons(disable) {
                const btnIds = ["btn-inicio", "btn-atributos", "btn-skills", "btn-inventario", "btn-sair"];
                btnIds.forEach(id => {
                    const button = document.getElementById(id);
                    if (button) button.disabled = disable;
                });
                updateGoogleSignInUI();
            }

            function toggleChatInput(disable) {
                const chatInput = document.getElementById('chat-command-input');
                const sendButton = document.getElementById('btn-send-command');
                if (chatInput) chatInput.disabled = disable;
                if (sendButton) sendButton.disabled = disable;
            }



            function updateGoogleSignInUI() {
                const signInButtonContainer = document.getElementById('google-signin-button-container');
                const signOutButton = document.getElementById('btn-signout-google');
                const saveButton = document.getElementById('btn-save-google');
                const greetingSpan = document.getElementById('google-user-greeting');

                const criticalGameState = game.batalha.emBatalha ||
                    (game.dungeon && game.dungeon.isBossRoomConfirmation) ||
                    game.estado === 'gameover' ||
                    game.estado === 'batalha' ||
                    game.estado === 'classeAtribuida' ||
                    game.estado === 'necromancerUnlock';

                if (isGoogleSignedIn && googleDecodedCredential) {
                    if (signInButtonContainer) signInButtonContainer.style.display = 'none';
                    if (signOutButton) signOutButton.classList.remove('hidden');
                    if (signOutButton) signOutButton.disabled = criticalGameState;
                    if (greetingSpan) greetingSpan.textContent = `Olá, ${googleDecodedCredential.given_name || googleDecodedCredential.name || ''}!`;
                    if (greetingSpan) greetingSpan.classList.remove('hidden');

                    if (criticalGameState) {
                        if (saveButton) saveButton.classList.add('hidden');
                        if (saveButton) saveButton.disabled = true;
                    } else {
                        if (saveButton) saveButton.classList.remove('hidden');
                        if (saveButton) saveButton.disabled = false;
                    }
                } else {
                    if (signInButtonContainer) signInButtonContainer.style.display = 'block';
                    if (signOutButton) signOutButton.classList.add('hidden');
                    if (saveButton) saveButton.classList.add('hidden');
                    if (greetingSpan) greetingSpan.classList.add('hidden');
                    if (greetingSpan) greetingSpan.textContent = '';
                }
            }
            
            function createNewPlayerState() {
                return {
                    nome: "Herói", classe: null, nivel: 1, xp: 0, xpProximoNivel: 100, rank: "E",
                    atributos: { ...BASE_STATS }, pontosDistribuir: 10,
                    vidaMax: BASE_HP, vidaAtual: BASE_HP, manaMax: BASE_MANA, manaAtual: BASE_MANA,
                    danoFisicoBase: BASE_DANO_FISICO, danoMagicoBase: BASE_DANO_MAGICO,
                    resistenciaPct: BASE_RESISTENCIA, refinoMagicoPct: 0, percepcaoPct: 0,
                    agilidadePctFuga: 0,
                    vitalidadeBonusVida: 0,
                    inteligenciaBonusMana: 0,
                    isMarcado: false,
                    isMonarcaDasSombras: false,
                    inventario: [],
                    equipamento: { capacete: null, peitoral: null, calca: null, botas: null, arma: null, escudo: null, anel: null, colar: null },
                    moedas: 100, rodadas: 0, xpBonus: XP_BONUS_GLOBAL,
                    magiasAdquiridas: [], magiasEquipadas: [], currentArea: "E",
                    currentDanoFisico: BASE_DANO_FISICO, currentReducaoDano: BASE_RESISTENCIA,
                    currentChanceFuga: 0, currentChanceEsquiva: 0, currentDanoMagico: BASE_DANO_MAGICO,
                    activeBuffs: [],
                    recipienteSombras: [], sombraAtiva: null, lastDefeatedMonsterInfo: null, metLordeDaMorte: false, maxActiveShadows: 1, recipienteCapacity: 10,
                };
            }
            function iniciarJogo(forceReset = false) {
                let gameJustLoadedFromCloud = false;

                if (forceReset && currentFirebaseUser) {
                    deleteGameFromCloud(currentFirebaseUser.uid);
                }

                if (forceReset || !currentFirebaseUser) {
                    game.player = createNewPlayerState();
                    game.dungeon = { active: false, name: "", typeRank: "E", totalRooms: 0, currentRoom: 0, monsterRankForRooms: "D", bossRankForDungeon: "C", bossDefeated: false, isBossRoomConfirmation: false };
                    game.batalha = { emBatalha: false, monstro: null, turnoJogador: true, danoRecebido: 0, isBossBattle: false, isDesafioClasse: false, skillEmDesafioId: null, desafioBossOriginalStats: null, tipoDesafioLorde: null, jogadorAgiuNoTurno: false };
                    game.monstroAtual = null;
                }

                atualizarAtributosDerivados();
                atualizarRank();
                atualizarStatusAtributos();
                atualizarMercadorVisibilidade();
                atualizarRecipienteSombrasTela();
                updateGoogleSignInUI();

                if (game.estado === "characterSetup") {
                    document.getElementById('main-content')?.classList.add('hidden');
                    document.getElementById('game-screen')?.classList.add('hidden');
                    document.getElementById('atributos-screen')?.classList.add('hidden');
                    document.getElementById('inventario-screen')?.classList.add('hidden');
                    document.getElementById('skills-screen')?.classList.add('hidden');
                    document.getElementById('mercador-screen')?.classList.add('hidden');
                    const charSetupScreen = document.getElementById('character-setup-screen');
                    if (charSetupScreen) {
                        charSetupScreen.classList.remove('hidden');
                        const playerNameInput = document.getElementById('player-name-input');
                        if (playerNameInput) playerNameInput.value = game.player.nome;
                        const playerPortraitInput = document.getElementById('player-portrait-input');
                        if (playerPortraitInput) playerPortraitInput.value = game.player.portraitURL === "https://via.placeholder.com/48?text=P" ? "" : (game.player.portraitURL || "");
                    }
                    toggleHeaderNavButtons(true);
                    toggleChatInput(true);
                } else if (!gameJustLoadedFromCloud) {
                    toggleHeaderNavButtons(false);
                    toggleChatInput(false);
                    if (!atribuirClasseAleatoriaSeNecessario() && game.estado !== "necromancerUnlock" && game.estado !== "classeAtribuida") {
                        abrirInicio();
                    }
                } else {
                    toggleHeaderNavButtons(false);
                    toggleChatInput(false);
                    if (game.estado !== "necromancerUnlock" && game.estado !== "classeAtribuida") {
                        abrirInicio();
                    }
                }
            }
            async function loadGameFromCloud(userId) {
    console.log(`Tentando carregar jogo da nuvem para UID: ${userId}`);
    const docRef = db.collection("userSaves").doc(userId);
    let gameJustLoadedFromCloud = false; // Mova para escopo mais alto se precisar fora daqui

    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const loadedGameData = doc.data();
            console.log("Dados do jogo carregados da nuvem:", JSON.parse(JSON.stringify(loadedGameData))); // Log profundo

            // Mesclar player state de forma mais segura
            const defaultPlayerState = createNewPlayerState();
            const loadedPlayer = loadedGameData.player || {};
            game.player = { ...defaultPlayerState, ...loadedPlayer };
            // Garante que atributos aninhados também sejam mesclados se necessário
            game.player.atributos = { ...defaultPlayerState.atributos, ...(loadedPlayer.atributos || {}) };
            game.player.equipamento = { ...defaultPlayerState.equipamento, ...(loadedPlayer.equipamento || {}) };
            // Garante que arrays não sejam sobrescritos por null/undefined se o save for antigo
            game.player.inventario = loadedPlayer.inventario || defaultPlayerState.inventario;
            game.player.magiasAdquiridas = loadedPlayer.magiasAdquiridas || defaultPlayerState.magiasAdquiridas;
            game.player.magiasEquipadas = loadedPlayer.magiasEquipadas || defaultPlayerState.magiasEquipadas;
            game.player.activeBuffs = loadedPlayer.activeBuffs || defaultPlayerState.activeBuffs;
            game.player.recipienteSombras = loadedPlayer.recipienteSombras || defaultPlayerState.recipienteSombras;


            // Mesclar outros estados do jogo
            const defaultDungeonState = { active: false, name: "", typeRank: "E", totalRooms: 0, currentRoom: 0, monsterRankForRooms: "D", bossRankForDungeon: "C", bossDefeated: false, isBossRoomConfirmation: false };
            game.dungeon = { ...defaultDungeonState, ...(loadedGameData.dungeon || {}) };

            const defaultBattleState = { emBatalha: false, monstro: null, turnoJogador: true, danoRecebido: 0, isBossBattle: false, isDesafioClasse: false, skillEmDesafioId: null, desafioBossOriginalStats: null, tipoDesafioLorde: null, jogadorAgiuNoTurno: false };
            game.batalha = { ...defaultBattleState, ...(loadedGameData.batalha || {}) };
            // Se monstro estava em batalha, precisa ser recriado ou restaurado corretamente
            if (game.batalha.emBatalha && loadedGameData.batalha?.monstro) {
                 game.monstroAtual = loadedGameData.batalha.monstro; // Assume que o objeto monstro é completo
            } else {
                game.monstroAtual = null;
            }


            game.estado = loadedGameData.estado || "inicio";
            game.mundo = loadedGameData.mundo || "Arkham";

            const defaultMerchantState = { itens: [], selecionados: new Set() };
            game.mercador = { ...defaultMerchantState, ...(loadedGameData.mercador || {}) };
            if (loadedGameData.mercador && loadedGameData.mercador.selecionados && Array.isArray(loadedGameData.mercador.selecionados)) {
                game.mercador.selecionados = new Set(loadedGameData.mercador.selecionados);
            } else {
                game.mercador.selecionados = new Set(); // Garante que seja um Set
            }


            console.log("Estado do jogo após carregar e mesclar:", JSON.parse(JSON.stringify(game))); // Log profundo

            gameJustLoadedFromCloud = true;
            atualizarAtributosDerivados();
            atualizarRank();
            atualizarStatusAtributos();
            atualizarInventarioTela();
            atualizarSkillsTela();
            atualizarMercadorVisibilidade();
            atualizarRecipienteSombrasTela();
            updateGoogleSignInUI();

            // Restaurar o estado da interface com base no estado do jogo carregado
            if (game.estado === "batalha" && game.batalha.emBatalha && game.monstroAtual) {
                // A função iniciarBatalha já trata de mostrar a interface e desabilitar botões do header
                iniciarBatalha(game.monstroAtual); // Passa o monstro carregado
            } else if (game.dungeon.active) {
                mostrarMensagem(`Continuando na ${game.dungeon.name}, sala <span class="math-inline">\{game\.dungeon\.currentRoom \+ 1\}/</span>{game.dungeon.totalRooms}.`);
                // Adicionar lógica para apresentar escolhas da dungeon (avançar, etc.)
                // Exemplo: if (!game.batalha.emBatalha) { apresentarOpcoesSalaMasmorra(); }
                 if (game.dungeon.isBossRoomConfirmation) {
                    // Recria a tela de confirmação do chefe
                    avancarSalaMasmorra(); // Esta função deve lidar com a recriação da confirmação
                } else if (!game.batalha.emBatalha){
                    // Lógica para apresentar opções da sala atual, se não estiver em batalha
                    mostrarMensagem(`Você está na sala <span class="math-inline">\{game\.dungeon\.currentRoom \+ 1\}/</span>{game.dungeon.totalRooms} d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>.`);
                    adicionarEscolha("Avançar para próxima sala", avancarSalaMasmorra);
                    adicionarEscolha("Tentar fugir da masmorra", () => fugirDaMasmorra(false));
                    toggleHeaderNavButtons(true); // Masmorra ativa, desabilita navegação principal
                    toggleChatInput(true);
                }
            } else if (game.estado === "characterSetup") {
                // A função iniciarJogo já deve ter lidado com isso
            }
             else {
                abrirInicio(); // Estado padrão se nenhum outro se aplicar
            }

        } else {
            console.log("Nenhum save encontrado na nuvem para este usuário. Iniciando novo jogo (estado characterSetup).");
            game.estado = "characterSetup"; // Força a criação do personagem
            iniciarJogo(true); // Força reset local e UI de setup
        }
    } catch (error) {
        console.error("Erro ao carregar jogo da nuvem:", error);
        alert("Erro ao carregar seu progresso da nuvem. Iniciando um novo jogo local. Detalhes: " + error.message);
        game.estado = "characterSetup"; // Segurança: se o load falhar, vai para o setup
        iniciarJogo(false); // Não força reset da nuvem, apenas local
    }
}

            async function saveGameToCloud() {
                if (!currentFirebaseUser) {
                    alert("Você precisa estar conectado com o Google para salvar na nuvem.");
                    return;
                }
                if (game.batalha.emBatalha || (game.dungeon && game.dungeon.isBossRoomConfirmation)) {
                    alert("Você não pode salvar o jogo durante uma batalha ou confirmação de chefe de masmorra.");
                    return;
                }

                console.log("Tentando salvar jogo na nuvem...");
                const gameDataToSave = {
                    player: JSON.parse(JSON.stringify(game.player)),
                    dungeon: JSON.parse(JSON.stringify(game.dungeon)),
                    batalha: JSON.parse(JSON.stringify(game.batalha)),
                    estado: game.estado,
                    mundo: game.mundo,
                    monstroAtual: JSON.parse(JSON.stringify(game.monstroAtual)),
                    mercador: {
                        itens: JSON.parse(JSON.stringify(game.mercador.itens)),
                        selecionados: Array.from(game.mercador.selecionados)
                    }
                };
                if (gameDataToSave.batalha) {
                    if (!gameDataToSave.batalha.emBatalha) {
                        gameDataToSave.batalha.monstro = null;
                        gameDataToSave.batalha.isBossBattle = false;
                    }
                }

                try {
                    await db.collection("userSaves").doc(currentFirebaseUser.uid).set(gameDataToSave);
                    console.log("Jogo salvo na nuvem com sucesso!");
                    alert("Seu progresso foi salvo na nuvem!");
                } catch (error) {
                    console.error("Erro ao salvar jogo na nuvem:", error);
                    alert("Falha ao salvar o progresso na nuvem: " + error.message);
                }
            }

            async function deleteGameFromCloud(userId) {
                if (!userId) return;
                console.log(`Tentando deletar save da nuvem para UID: ${userId}`);
                try {
                    await db.collection("userSaves").doc(userId).delete();
                    console.log("Save da nuvem deletado com sucesso.");
                } catch (error) {
                    console.error("Erro ao deletar save da nuvem:", error);
                }
            }
            function initializeAuthListener() {
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log("Usuário conectado:", user.uid);
            currentFirebaseUser = user; 
          
            loadGameFromCloud(user.uid); 
        } else {
            console.log("Nenhum usuário conectado.");
            currentFirebaseUser = null;
            isGoogleSignedIn = false;
            googleDecodedCredential = null;
            updateGoogleSignInUI(); 
            iniciarJogo(false);
        }
    });
}

            function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
        .then((result) => {
      
            console.log("Login com Google (popup) bem-sucedido para Firebase.");
            isGoogleSignedIn = true; 
            googleDecodedCredential = { 
                given_name: result.additionalUserInfo?.profile?.given_name || result.user.displayName.split(' ')[0],
                name: result.user.displayName
            };
        
            updateGoogleSignInUI();
        })
        .catch((error) => {
            console.error("Erro no login com Google (popup) para Firebase:", error.code, error.message);
            alert("Erro ao fazer login com Google: " + error.message);
            isGoogleSignedIn = false;
            googleDecodedCredential = null;
            updateGoogleSignInUI();
        });
}

            function signOutFromFirebase() {
                if (game.batalha.emBatalha || (game.dungeon && game.dungeon.isBossRoomConfirmation)) {
                    alert("Você não pode sair durante uma batalha ou confirmação de chefe de masmorra.");
                    return;
                }
                auth.signOut().then(() => {
                    console.log("Usuário desconectado do Firebase.");
                    currentFirebaseUser = null;
                    isGoogleSignedIn = false;
                    googleDecodedCredential = null;
                }).catch((error) => {
                    console.error("Erro ao sair do Firebase:", error);
                    alert("Erro ao tentar sair: " + error.message);
                });
            }
            window.onload = () => {
    console.log("window.onload disparado.");

    initializeAuthListener();

    const btnFirebaseGoogleLoginContainer = document.getElementById('google-signin-button-container');
    const gSignInDivOriginal = document.getElementById("g_id_signin_button_div");

    if (gSignInDivOriginal) {
        gSignInDivOriginal.innerHTML = `<button id="btn-firebase-google-login" class="p-2 bg-[#4285F4] hover:bg-[#357ae8] text-white font-bold rounded flex items-center justify-center"><i class="fab fa-google mr-2"></i>Login com Google</button>`;
        const firebaseGoogleLoginButton = document.getElementById('btn-firebase-google-login');
        if (firebaseGoogleLoginButton) {
            firebaseGoogleLoginButton.addEventListener('click', signInWithGoogle);
        } else {
            console.error("Falha ao criar o botão de login do Google com Firebase.");
        }
    } else if (btnFirebaseGoogleLoginContainer) {
        const newLoginButton = document.createElement('button');
        newLoginButton.id = "btn-firebase-google-login";
        newLoginButton.className = "p-2 bg-[#4285F4] hover:bg-[#357ae8] text-white font-bold rounded flex items-center justify-center";
        newLoginButton.innerHTML = `<i class="fab fa-google mr-2"></i> Login com Google`;
        newLoginButton.addEventListener('click', signInWithGoogle);
        btnFirebaseGoogleLoginContainer.innerHTML = '';
        btnFirebaseGoogleLoginContainer.appendChild(newLoginButton);
    } else {
        console.warn("Container do botão de login do Google ('google-signin-button-container' ou 'g_id_signin_button_div') não encontrado.");
    }

    const btnSaveCloud = document.getElementById('btn-save-google');
    if (btnSaveCloud) {
        btnSaveCloud.addEventListener('click', saveGameToCloud);
    }

    const btnSignOutCloud = document.getElementById('btn-signout-google');
    if (btnSignOutCloud) {
        btnSignOutCloud.addEventListener('click', signOutFromFirebase);
    }

    const commandFooter = document.querySelector('footer');
    const chatInputForFocus = document.getElementById('chat-command-input');
    document.addEventListener('keydown', function (event) {
        if (event.shiftKey && (event.key === 'W' || event.key === 'w')) {
            event.preventDefault();
            if (commandFooter) {
                commandFooter.classList.toggle('hidden');
                if (!commandFooter.classList.contains('hidden') && chatInputForFocus) {
                    chatInputForFocus.focus();
                }
            }
        }
    });

    document.getElementById("btn-inicio")?.addEventListener("click", abrirInicio);
    document.getElementById("btn-atributos")?.addEventListener("click", abrirAtributos);
    document.getElementById("btn-skills")?.addEventListener("click", abrirSkills);
    document.getElementById("btn-inventario")?.addEventListener("click", abrirInventario);
    document.getElementById("btn-mercador")?.addEventListener("click", abrirMercador);
    document.getElementById("btn-sair")?.addEventListener("click", sairJogo);
    document.getElementById("btn-save-character-setup")?.addEventListener("click", salvarSetupPersonagem);

    document.getElementById("atributos-screen")?.addEventListener("click", manipularBotaoAtributo);
    document.getElementById("btn-salvar-atributos")?.addEventListener("click", salvarAtributos);
    const attributeModeButtons = document.querySelectorAll('.attribute-mode-btn');
    attributeModeButtons.forEach(btn => {
        btn.addEventListener('click', manipularBotaoAtributo);
    });
    const defaultModeButton = document.querySelector('.attribute-mode-btn[data-amount="1"]');
    if (defaultModeButton) {
        defaultModeButton.classList.add('active');
        if (game && game.player) {
            game.player.attributeAddAmount = 1;
        }
    }

    document.getElementById("btn-comprar-mercador")?.addEventListener("click", comprarItensMercador);

    document.getElementById("btn-battle-fight")?.addEventListener("click", () => {
        if (game.batalha.emBatalha && game.batalha.turnoJogador && !game.batalha.jogadorAgiuNoTurno) {
            mostrarHabilidadesArma();
        } else if (game.batalha.jogadorAgiuNoTurno) {
            mostrarMensagem("Você já agiu neste turno.");
        }
    });
    document.getElementById("btn-battle-skill")?.addEventListener("click", () => {
        if (game.batalha.emBatalha && game.batalha.turnoJogador) {
            usarMagiaMenu();
        }
    });
    document.getElementById("btn-battle-item")?.addEventListener("click", () => {
        if (game.batalha.emBatalha && game.batalha.turnoJogador) {
            usarPocaoMenu();
        }
    });
    document.getElementById("btn-battle-escape")?.addEventListener("click", () => {
        if (game.batalha.emBatalha && game.batalha.turnoJogador && !(game.batalha.monstro.isBoss)) {
            tentarFugir();
        } else if (game.batalha.monstro.isBoss) {
            mostrarMensagem("Não é possível fugir de um chefe!");
        }
    });

    const btnSendCommand = document.getElementById("btn-send-command");
    const chatCommandInputElement = document.getElementById("chat-command-input");

    if (btnSendCommand && chatCommandInputElement) {
        btnSendCommand.addEventListener("click", () => {
            if (chatCommandInputElement.value) {
                processChatCommand(chatCommandInputElement.value);
                chatCommandInputElement.value = "";
            }
        });
        chatCommandInputElement.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                if (chatCommandInputElement.value) {
                    processChatCommand(chatCommandInputElement.value);
                    chatCommandInputElement.value = "";
                }
            }
        });
    } else {
        console.error("ERRO: Elementos do chat de comando ('btn-send-command' ou 'chat-command-input') não encontrados.");
    }
    console.log("Fim da configuração de window.onload.");
};

            function atualizarMercadorVisibilidade() {
    const mercadorBtn = document.getElementById("btn-mercador");
    if (!mercadorBtn) {
       console.error("Botão do mercador ('btn-mercador') não encontrado no DOM!");
        return;
    }

    const nivelOk = game.player.nivel > 0 && game.player.nivel % 5 === 0;
    const naoEmBatalha = !game.batalha.emBatalha;
    const naoEmMasmorra = !game.dungeon.active;

    const estadoInicio = game.estado === "inicio";

    const condicoesMet = nivelOk && naoEmBatalha && naoEmMasmorra && estadoInicio;
    if (condicoesMet) {
        mercadorBtn.classList.remove("hidden");
    } else {
        mercadorBtn.classList.add("hidden");
    }
}

            function abrirInicio() {
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
                game.estado = "inicio";
                game.dungeon.active = false;
                game.dungeon.isBossRoomConfirmation = false;
                game.batalha.isBossBattle = false;

                if (!game.batalha.emBatalha) {
                    game.player.activeBuffs = [];
                }

                atualizarMercadorVisibilidade();


                document.getElementById("game-screen")?.classList.remove("hidden");
                document.getElementById("atributos-screen")?.classList.add("hidden");
                document.getElementById("inventario-screen")?.classList.add("hidden");
                document.getElementById("mercador-screen")?.classList.add("hidden");
                document.getElementById("skills-screen")?.classList.add("hidden");
                document.getElementById("character-setup-screen")?.classList.add("hidden");


                if (game.player.metLordeDaMorte && !game.player.classe) {
                    const mockLorde = { isLordeDaMorte: true };
                    if (tentarDesbloquearNecromante(mockLorde)) return;
                }
                if (!game.player.classe && atribuirClasseAleatoriaSeNecessario()) {
                    return;
                }

                let inicioMsg = `Você está na <span class="font-bold text-sky-400">Área ${DUNGEON_CONFIG[game.player.currentArea].name}</span> do mundo de Arkham.<br/><br/>O que deseja fazer?`;
                if (game.player.lastDefeatedMonsterInfo && game.player.classe === "Necromante" && game.player.magiasAdquiridas.includes("n_extracao_sombras") && !game.player.lastDefeatedMonsterInfo.isBoss) {
                    inicioMsg = `Você está na <span class="font-bold text-sky-400">Área ${DUNGEON_CONFIG[game.player.currentArea].name}</span>. A essência do <span class="text-purple-300">${game.player.lastDefeatedMonsterInfo.nome}</span> ainda paira, pronta para extração.<br/><br/>O que deseja fazer?`;
                }

                mostrarMensagem(inicioMsg);
                limparEscolhas();

                if (game.player.classe === "Necromante" && game.player.lastDefeatedMonsterInfo && game.player.magiasAdquiridas.includes("n_extracao_sombras") && !game.player.lastDefeatedMonsterInfo.isBoss) {
                    const extracaoSkill = CLASSES_DATA.Necromante.habilidades.find(h => h.id === "n_extracao_sombras");
                    if (extracaoSkill) {
                        adicionarEscolha(`Usar ${extracaoSkill.nome} (Mana: ${calcularGastoMana(extracaoSkill)})`, () => {
                            const manaCost = calcularGastoMana(extracaoSkill);
                            if (game.player.manaAtual >= manaCost) {
                                game.player.manaAtual -= manaCost;
                                const lastMonster = game.player.lastDefeatedMonsterInfo;
                                const newRankIndex = Math.max(0, rankToIndex(lastMonster.rank) - 1);
                                const shadowRank = indexToRank(newRankIndex);
                                const shadowId = crypto.randomUUID();
                                const newShadow = {
                                    id: shadowId, nomeOriginal: lastMonster.nome, nomeSombra: `Sombra de ${lastMonster.nome}`,
                                    rankOriginal: lastMonster.rank, rankSombra: shadowRank,
                                    statsOriginais: { vidaMax: lastMonster.vidaMax, danoFisico: lastMonster.danoFisico, danoMagico: lastMonster.danoMagico }
                                };

                                if (game.player.recipienteSombras.length < game.player.recipienteCapacity) {
                                    game.player.recipienteSombras.push(newShadow);
                                    game.player.lastDefeatedMonsterInfo = null;
                                    atualizarRecipienteSombrasTela();
                                    abrirInicio();
                                } else {
                                    mostrarMensagem(`Seu Recipiente de Sombras está cheio (${game.player.recipienteSombras.length}/${game.player.recipienteCapacity}). Não foi possível extrair a sombra. Mana não gasta.`);
                                    game.player.manaAtual += manaCost;
                                    abrirInicio();
                                }
                            } else {
                                mostrarMensagem(`Mana insuficiente para Extração de Sombras. (${manaCost} necessário).`);
                                abrirInicio();
                            }
                            atualizarStatusAtributos();
                        }, game.player.manaAtual < calcularGastoMana(extracaoSkill) || game.player.recipienteSombras.length >= game.player.recipienteCapacity, extracaoSkill.descricao);
                    }
                }

                adicionarEscolha("Explorar a área", explorarArea);
                adicionarEscolha(`Entrar na Masmorra (${DUNGEON_CONFIG[game.player.currentArea].name})`, () => entrarMasmorra(game.player.currentArea));
                adicionarEscolha("Ver atributos", abrirAtributos, game.batalha.emBatalha);
                adicionarEscolha("Abrir habilidades", abrirSkills, game.batalha.emBatalha);
                adicionarEscolha("Abrir inventário", abrirInventario, game.batalha.emBatalha);
                if (game.player.nivel >= 10) {
                    adicionarEscolha("Mudar de Área", abrirTelaMudarArea, game.batalha.emBatalha);
                }

                updateGoogleSignInUI();
                atualizarStatusAtributos();
            }
            function salvarSetupPersonagem() {
                const playerNameInput = document.getElementById("player-name-input");
                const playerPortraitInput = document.getElementById("player-portrait-input");

                const playerName = playerNameInput ? playerNameInput.value.trim() : "Herói";
                const playerPortrait = playerPortraitInput ? playerPortraitInput.value.trim() : "";

                game.player.nome = playerName || "Herói";
                game.player.portraitURL = playerPortrait || "https://via.placeholder.com/48?text=P";

                const playerBattlePortrait = document.getElementById("player-battle-portrait");
                if (playerBattlePortrait) playerBattlePortrait.src = game.player.portraitURL;

                document.getElementById("character-setup-screen")?.classList.add("hidden");
                document.getElementById("main-content")?.classList.remove("hidden");
                game.estado = "inicio";

                if (currentFirebaseUser) {
                    saveGameToCloud();
                }
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
                abrirInicio();
            }
            function verificarDesbloqueioHabilidadesClasse() {
                const mensagensNovasSkills = [];
                if (!game.player.classe || !CLASSES_DATA[game.player.classe]) {
                    return mensagensNovasSkills;
                }

                const classeAtual = CLASSES_DATA[game.player.classe];
                if (!classeAtual.habilidades) {
                    return mensagensNovasSkills;
                }

                classeAtual.habilidades.forEach(skill => {
                    if (skill.requerDesafio) {
                        return;
                    }

                    if (skill.monarcaOnly && !(game.player.classe === "Necromante" && game.player.isMarcado)) {
                        return;
                    }

                    if (game.player.classe === "Necromante" &&
                        (skill.id === "n_extracao_sombras" || skill.id === "n_invocar_sombra") &&
                        !game.player.metLordeDaMorte) {
                        return;
                    }

                    if (game.player.nivel >= skill.unlockLevel && !game.player.magiasAdquiridas.includes(skill.id)) {
                        game.player.magiasAdquiridas.push(skill.id);
                        let msgSkill = `Você aprendeu a habilidade: <span class="font-bold text-amber-400">${skill.nome}</span>!`;
                        if (game.player.magiasEquipadas.length < 4) {
                            game.player.magiasEquipadas.push(skill.id);
                            msgSkill += " (Equipada automaticamente)";
                        }
                        mensagensNovasSkills.push(msgSkill);
                    }
                });
                return mensagensNovasSkills;
            }
            function explorarArea() {
                game.player.rodadas++;
                game.player.lastDefeatedMonsterInfo = null;
                const evento = Math.random();
                if (rankToIndex(game.player.currentArea) >= rankToIndex("B") && Math.random() < 0.05) {
                    const monarchBoss = gerarMonarcaAleatorio();
                    if (monarchBoss) {
                        game.monstroAtual = monarchBoss;
                        mostrarMensagem(`Um arrepio percorre sua espinha! Das profundezas de Arkham, surge o <span class="font-bold text-red-500">${monarchBoss.nome}</span>!`);
                        setTimeout(() => iniciarBatalha(monarchBoss), 2000);
                        updateGoogleSignInUI();
                        return;
                    }
                }
                if (evento < 0.7) {
                    const currentAreaRankIndex = rankToIndex(game.player.currentArea);
                    const rankForMonsters = [RANKS[currentAreaRankIndex]];
                    if (currentAreaRankIndex + 1 < RANKS.length && Math.random() < 0.3) {
                        rankForMonsters.push(RANKS[currentAreaRankIndex + 1]);
                    }
                    const chosenRankForMonster = randomChoice(rankForMonsters);
                    const monstro = gerarMonstro(chosenRankForMonster);
                    game.monstroAtual = monstro;
                    iniciarBatalha(monstro);
                } else {
                    mostrarMensagem(`Você explora os <span class="font-bold text-sky-400">${DUNGEON_CONFIG[game.player.currentArea].name}</span> e encontra um lugar tranquilo. O vento sopra suavemente e você aproveita para recuperar suas forças.<br/><br/>O que deseja fazer?`);
                    limparEscolhas();
                    adicionarEscolha("Continuar explorando", explorarArea);
                    adicionarEscolha(`Entrar na Masmorra (Rank ${game.player.currentArea})`, () => entrarMasmorra(game.player.currentArea));
                    adicionarEscolha("Ver atributos", abrirAtributos);
                    adicionarEscolha("Abrir habilidades", abrirSkills);
                    adicionarEscolha("Abrir inventário", abrirInventario);
                    if (game.player.nivel >= 10) adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
                }
                atualizarStatusAtributos();
                updateGoogleSignInUI();
            }

            function abrirTelaMudarArea() {
                game.estado = "mudarAreaScreen";
                const playerRankIndex = rankToIndex(game.player.rank);
                let areaChoicesHtml = `Você está atualmente nos <span class="font-bold text-sky-400">${DUNGEON_CONFIG[game.player.currentArea].name}</span>.<br/><br/>Escolha uma nova área para viajar (Requer Nível 10+ e Rank apropriado):<br/>`;
                mostrarMensagem(areaChoicesHtml);
                limparEscolhas();

                RANKS.forEach(areaRank => {
                    const targetAreaRankIndex = rankToIndex(areaRank);
                    if (targetAreaRankIndex <= playerRankIndex) {
                        if (areaRank === game.player.currentArea) {
                            adicionarEscolha(`${DUNGEON_CONFIG[areaRank].name} (Atual)`, null, true);
                        } else {
                            adicionarEscolha(`Viajar para ${DUNGEON_CONFIG[areaRank].name}`, () => mudarDeArea(areaRank));
                        }
                    } else {
                        const choicesDiv = document.getElementById("choices");
                        if (!choicesDiv) return;
                        const btn = document.createElement("button");
                        btn.className = "bg-slate-700 rounded px-4 py-2 font-semibold text-slate-500 cursor-not-allowed";
                        btn.innerHTML = `${DUNGEON_CONFIG[areaRank].name} (Requer Rank ${areaRank})`;
                        btn.disabled = true;
                        choicesDiv.appendChild(btn);
                    }
                });
                adicionarEscolha("Voltar", abrirInicio);
                updateGoogleSignInUI();
            }

            function mudarDeArea(novaAreaRank) {
                game.player.currentArea = novaAreaRank;
                game.player.lastDefeatedMonsterInfo = null;
                mostrarMensagem(`Você viajou para os <span class="font-bold text-sky-400">${DUNGEON_CONFIG[novaAreaRank].name}</span>.<br/><br/>O que deseja fazer?`);
                limparEscolhas();
                adicionarEscolha("Explorar a área", explorarArea);
                adicionarEscolha(`Entrar na Masmorra (Rank ${novaAreaRank})`, () => entrarMasmorra(novaAreaRank));
                adicionarEscolha("Ver atributos", abrirAtributos);
                adicionarEscolha("Abrir habilidades", abrirSkills);
                adicionarEscolha("Abrir inventário", abrirInventario);
                if (game.player.nivel >= 10) adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
                updateGoogleSignInUI();
            }

            function tentarDesbloquearNecromante(monstroDerrotado) {
                if (monstroDerrotado.isLordeDaMorte && !game.player.classe) {
                    game.estado = "necromancerUnlock";
                    toggleHeaderNavButtons(true);
                    toggleChatInput(true);

                    game.player.classe = "Necromante";
                    const classeInfo = CLASSES_DATA.Necromante;
                    let msg = `<span class="text-purple-400 font-bold text-xl">Destino Revelado!</span><br/>Ao derrotar o Lorde da Morte, você sente uma afinidade sombria despertar! Sua classe agora é <span class="font-bold text-purple-300">${classeInfo.nomeDisplay}</span>!`;

                    const skillExtracao = classeInfo.habilidades.find(h => h.id === "n_extracao_sombras");
                    const skillInvocar = classeInfo.habilidades.find(h => h.id === "n_invocar_sombra");

                    // Ensure skills are only added if not already acquired
                    if (skillExtracao && !game.player.magiasAdquiridas.includes(skillExtracao.id)) {
                        game.player.magiasAdquiridas.push(skillExtracao.id);
                        msg += `<br/>Você aprendeu: <span class="font-bold text-amber-400">${skillExtracao.nome}</span>.`;
                        if (game.player.magiasEquipadas.length < 4) {
                            game.player.magiasEquipadas.push(skillExtracao.id);
                            msg += ` Equipada automaticamente.`;
                        }
                    }
                    if (skillInvocar && !game.player.magiasAdquiridas.includes(skillInvocar.id)) {
                        game.player.magiasAdquiridas.push(skillInvocar.id);
                        msg += `<br/>Você aprendeu: <span class="font-bold text-amber-400">${skillInvocar.nome}</span>.`;
                        if (game.player.magiasEquipadas.length < 4 && !game.player.magiasEquipadas.includes(skillInvocar.id)) {
                            game.player.magiasEquipadas.push(skillInvocar.id);
                            msg += ` Equipada automaticamente.`;
                        }
                    }
                }
                return false;
            }

            function atribuirClasseAleatoriaSeNecessario() {
                if (game.player.classe) return false;

                if (game.player.nivel >= 10 && rankToIndex(game.player.rank) >= rankToIndex("D")) {
                    game.estado = "classeAtribuida";
                    toggleHeaderNavButtons(true);
                    toggleChatInput(true);

                    const availableClasses = PLAYER_CLASSES_LIST.filter(c => c !== "Necromante");
                    if (availableClasses.length === 0) {
                        abrirInicio(); return false;
                    }
                    const classeAleatoria = randomChoice(availableClasses);
                    game.player.classe = classeAleatoria;
                    const classeEscolhida = CLASSES_DATA[classeAleatoria];
                    if (!classeEscolhida) {
                        abrirInicio(); return false;
                    }

                    let msg = `Ao atingir o Nível 10 e Rank D, o destino interveio!<br/>Sua classe agora é <span class="font-bold text-sky-400">${classeEscolhida.nomeDisplay}</span>!`;

                    if (classeEscolhida.habilidades && classeEscolhida.habilidades.length > 0) {
                        classeEscolhida.habilidades.forEach((skill, index) => { // Added index to skill for future use if needed
                            skill.indiceNaClasse = index; // Assign an index to the skill within its class
                            if (game.player.nivel >= skill.unlockLevel && !game.player.magiasAdquiridas.includes(skill.id)) {
                                const startingSkills = classeEscolhida.habilidades
                                    .filter(h => h.unlockLevel <= game.player.nivel)
                                    .sort((a, b) => a.unlockLevel - b.unlockLevel);
                                const isStartingSkill = startingSkills.length > 0 && startingSkills[0].id === skill.id;

                                if (isStartingSkill || skill.unlockLevel === 1) {
                                    game.player.magiasAdquiridas.push(skill.id);
                                    msg += `<br/>Você aprendeu: <span class="font-bold text-amber-400">${skill.nome}</span>.`;
                                    if (game.player.magiasEquipadas.length < 4) {
                                        game.player.magiasEquipadas.push(skill.id);
                                        msg += ` A habilidade foi equipada automaticamente.`;
                                    }
                                }
                            }
                        });
                    }
                    atualizarStatusAtributos();
                    atualizarSkillsTela();
                    mostrarMensagem(msg);
                    limparEscolhas();
                    adicionarEscolha("Entendido, continuar aventura!", () => {
                        abrirInicio();
                    });
                    updateGoogleSignInUI();
                    return true;
                }
                return false;
            }

            function iniciarBatalha(monstro) {
                game.batalha.jogadorAgiuNoTurno = false;
                habilitarBotoesAcaoBatalha();
                toggleHeaderNavButtons(true);
                toggleChatInput(true);
                game.estado = "batalha"; game.batalha.emBatalha = true; game.batalha.monstro = monstro;
                game.batalha.turnoJogador = true; game.batalha.isBossBattle = monstro.isBoss;

                decrementarBuffs();

                let msg = `Você encontrou: <span class="font-bold text-rose-400">${monstro.nome}</span> (Rank ${monstro.rank}).`;
                if (game.dungeon.active && !monstro.isBoss) {
                    msg = `Sala ${game.dungeon.currentRoom + 1}/${game.dungeon.totalRooms} d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>.<br/>` + msg;

                } else if (monstro.isLordeDaMorte) {
                    msg = `<span class="text-purple-600 font-extrabold">PRESENÇA SOMBRIA!</span><br/>O <span class="font-bold text-purple-400">${monstro.nome}</span> surge!<br/>` + msg;
                } else if (monstro.isBoss) {
                    msg = `<span class="text-rose-500 font-bold">BATALHA DE CHEFE!</span><br/>` + msg;
                }

                if (game.player.sombraAtiva && game.player.sombraAtiva.statsAtuais) {
                    const s = game.player.sombraAtiva;
                    msg += `<br/><span class="text-purple-300">Sua ${s.nomeSombra} está pronta.</span>`;
                }
                msg += `<br/><br/>Sua vez!`;

                mostrarMensagem(msg);
                limparEscolhas();
                showBattleInterface(true);

                atualizarStatusAtributos();
                updateGoogleSignInUI();
            }

            function gerarLordeDaMorteBaseStats() {
                return {
                    nome: "Lorde da Morte", rank: "S", vidaMax: 4000, vidaAtual: 4000,
                    danoFisico: 200, danoMagico: 150, xpGanho: 0,
                    fugaPct: 0, isBoss: true, isLordeDaMorte: true
                };
            }

            function gerarLordeDaMorteParaDesafio(tipoDesafio) {
                const baseLorde = gerarLordeDaMorteBaseStats();
                let lordeDesafio = { ...baseLorde };

                lordeDesafio.nome = `Lorde da Morte (${tipoDesafio === "lorde_dominio" ? "Desafio de Domínio" : "Desafio de Exército"})`;
                lordeDesafio.isLordeDaMorteDesafio = true;
                lordeDesafio.isLordeDaMorte = false;
                lordeDesafio.xpGanho = 1000 * (tipoDesafio === "lorde_dominio" ? 2 : 4);
                lordeDesafio.manaMax = 500;
                lordeDesafio.manaAtual = 500;


                if (tipoDesafio === "lorde_dominio") {
                    lordeDesafio.vidaMax = Math.floor(baseLorde.vidaMax * 1.5);
                    lordeDesafio.danoFisico = Math.floor(baseLorde.danoFisico * 1.5);
                    lordeDesafio.danoMagico = Math.floor(baseLorde.danoMagico * 1.5);
                    lordeDesafio.vidaAtual = lordeDesafio.vidaMax;
                    lordeDesafio.copiaRecipienteSombras = JSON.parse(JSON.stringify(game.player.recipienteSombras));
                    lordeDesafio.sombraAtivaCopiada = null;
                    lordeDesafio.habilidadesLorde = [
                        { id: "lorde_invocar", nome: "Comando Sombrio", manaBase: 50, efeito: { tipo: "lorde_invoca_sombra_copiada" } }
                    ];

                } else if (tipoDesafio === "lorde_exercito") {
                    lordeDesafio.vidaMax = Math.floor(baseLorde.vidaMax * 2.0);
                    lordeDesafio.danoFisico = Math.floor(baseLorde.danoFisico * 2.0);
                    lordeDesafio.danoMagico = Math.floor(baseLorde.danoMagico * 2.0);
                    lordeDesafio.vidaAtual = lordeDesafio.vidaMax;
                }
                return lordeDesafio;
            }

            function iniciarDesafioLordeDaMorte(tipoDesafio, skillIdAlvo) {
                mostrarMensagem(`Você se prepara para enfrentar o Lorde da Morte em um desafio para <span class="font-bold text-sky-400">${CLASSES_DATA.Necromante.habilidades.find(h => h.id === skillIdAlvo)?.nome || 'uma nova habilidade'}</span>...`);
                limparEscolhas();

                const lordeParaDesafio = gerarLordeDaMorteParaDesafio(tipoDesafio);
                game.monstroAtual = lordeParaDesafio;

                game.batalha.isDesafioClasse = false;
                game.batalha.monstro = lordeParaDesafio;
                game.batalha.skillEmDesafioId = skillIdAlvo;
                game.batalha.tipoDesafioLorde = tipoDesafio;

                if (tipoDesafio === "lorde_exercito") {
                    mostrarMensagem(`Você sente suas energias arcanas e poções seladas! Apenas sua arma responderá neste confronto.`);
                }

                setTimeout(() => {
                    iniciarBatalha(lordeParaDesafio);
                }, 3000);
            }

            function falharDesafioLordeDaMorte() {
                const skillNomeFalha = CLASSES_DATA.Necromante.habilidades.find(h => h.id === game.batalha.skillEmDesafioId)?.nome || "esta poderosa habilidade";
                mostrarMensagem(`O Lorde da Morte o subjugou. Você ainda não está pronto para dominar <span class="font-bold text-sky-400">${skillNomeFalha}</span>.<br/>Treine mais e tente novamente.`);

                game.batalha.skillEmDesafioId = null;
                game.batalha.tipoDesafioLorde = null;
                game.batalha.monstro = null;
                game.batalha.emBatalha = false;

                game.player.vidaAtual = Math.max(1, Math.floor(game.player.vidaMax * 0.25));
                game.player.manaAtual = Math.max(0, Math.floor(game.player.manaMax * 0.25));
                atualizarStatusAtributos();

                limparEscolhas();
                adicionarEscolha("Retornar à tela de Habilidades", abrirSkills);
                adicionarEscolha("Voltar ao Início", abrirInicio);
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
            }
            function iniciarDesafioHabilidade(skillAlvo) {
                if (!game.player.classe) {
                    mostrarMensagem("Você precisa de uma classe para enfrentar desafios de habilidade.");
                    return;
                }
                mostrarMensagem(`Você se prepara para o desafio de dominar <span class="font-bold text-sky-400">${skillAlvo.nome}</span>...<br/>Um eco de suas próprias proezas se materializa!`);
                limparEscolhas();

                const bossClone = gerarBossDesafioClasse(skillAlvo);
                game.batalha.isDesafioClasse = true;
                game.batalha.skillEmDesafioId = skillAlvo.id;
                game.monstroAtual = bossClone;

                setTimeout(() => {
                    iniciarBatalha(bossClone);
                }, 2500);
            }
            function gerarBossDesafioClasse(skillAlvo) {
                const p = game.player;
                const classeAtual = CLASSES_DATA[p.classe];
                let habilidadesBoss = [];

                const primeiraSkillClasse = classeAtual.habilidades.find(h => h.indiceNaClasse === 0);
                if (primeiraSkillClasse) habilidadesBoss.push(primeiraSkillClasse);

                habilidadesBoss.push(skillAlvo);

                if (skillAlvo.indiceNaClasse === 2) {
                    const segundaSkillClasse = classeAtual.habilidades.find(h => h.indiceNaClasse === 1);
                    if (segundaSkillClasse && game.player.magiasAdquiridas.includes(segundaSkillClasse.id)) {
                        habilidadesBoss.push(segundaSkillClasse);
                    }
                }
                habilidadesBoss = [...new Set(habilidadesBoss)];


                const nomeBoss = `Eco Sombrio de ${p.nome}`;
                const rankBoss = p.rank;
                const vidaMaxBoss = Math.floor(p.vidaMax * 0.9);
                const danoFisicoBoss = Math.floor(p.currentDanoFisico * 0.8);
                const danoMagicoBoss = Math.floor(p.currentDanoMagico * 0.8);

                game.batalha.desafioBossOriginalStats = {
                    vidaMax: vidaMaxBoss,
                    danoFisico: danoFisicoBoss,
                    danoMagico: danoMagicoBoss,
                    habilidades: habilidadesBoss.map(h => h.id)
                };

                return {
                    nome: nomeBoss,
                    rank: rankBoss,
                    vidaMax: vidaMaxBoss,
                    vidaAtual: vidaMaxBoss,
                    manaMax: Math.floor(p.manaMax * 0.8),
                    manaAtual: Math.floor(p.manaMax * 0.8),
                    danoFisico: danoFisicoBoss,
                    danoMagico: danoMagicoBoss,
                    xpGanho: 50 * (rankToIndex(rankBoss) + 1),
                    fugaPct: 0,
                    isBoss: true,
                    isDesafioClasseBoss: true,
                    habilidades: habilidadesBoss,
                    usaApenasHabilidades: true
                };
            }
            function tentarFugir() {
                if (game.batalha.monstro?.isArquiteto && game.batalha.arquitetoBattleRefused) {
                    mostrarMensagem("Contra o Arquiteto, após recusar sua oferta, apenas sua arma básica responde. Poções, habilidades e fuga são inúteis.");
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    return;
                }
                if (game.batalha.monstro && game.batalha.monstro.isBoss) {
                    mostrarMensagem("Não é possível fugir de uma batalha de chefe!");
                    return;
                }
                game.player.lastDefeatedMonsterInfo = null;
                if (game.player.sombraAtiva) {
                    mostrarMensagem(`Sua ${game.player.sombraAtiva.nomeSombra} recua para as sombras com você.`);
                    game.player.sombraAtiva = null;
                    updateSummonBattleDisplay();
                }

                const chanceFuga = calcularChanceFuga(game.batalha.monstro);
                const sucesso = Math.random() < chanceFuga;

                if (sucesso) {
                    showBattleInterface(false);
                    toggleHeaderNavButtons(false);
                    toggleChatInput(false);
                    game.batalha.emBatalha = false; game.monstroAtual = null;

                    if (game.dungeon.active) {
                        // Esta parte parece correta
                        mostrarMensagem(`Você conseguiu fugir do <span class="font-bold text-rose-400">${game.batalha.monstro.nome}</span> e escapou d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>.`);
                        setTimeout(() => {
                            fugirDaMasmorra(false); // 'false' indica que não foi da porta do chefe
                        }, 1500);
                    } else {
                        mostrarMensagem(`Você tentou fugir e conseguiu escapar do <span class="font-bold text-rose-400">${game.batalha.monstro.nome}</span>!<br/><br/>O que deseja fazer agora?`);
                        abrirInicio();
                    }
                } else {
                    mostrarMensagem(`Você tentou fugir, mas falhou! O <span class="font-bold text-rose-400">${game.batalha.monstro.nome}</span> aproveita para atacar você!`);
                    setTimeout(() => monstroAtaca(), 1000);
                }
                atualizarStatusAtributos();
            } arStatusAtributos();

            function mostrarMenuInvocarSombras() { // Chamada pela HABILIDADE "Invocar Sombra"
    if (!game.batalha.emBatalha || !game.batalha.turnoJogador || game.batalha.jogadorAgiuNoTurno) {
        mostrarMensagem("Não é o momento de gerenciar suas sombras em batalha.");
         // Garante que os botões de ação principais voltem se o menu foi chamado indevidamente
        const battleMainCmds = document.getElementById("battle-main-commands");
        const battleSubmenu = document.getElementById("battle-submenu-choices");
        if (battleMainCmds) battleMainCmds.classList.remove("hidden");
        if (battleSubmenu) battleSubmenu.classList.add("hidden");
        return;
    }

    const skillInvocar = CLASSES_DATA.Necromante.habilidades.find(h => h.id === "n_invocar_sombra");
    const custoManaInvocar = skillInvocar ? calcularGastoMana(skillInvocar) : 10; // Custo base para gerenciar

    if (game.player.manaAtual < custoManaInvocar && !(game.player.sombraAtiva && game.player.recipienteSombras.length === 0)) {
         mostrarMensagem(`Mana insuficiente para gerenciar sombras (${custoManaInvocar} necessário).`);
         const battleMainCmds = document.getElementById("battle-main-commands");
         const battleSubmenu = document.getElementById("battle-submenu-choices");
         if (battleMainCmds) battleMainCmds.classList.remove("hidden");
         if (battleSubmenu) battleSubmenu.classList.add("hidden");
         habilitarBotoesAcaoBatalha(); // Reabilita botões principais
         return;
    }


    mostrarMensagem("Gerenciar Sombras (Ação de Turno):");
    const submenu = document.getElementById("battle-submenu-choices");
    submenu.innerHTML = "";
    submenu.classList.remove("hidden");
    document.getElementById("battle-main-commands")?.classList.add("hidden");

    let algumaAcaoPossivel = false;

    // Opção de guardar a sombra ativa (se houver espaço no recipiente)
    if (game.player.sombraAtiva) {
        const podeGuardar = game.player.recipienteSombras.length < game.player.recipienteCapacity;
        adicionarEscolha(
            `Guardar ${game.player.sombraAtiva.nomeSombra} (Rank ${game.player.sombraAtiva.rankSombra})`,
            () => {
                if (game.player.manaAtual < custoManaInvocar) {
                    mostrarMensagem(`Mana insuficiente (${custoManaInvocar}).`);
                    setTimeout(() => monstroAtaca(), 1000); // Monstro ataca, jogador perdeu chance
                    return;
                }
                game.player.manaAtual -= custoManaInvocar;
                game.player.recipienteSombras.push(game.player.sombraAtiva);
                const nomeSombraGuardada = game.player.sombraAtiva.nomeSombra;
                game.player.sombraAtiva = null;
                mostrarMensagem(`${nomeSombraGuardada} foi guardada. Mana: ${game.player.manaAtual}.`);
                game.batalha.jogadorAgiuNoTurno = true;
                desabilitarBotoesAcaoBatalha();
                updateSummonBattleDisplay();
                updatePlayerBattleDisplay();
                setTimeout(() => monstroAtaca(), 1200);
            },
            !podeGuardar, // Desabilitar se não puder guardar
            podeGuardar ? "Devolve a sombra ativa para o recipiente. Custa mana e o turno." : "Recipiente cheio.",
            "submenu"
        );
        if(podeGuardar) algumaAcaoPossivel = true;
    }

    // Opções para invocar sombras do recipiente (se houver espaço para uma ativa)
    if (game.player.recipienteSombras.length > 0 && (!game.player.sombraAtiva || game.player.maxActiveShadows > 0) ) {
         game.player.recipienteSombras.forEach(sombra => {
            const vidaAtiva = Math.max(1, Math.floor((sombra.statsOriginais?.vidaMax || 20) * 0.5));
            const danoBaseAtivo = Math.max(1, Math.floor((sombra.statsOriginais?.danoFisico || 5) * 0.5));
            const podeInvocar = !game.player.sombraAtiva; // Só pode invocar se não tiver uma ativa (troca é feita guardando primeiro)

            adicionarEscolha(
                `Invocar <span class="math-inline">\{sombra\.nomeSombra\} \(R\:</span>{sombra.rankSombra}) HP:<span class="math-inline">\{vidaAtiva\} Dano\:</span>{danoBaseAtivo}`,
                () => {
                    if (game.player.manaAtual < custoManaInvocar) {
                        mostrarMensagem(`Mana insuficiente (${custoManaInvocar}).`);
                        setTimeout(() => monstroAtaca(), 1000);
                        return;
                    }
                    if (game.player.sombraAtiva) { // Se já tem uma, não deveria chegar aqui por essa opção, mas como segurança
                         mostrarMensagem(`Você já tem uma sombra ativa. Guarde-a primeiro para invocar outra.`);
                         setTimeout(() => monstroAtaca(), 1000); // Perde chance pois tentou ação inválida
                         return;
                    }

                    game.player.manaAtual -= custoManaInvocar;
                    game.player.sombraAtiva = {
                        ...sombra,
                        statsAtuais: { vidaMax: vidaAtiva, vidaAtual: vidaAtiva, danoBase: danoBaseAtivo }
                    };
                    game.player.recipienteSombras = game.player.recipienteSombras.filter(s => s.id !== sombra.id);
                    mostrarMensagem(`${sombra.nomeSombra} foi invocada! Mana: ${game.player.manaAtual}.`);
                    game.batalha.jogadorAgiuNoTurno = true;
                    desabilitarBotoesAcaoBatalha();
                    updateSummonBattleDisplay();
                    updatePlayerBattleDisplay();
                    setTimeout(() => monstroAtaca(), 1200);
                },
                !podeInvocar, // Desabilita se já tem sombra ativa
                podeInvocar ? `Invoca esta sombra. Custa mana e o turno.` : `Guarde a sombra ativa primeiro.`,
                "submenu"
            );
            if(podeInvocar) algumaAcaoPossivel = true;
        });
    }

    if (!algumaAcaoPossivel && !game.player.sombraAtiva && game.player.recipienteSombras.length === 0) {
         const liSemSombras = document.createElement("li");
         liSemSombras.className = "text-slate-400 italic p-2 text-center";
         liSemSombras.textContent = "Nenhuma sombra no recipiente para invocar.";
         submenu.appendChild(liSemSombras);
    }


    adicionarEscolha("<i class='fas fa-arrow-left mr-2'></i>Voltar (Perder Turno se Nenhuma Ação)", () => {
        submenu.innerHTML = "";
        submenu.classList.add("hidden");
        document.getElementById("battle-main-commands")?.classList.remove("hidden");
        if (!game.batalha.jogadorAgiuNoTurno) { // Se o jogador abriu o menu mas não fez nada
            mostrarMensagem(`Você pondera sobre suas sombras, mas decide não agir. O inimigo avança!`);
            game.batalha.jogadorAgiuNoTurno = true; // Consome o turno por hesitação
            desabilitarBotoesAcaoBatalha();
            setTimeout(() => monstroAtaca(), 1200);
        } else {
             // Se já agiu (guardou/invocou), o monstroAtaca já foi chamado
        }
    }, false, "Volta e passa o turno se nenhuma ação de sombra foi tomada.", "submenu");
}


            function atacarMonstro(tipo, skill = null) {
                if (!game.batalha.emBatalha || !game.batalha.monstro) {
                    mostrarMensagem("Não há monstro para atacar.");
                    return;
                }
                if (!game.batalha.turnoJogador || game.batalha.jogadorAgiuNoTurno) {
                    if (game.batalha.jogadorAgiuNoTurno) mostrarMensagem("Você já agiu neste turno.");
                    else mostrarMensagem("Não é seu turno.");
                    return;
                }

                const monstro = game.batalha.monstro;
                let dano = 0;
                let msgPart = "";
                let selfDamageMsg = "";
                let playerDefeatedBySkill = false;
                let mainMsg = "";
                let shadowAttackMsg = "";

                if (tipo === "fisico") { // Ataque físico básico (se implementado separadamente das skills de arma)
                    game.batalha.jogadorAgiuNoTurno = true;
                    desabilitarBotoesAcaoBatalha();
                    dano = calcularDanoFisico();
                    msgPart = "um ataque físico básico"; // Ajuste esta mensagem se necessário
                } else if (tipo === "magico" && skill) {
                    if (skill.efeito?.tipo === "invocar_sombra") {
                        mostrarMenuInvocarSombras(); // Esta função agora é o ponto de entrada para invocar/gerenciar sombras
                        // Não consome o turno principal aqui, o menu de invocação lidará com isso.
                        return;
                    }

                    const gastoMana = calcularGastoMana(skill);
                    if (game.player.manaAtual < gastoMana) {
                        mostrarMensagem(`Você não tem mana suficiente para usar <span class="font-bold text-sky-400">${skill.nome}</span>. Mana necessária: ${gastoMana}.`);
                        // Permite ao jogador escolher outra magia ou voltar
                        document.getElementById("battle-submenu-choices").innerHTML = "";
                        document.getElementById("battle-submenu-choices").classList.add("hidden");
                        document.getElementById("battle-main-commands").classList.remove("hidden");
                        habilitarBotoesAcaoBatalha(); // Reabilita botões principais
                        usarMagiaMenu(); // Reabre o menu de magias
                        return;
                    }
                    game.player.manaAtual -= gastoMana;
                    game.batalha.jogadorAgiuNoTurno = true; // Confirma que o jogador agiu
                    desabilitarBotoesAcaoBatalha(); // Desabilita botões durante a ação

                    msgPart = `a habilidade <span class="font-bold text-sky-400">${skill.nome}</span>`;

                    // Lógica de efeitos da habilidade de classe
                    if (skill.efeito) {
                        switch (skill.efeito.tipo) {
                            case "escape_battle_dungeon":
                                if (game.player.classe === "Necromante" && game.player.isMarcado) {
                                    mostrarMensagem("Com um piscar de sombras, você troca de lugar com um servo distante e escapa ileso!");
                                    game.batalha.emBatalha = false; game.batalha.monstro = null;
                                    if (game.dungeon.active) game.dungeon.active = false;
                                    game.player.activeBuffs = []; showBattleInterface(false);
                                    setTimeout(() => { abrirInicio(); toggleHeaderNavButtons(false); toggleChatInput(false); }, 1500);
                                    dano = 0; return; // Sai da função após escapar
                                } else { msgPart += ", mas o poder da troca falha."; dano = 0; }
                                break;
                            case "critical_strike_conditional":
                                if (game.player.classe === "Necromante" && game.player.isMarcado) {
                                    if (rankToIndex(game.player.rank) > rankToIndex(monstro.rank)) {
                                        dano = Math.floor((game.player.currentDanoFisico + game.player.currentDanoMagico) * 2);
                                        msgPart += ` com um <span class="font-bold text-red-400">Golpe Devastador do Monarca</span>`;
                                    } else {
                                        dano = calcularDanoFisico(); // Dano físico normal se rank não for maior
                                        msgPart += `, mas a aura do inimigo era muito forte. O ataque causa dano físico normal`;
                                    }
                                } else { dano = calcularDanoFisico(); msgPart += ", mas o poder do monarca não fluiu."; }
                                break;
                            case "full_restore":
                                if (game.player.classe === "Necromante" && game.player.isMarcado) {
                                    game.player.vidaAtual = game.player.vidaMax; game.player.manaAtual = game.player.manaMax;
                                    msgPart += ` e <span class="text-emerald-300">restaurou completamente sua Vida e Mana</span>!`;
                                    dano = 0;
                                } else { msgPart += ", mas a energia da recuperação não se manifestou."; dano = 0; }
                                break;
                            case "extracao_sombra":
                                // ... (lógica de extração como no original, garantindo que lastDefeatedMonsterInfo é verificado) ...
                                // Certifique-se que esta ação não prossiga para ataque do monstro imediatamente se for uma ação "fora de combate" no menu.
                                // No contexto de batalha, se for uma skill usada NO TURNO, então o turno do monstro segue.
                                // Se for chamada do menu de início, é diferente.
                                // Para este contexto (dentro de atacarMonstro), é uma ação de turno.
                                if (game.player.lastDefeatedMonsterInfo && !game.player.lastDefeatedMonsterInfo.isBoss) { // Adicionado !isBoss
                                    if (game.player.recipienteSombras.length >= game.player.recipienteCapacity) {
                                        msgPart += `, mas seu Recipiente de Sombras está cheio!`;
                                        game.player.manaAtual += gastoMana; // Devolve mana
                                    } else {
                                        // ... lógica de criar sombra ... (mantida do original)
                                        const lastMonster = game.player.lastDefeatedMonsterInfo;
                                        const newRankIndex = Math.max(0, rankToIndex(lastMonster.rank) - 1);
                                        const shadowRank = indexToRank(newRankIndex);
                                        const shadowId = crypto.randomUUID();
                                        const newShadow = {
                                            id: shadowId, nomeOriginal: lastMonster.nome, nomeSombra: `Sombra de ${lastMonster.nome}`,
                                            rankOriginal: lastMonster.rank, rankSombra: shadowRank,
                                            statsOriginais: { vidaMax: lastMonster.vidaMax, danoFisico: lastMonster.danoFisico, danoMagico: lastMonster.danoMagico }
                                        };
                                        game.player.recipienteSombras.push(newShadow);
                                        msgPart += ` em um ritual profano. Você extraiu a <span class="text-purple-300">${newShadow.nomeSombra} (Rank ${newShadow.rankSombra})</span>!`;
                                        game.player.lastDefeatedMonsterInfo = null;
                                        atualizarRecipienteSombrasTela();
                                    }
                                } else { msgPart += `, mas não havia uma essência elegível para extrair.`; game.player.manaAtual += gastoMana; } // Devolve mana
                                dano = 0;
                                break;
                            case "ataque_exercito_sombras_completo":
                                // ... (lógica do exército como no original) ...
                                if (game.player.recipienteSombras.length === 0 && !game.player.sombraAtiva) {
                                    msgPart += `, mas seu exército não respondeu!`; game.player.manaAtual += gastoMana; dano = 0;
                                } else {
                                    msgPart += `! <span class="text-red-500 font-bold">Um portal sombrio se abre!</span>`;
                                    let danoTotalExercito = 0;
                                    if (game.player.sombraAtiva?.statsAtuais) { /* ... cálculo ... */ danoTotalExercito += Math.max(1, game.player.sombraAtiva.statsAtuais.danoBase + rankToIndex(game.player.sombraAtiva.rankSombra)); }
                                    game.player.recipienteSombras.forEach(s => { /* ... cálculo ... */ danoTotalExercito += Math.max(1, Math.floor((s.statsOriginais.danoFisico || 0) * 0.5) + rankToIndex(s.rankSombra)); });
                                    dano = danoTotalExercito;
                                    msgPart += `<br/>Seu exército de ${game.player.recipienteSombras.length + (game.player.sombraAtiva ? 1 : 0)} sombras ataca!`;
                                }
                                break;
                            case "dano_caotico":
                                // ... (lógica do dano caótico como no original) ...
                                const playerRankIndex = rankToIndex(game.player.rank);
                                const monsterRankIndex = rankToIndex(monstro.rank);
                                const rankDiff = playerRankIndex - monsterRankIndex;
                                if (rankDiff > 0) {
                                    dano = Math.floor((skill.danoBase || 30) * (1 + 0.10 * rankDiff));
                                    msgPart += `. A melodia enfraquece o inimigo!`;
                                } else if (rankDiff === 0) {
                                    dano = Math.floor(monstro.vidaMax * 0.50);
                                    const selfDmg = Math.floor(game.player.vidaMax * 0.30); game.player.vidaAtual -= selfDmg;
                                    selfDamageMsg = ` A canção ressoa, causando <span class="font-bold text-orange-400">${selfDmg}</span> de dano a você!`;
                                    msgPart += `. A canção atinge um equilíbrio caótico!`;
                                } else {
                                    dano = 0; const selfDmgPercentage = 0.35 + (0.05 * Math.abs(rankDiff));
                                    const selfDmg = Math.floor(game.player.vidaMax * selfDmgPercentage); game.player.vidaAtual -= selfDmg;
                                    selfDamageMsg = ` A melodia se volta contra você, causando <span class="font-bold text-orange-400">${selfDmg}</span> de dano!`;
                                    msgPart += `. A canção é suprimida!`;
                                }
                                if (game.player.vidaAtual <= 0) { game.player.vidaAtual = 0; playerDefeatedBySkill = true; }
                                break;
                            case "cura":
                            case "cura_percentual_vida_max":
                                // ... (lógica de cura como no original) ...
                                const curaVal = skill.efeito.tipo === "cura" ? Math.floor(skill.efeito.valor_base + (game.player.atributos.inteligencia * (skill.efeito.escala_inteligencia || 0)))
                                    : Math.floor(game.player.vidaMax * skill.efeito.valor);
                                game.player.vidaAtual = Math.min(game.player.vidaAtual + curaVal, game.player.vidaMax);
                                msgPart += ` e curou <span class="font-bold text-emerald-400">${curaVal}</span> de vida!`;
                                dano = 0;
                                break;
                            case "buff_dano_fisico":
                            case "buff_resistencia":
                            case "buff_dano_sombra_ativa":
                                game.player.activeBuffs = game.player.activeBuffs.filter(b => b.id !== skill.id);
                                game.player.activeBuffs.push({ id: skill.id, nomeSkill: skill.nome, tipo: skill.efeito.tipo, valor: skill.efeito.valor, duracao: skill.efeito.duracao });
                                msgPart += ` e ativou ${skill.nome}!`; atualizarAtributosDerivados(); dano = 0;
                                break;
                            // Adicionar mais casos de efeitos de CLASSE aqui
                            default: // Habilidade de classe com dano mas sem efeito especial listado
                                dano = (skill.tipoDano === "magico") ? calcularDanoMagico(skill) : (skill.danoBase || 0) + Math.floor(game.player.currentDanoFisico * 0.5);
                                break;
                        }
                    } else { // Habilidade de classe sem bloco de 'efeito', puramente dano
                        dano = (skill.tipoDano === "magico") ? calcularDanoMagico(skill) : (skill.danoBase || 0) + Math.floor(game.player.currentDanoFisico * 0.5);
                    }
                } else {
                    mostrarMensagem("Tipo de ataque inválido ou habilidade não fornecida.");
                    habilitarBotoesAcaoBatalha(); // Reabilita se a ação falhou antes de consumir turno
                    return;
                }

                if (dano > 0) monstro.vidaAtual -= dano;
                if (monstro.vidaAtual < 0) monstro.vidaAtual = 0;

                mainMsg = `Você usou ${msgPart}`;
                if (dano > 0) {
                    mainMsg += ` e causou <span class="font-bold text-amber-400">${dano}</span> de dano.`;
                } else if (!(skill && (skill.efeito?.tipo.includes("cura") || skill.efeito?.tipo.startsWith("buff") || skill.efeito?.tipo === "extracao_sombra" || skill.efeito?.tipo === "escape_battle_dungeon"))) {
                    // Não adiciona "não causou dano" para curas/buffs/etc.
                }

                mainMsg += `<br/>Vida do monstro: ${monstro.vidaAtual} / ${monstro.vidaMax}.`;
                if (selfDamageMsg) mainMsg += selfDamageMsg;
                if (tipo === "magico" && skill) mainMsg += `<br/>Mana restante: ${game.player.manaAtual} / ${game.player.manaMax}.`;

                if (game.player.sombraAtiva && monstro.vidaAtual > 0 && !playerDefeatedBySkill && game.player.sombraAtiva.statsAtuais) {
                    const sombra = game.player.sombraAtiva;
                    const danoSombra = Math.max(1, sombra.statsAtuais.danoBase + rankToIndex(sombra.rankSombra));
                    monstro.vidaAtual -= danoSombra;
                    if (monstro.vidaAtual < 0) monstro.vidaAtual = 0;
                    shadowAttackMsg = `<br/>Sua <span class="text-purple-300">${sombra.nomeSombra}</span> ataca, causando <span class="font-bold text-violet-400">${danoSombra}</span> de dano! Vida do monstro: ${monstro.vidaAtual} / ${monstro.vidaMax}.`;
                    mainMsg += shadowAttackMsg;
                }

                if (playerDefeatedBySkill) mainMsg += `<br/><br/><span class="font-bold text-rose-500">Sua própria magia o derrotou!</span>`;

                mostrarMensagem(mainMsg);
                atualizarStatusAtributos();
                updatePlayerBattleDisplay();
                updateEnemyBattleDisplay(monstro);
                updateSummonBattleDisplay();

                // Limpa submenu e mostra comandos principais (se não foi uma ação que já limpou)
                document.getElementById("battle-submenu-choices").innerHTML = "";
                document.getElementById("battle-submenu-choices").classList.add("hidden");
                // document.getElementById("battle-main-commands").classList.remove("hidden"); // Será reabilitado pelo monstroAtaca

                if (playerDefeatedBySkill) {
                    setTimeout(() => { showBattleInterface(false); gameOver(); }, 1500);
                } else if (monstro.vidaAtual <= 0) {
                    setTimeout(() => { showBattleInterface(false); derrotarMonstro(monstro); }, 1200);
                } else {
                    setTimeout(() => monstroAtaca(), 1200);
                }
            }
            function monstroAtaca() {
    if (!game.batalha.emBatalha || !game.batalha.monstro || game.player.vidaAtual <= 0) {
        return;
    }

    game.batalha.turnoJogador = false; // Monstro está agindo
    const monstro = game.batalha.monstro;
    let logMensagens = [];

    // DOT Effects on Monster
    if (monstro.activeDots && monstro.activeDots.length > 0) {
        let danoTotalDot = 0;
        monstro.activeDots = monstro.activeDots.filter(dot => {
            if (dot && typeof dot.danoPorTurno === 'number' && typeof dot.duracao === 'number') {
                const danoDoTAtual = dot.danoPorTurno;
                monstro.vidaAtual -= danoDoTAtual;
                danoTotalDot += danoDoTAtual;
                dot.duracao--;
                logMensagens.push(`<span class="text-orange-400">${monstro.nome} sofre ${danoDoTAtual} de dano de ${dot.nomeSkill || 'efeito contínuo'}!</span>`);
                return dot.duracao > 0;
            }
            return false; // Remove invalid dot objects
        });
        if (monstro.vidaAtual < 0) monstro.vidaAtual = 0;
        if (danoTotalDot > 0) {
             logMensagens.push(`Vida do ${monstro.nome}: ${monstro.vidaAtual} / ${monstro.vidaMax}.`);
        }
        updateEnemyBattleDisplay(monstro);

        if (monstro.vidaAtual <= 0) {
            logMensagens.push(`<br/><span class="font-bold text-emerald-400">${monstro.nome} sucumbiu aos ferimentos contínuos!</span>`);
            mostrarMensagem(logMensagens.join('<br/>'));
            setTimeout(() => {
                showBattleInterface(false); // Esconde a interface de batalha
                derrotarMonstro(monstro);
            }, 1500);
            return;
        }
    }

    // Debuff Durations on Monster
    if (monstro.activeDebuffs && monstro.activeDebuffs.length > 0) {
        monstro.activeDebuffs = monstro.activeDebuffs.filter(debuff => {
            if (debuff && typeof debuff.duracao === 'number') {
                debuff.duracao--;
                if (debuff.duracao <= 0) {
                    logMensagens.push(`<span class="text-sky-300">O efeito de ${debuff.nomeSkill || 'debuff'} em ${monstro.nome} terminou.</span>`);
                    return false;
                }
                return true;
            }
            return false; // Remove invalid debuff objects
        });
    }


    if (monstro.isStunned) {
        logMensagens.push(`<span class="font-bold text-yellow-400">${monstro.nome} está atordoado e não pode atacar!</span>`);
        monstro.stunDuration = (monstro.stunDuration || 1) - 1;
        if (monstro.stunDuration <= 0) {
            monstro.isStunned = false;
            logMensagens.push(`${monstro.nome} não está mais atordoado.`);
        }
    } else {
        let danoMonstroBase = monstro.danoFisico || 0; // Default to 0 if undefined
        let tipoAtaqueMonstroMsg = "um ataque físico";

        // Lógica de Habilidade do Monstro (Ex: Lorde da Morte)
        if (monstro.habilidadesLorde && monstro.habilidadesLorde.length > 0 && Math.random() < 0.5) {
            const skillMonstro = randomChoice(monstro.habilidadesLorde.filter(s => s)); // Filtrar nulos se houver
            if (skillMonstro) {
                const custoManaMonstro = calcularGastoManaParaBoss(skillMonstro, monstro);
                if (!monstro.manaAtual || monstro.manaAtual >= custoManaMonstro) {
                    if (monstro.manaAtual) monstro.manaAtual -= custoManaMonstro;
                    tipoAtaqueMonstroMsg = `a habilidade <span class="font-bold text-red-400">${skillMonstro.nome}</span>`;

                    if (skillMonstro.efeito?.tipo === "lorde_invoca_sombra_copiada" && monstro.copiaRecipienteSombras?.length > 0) {
                        const sombraInvocada = randomChoice(monstro.copiaRecipienteSombras.filter(s => s)); // Filtrar nulos
                        if (sombraInvocada && sombraInvocada.statsOriginais) { // Checar statsOriginais
                            monstro.sombraAtivaCopiada = {
                                ...sombraInvocada,
                                statsAtuais: {
                                    vidaMax: Math.floor(sombraInvocada.statsOriginais.vidaMax * 0.7) || 10,
                                    vidaAtual: Math.floor(sombraInvocada.statsOriginais.vidaMax * 0.7) || 10,
                                    danoBase: Math.floor((sombraInvocada.statsOriginais.danoFisico || 0) * 0.7) || 5
                                }
                            };
                            monstro.copiaRecipienteSombras = monstro.copiaRecipienteSombras.filter(s => s.id !== sombraInvocada.id);
                            logMensagens.push(`O Lorde da Morte comanda uma <span class="text-purple-400">${monstro.sombraAtivaCopiada.nomeSombra}</span> para a batalha!`);
                            danoMonstroBase = 0; // Lorde não ataca diretamente ao invocar
                        }
                    } else if (skillMonstro.efeito?.tipo !== "lorde_invoca_sombra_copiada") {
                         danoMonstroBase = skillMonstro.danoBase || Math.floor((monstro.danoFisico || 0) * (skillMonstro.danoMultiplicador || 1.0));
                    }
                }
            }
        }

        // Ataque da Sombra do Lorde (se ativa)
         if (monstro.sombraAtivaCopiada?.statsAtuais && monstro.sombraAtivaCopiada.statsAtuais.vidaAtual > 0) {
            const sombraCopiada = monstro.sombraAtivaCopiada;
            if (sombraCopiada.statsAtuais.danoBase !== undefined && sombraCopiada.rankSombra !== undefined) {
                const danoSombraLorde = Math.max(1, sombraCopiada.statsAtuais.danoBase + rankToIndex(sombraCopiada.rankSombra));
                const danoRecebidoPelaSombraLorde = calcularDanoRecebido(danoSombraLorde);
                game.player.vidaAtual -= danoRecebidoPelaSombraLorde;
                logMensagens.push(`A <span class="text-purple-400"><span class="math-inline">\{sombraCopiada\.nomeSombra\}</span\> do Lorde ataca, causando <span class\="font\-bold text\-orange\-400"\></span>{danoRecebidoPelaSombraLorde}</span> de dano!`);
                if (game.player.vidaAtual <= 0) {
                    game.player.vidaAtual = 0;
                    updatePlayerBattleDisplay();
                    logMensagens.push(`<br/><span class="font-bold text-rose-500">Você foi derrotado pela sombra do Lorde!</span>`);
                    mostrarMensagem(logMensagens.join('<br/>'));
                    setTimeout(() => {
                        showBattleInterface(false);
                        if (monstro.isLordeDaMorteDesafio) falharDesafioLordeDaMorte();
                        else gameOver();
                    }, 1500);
                    return;
                }
            }
        }

        // Ataque principal do Monstro (se não invocou ou se a invocação não impede ataque direto)
        if (danoMonstroBase > 0) {
            let danoFinalRecebido = calcularDanoRecebido(danoMonstroBase);
            // Aplicar outros modificadores de dano do monstro (debuffs no jogador, etc.) aqui se necessário

            game.player.vidaAtual -= danoFinalRecebido;
            logMensagens.push(`O <span class="font-bold text-rose-400">${monstro.nome}</span> usa <span class="math-inline">\{tipoAtaqueMonstroMsg\} e causa <span class\="font\-bold text\-orange\-400"\></span>{danoFinalRecebido}</span> de dano!`);
        } else if (tipoAtaqueMonstroMsg.includes("habilidade") && !logMensagens.some(msg => msg.includes("Lorde da Morte comanda uma"))) {
            // Se usou habilidade que não causa dano direto e não invocou
             logMensagens.push(`O <span class="font-bold text-rose-400">${monstro.nome}</span> usa ${tipoAtaqueMonstroMsg}!`);
        }


        if (game.player.vidaAtual <= 0) {
            game.player.vidaAtual = 0;
            updatePlayerBattleDisplay();
            logMensagens.push(`<br/><span class="font-bold text-rose-500">Você foi derrotado!</span>`);
            mostrarMensagem(logMensagens.join('<br/>'));
            setTimeout(() => {
                showBattleInterface(false);
                if (game.batalha.isDesafioClasse) falharDesafioHabilidade();
                else if (monstro.isLordeDaMorteDesafio) falharDesafioLordeDaMorte();
                else gameOver();
            }, 1500);
            return;
        }
    }

    decrementarBuffs(); // Decrementa buffs do jogador no final do turno do monstro

    logMensagens.push(`<br/>Sua vez! Vida: <span class="math-inline">\{game\.player\.vidaAtual\}/</span>{game.player.vidaMax}. O que fazer?`);
    mostrarMensagem(logMensagens.join('<br/>'));

    game.batalha.turnoJogador = true;
    game.batalha.jogadorAgiuNoTurno = false; // Reseta para o próximo turno do jogador

    atualizarStatusAtributos(); // Atualiza todas as barras e textos de status
    updatePlayerBattleDisplay();
    updateEnemyBattleDisplay(monstro);
    updateSummonBattleDisplay();

    const mainCommandsDiv = document.getElementById("battle-main-commands");
    const submenuChoicesDiv = document.getElementById("battle-submenu-choices");

    if (mainCommandsDiv) {
        mainCommandsDiv.classList.remove("hidden");
    }
    if (submenuChoicesDiv) {
        submenuChoicesDiv.classList.add("hidden");
        submenuChoicesDiv.innerHTML = ""; // Limpa submenu anterior
    }
    habilitarBotoesAcaoBatalha();
}
            function mostrarHabilidadesArma() {
                if (!game.batalha.emBatalha || !game.batalha.turnoJogador || game.batalha.jogadorAgiuNoTurno) {
                    if (game.batalha.jogadorAgiuNoTurno) mostrarMensagem("Você já agiu neste turno.");
                    return;
                }

                const armaEquipada = game.player.equipamento.arma;
                const tipoArmaKey = armaEquipada ? armaEquipada.subTipoArma : "Nenhuma";
                const dadosArma = TIPOS_DE_ARMAS[tipoArmaKey] || TIPOS_DE_ARMAS["Nenhuma"];

                if (!dadosArma || !dadosArma.habilidades || dadosArma.habilidades.length === 0) {
                    mostrarMensagem("Nenhuma habilidade de arma disponível. Algo deu errado.");
                    return;
                }

                mostrarMensagem(`Escolha uma habilidade para ${dadosArma.nomeDisplay}:`);
                const submenu = document.getElementById("battle-submenu-choices");
                submenu.innerHTML = "";

                dadosArma.habilidades.forEach(habilidade => {
                    let infoHabilidade = `${habilidade.nome} (Mana: ${habilidade.custoMana || 0})`;
                    let tituloDesc = `${habilidade.descricao} Dano: ${Math.floor((habilidade.danoMultiplicador || 1) * 100)}%`;
                    if (habilidade.hits > 1) tituloDesc += ` (${habilidade.hits}x)`;

                    const manaInsuficiente = (habilidade.custoMana || 0) > game.player.manaAtual;
                    let btnTexto = infoHabilidade;
                    if (manaInsuficiente) btnTexto += " (Mana Insuficiente)";

                    adicionarEscolha(
                        btnTexto,
                        () => {
                            executarHabilidadeArma(habilidade, dadosArma.nomeDisplay);
                        },
                        manaInsuficiente,
                        tituloDesc,
                        "submenu"
                    );
                });

                adicionarEscolha("<i class='fas fa-arrow-left mr-2'></i>Voltar", () => {
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    if (game.batalha.emBatalha) mostrarMensagem(`Turno do jogador. O que deseja fazer?`);
                }, false, "Voltar para as ações principais", "submenu");
            }

            function executarHabilidadeArma(habilidade, nomeArmaUsada) {
                if (!game.batalha.emBatalha || !game.batalha.monstro || game.batalha.jogadorAgiuNoTurno) {
                    if (game.batalha.jogadorAgiuNoTurno) {
                        mostrarMensagem("Você já agiu neste turno.");
                    } else {
                        mostrarMensagem("Não é possível usar habilidade de arma agora.");
                    }
                    if (!game.batalha.jogadorAgiuNoTurno) {
                        document.getElementById("battle-submenu-choices").innerHTML = "";
                        document.getElementById("battle-submenu-choices").classList.add("hidden");
                        document.getElementById("battle-main-commands").classList.remove("hidden");
                        habilitarBotoesAcaoBatalha();
                    }
                    return;
                }

                const monstro = game.batalha.monstro;
                let custoMana;

                if (habilidade.custoManaPercent !== undefined) {
                    custoMana = Math.floor(game.player.manaMax * habilidade.custoManaPercent);
                } else {
                    custoMana = habilidade.custoMana || 0;
                }

                if (game.player.manaAtual < custoMana) {
                    mostrarMensagem(`Você não tem mana suficiente para usar ${habilidade.nome}. Mana necessária: ${custoMana}.`);
                    mostrarHabilidadesArma();
                    return;
                }

                game.player.manaAtual -= custoMana;
                game.batalha.jogadorAgiuNoTurno = true;
                desabilitarBotoesAcaoBatalha();

                let danoTotalCausado = 0;
                let logHits = [];
                const numeroDeHits = habilidade.hits || 1;
                let msg = `Você usou <span class="font-bold text-cyan-400">${habilidade.nome}</span> com sua ${nomeArmaUsada}.`;
                let danoAplicadoAoMonstro = true;

                if (habilidade.efeito?.tipo === "damage_percentage_current_hp") {
                    const danoPercentual = Math.floor(monstro.vidaAtual * habilidade.efeito.valor);
                    danoTotalCausado = danoPercentual;
                    logHits.push(danoTotalCausado);
                    msg += ` Uma onda de energia pura engole o inimigo!`;
                } else if (habilidade.efeito?.tipo === "enemy_stun_turns") {
                    monstro.isStunned = true;
                    monstro.stunDuration = (monstro.stunDuration || 0) + habilidade.efeito.duracao;
                    msg += ` O tempo para ao redor do ${monstro.nome} por ${habilidade.efeito.duracao} turno(s)!`;
                    danoAplicadoAoMonstro = false;
                    danoTotalCausado = 0;
                } else {
                    for (let i = 0; i < numeroDeHits; i++) {
                        let danoDoHit;
                        if (habilidade.danoBase !== undefined) {
                            danoDoHit = habilidade.danoBase;
                        } else {
                            let danoBaseJogador = calcularDanoFisico();
                            danoDoHit = Math.floor(danoBaseJogador * (habilidade.danoMultiplicador || 1.0));
                        }
                        if (habilidade.efeito?.tipo === "ignora_defesa_parcial" && monstro.rank !== "S") {
                            danoDoHit = Math.floor(danoDoHit * (1 + (habilidade.efeito.valor || 0.1)));
                        }
                        danoTotalCausado += danoDoHit;
                        logHits.push(danoDoHit);
                    }
                }

                if (danoAplicadoAoMonstro && danoTotalCausado > 0) {
                    monstro.vidaAtual -= danoTotalCausado;
                    if (monstro.vidaAtual < 0) monstro.vidaAtual = 0;
                }

                if (habilidade.efeito?.tipo === "damage_percentage_current_hp") {
                    msg += ` Causou <span class="font-bold text-amber-400">${danoTotalCausado}</span> de dano (${(habilidade.efeito.valor * 100).toFixed(0)}% da vida atual).`;
                } else if (habilidade.efeito?.tipo === "enemy_stun_turns") {
                    // Mensagem já adicionada
                } else if (numeroDeHits > 1) {
                    msg += ` Atingiu ${numeroDeHits} vezes, causando ${logHits.join(' + ')} = <span class="font-bold text-amber-400">${danoTotalCausado}</span> de dano.`;
                } else if (danoTotalCausado > 0) {
                    msg += ` Causou <span class="font-bold text-amber-400">${danoTotalCausado}</span> de dano.`;
                } else if (!danoAplicadoAoMonstro) {
                    // Mensagem já tratada (ex: stun)
                } else {
                    msg += ` Mas não causou dano direto.`;
                }

                if (habilidade.efeito && habilidade.efeito.tipo !== "damage_percentage_current_hp" && habilidade.efeito.tipo !== "enemy_stun_turns") {
                    if (habilidade.efeito.tipo === "debuff_defesa_inimigo") {
                        if (!monstro.activeDebuffs) monstro.activeDebuffs = [];
                        monstro.activeDebuffs = monstro.activeDebuffs.filter(d => d.id !== habilidade.id);
                        monstro.activeDebuffs.push({ id: habilidade.id, tipo: "debuff_defesa_inimigo", valor: habilidade.efeito.valor, duracao: habilidade.efeito.duracao, nomeSkill: habilidade.nome });
                        msg += ` A defesa do inimigo foi reduzida!`;
                    }
                    // Adicionar outros 'else if' para mais tipos de efeitos de arma aqui
                }

                msg += `<br/>Vida do <span class="font-bold text-rose-400">${monstro.nome}</span>: ${monstro.vidaAtual} / ${monstro.vidaMax}.`;
                if (custoMana > 0) {
                    msg += `<br/>Mana restante: ${game.player.manaAtual} / ${game.player.manaMax}.`;
                }

                let shadowAttackMsg = "";
                if (game.player.sombraAtiva && monstro.vidaAtual > 0 && game.player.sombraAtiva.statsAtuais) {
                    const sombra = game.player.sombraAtiva;
                    const danoSombra = Math.max(1, sombra.statsAtuais.danoBase + rankToIndex(sombra.rankSombra));
                    monstro.vidaAtual -= danoSombra;
                    if (monstro.vidaAtual < 0) monstro.vidaAtual = 0;
                    shadowAttackMsg = `<br/>Sua <span class="text-purple-300">${sombra.nomeSombra}</span> ataca, causando <span class="font-bold text-violet-400">${danoSombra}</span> de dano! Vida do monstro: ${monstro.vidaAtual} / ${monstro.vidaMax}.`;
                    msg += shadowAttackMsg;
                }

                mostrarMensagem(msg);
                atualizarStatusAtributos();
                updatePlayerBattleDisplay();
                updateEnemyBattleDisplay(monstro);
                updateSummonBattleDisplay();

                document.getElementById("battle-submenu-choices").innerHTML = "";
                document.getElementById("battle-submenu-choices").classList.add("hidden");

                if (monstro.vidaAtual <= 0) {
                    setTimeout(() => {
                        try {
                            showBattleInterface(false);
                            derrotarMonstro(monstro);
                        } catch (e) {
                            console.error("Erro ao finalizar batalha (executarHabilidadeArma):", e);
                            mostrarMensagem("Erro crítico ao finalizar batalha: " + e.message + ". Tente recarregar.");
                        }
                    }, 1500);
                } else {
                    setTimeout(() => monstroAtaca(), 1500);
                }
            }
        
            function derrotarMonstro(monstro) {
                const eraDesafioClasseVencido = game.batalha.isDesafioClasse && monstro.isDesafioClasseBoss;
                const skillDesafioIdVencida = game.batalha.skillEmDesafioId;
                const eraLordeDeDesafioVencido = monstro.isLordeDaMorteDesafio;
                const tipoDesafioLordeOriginalVencido = game.batalha.tipoDesafioLorde;

                try {
                    showBattleInterface(false);
                } catch (e) {
                    console.error("Erro em showBattleInterface dentro de derrotarMonstro:", e);
                }

                game.batalha.emBatalha = false;
                game.batalha.isDesafioClasse = false;
                game.batalha.skillEmDesafioId = null;
                game.batalha.desafioBossOriginalStats = null;
                game.batalha.tipoDesafioLorde = null;
                game.batalha.isBossBattle = false;

                if (game.player.classe === "Necromante" &&
                    !monstro.isBoss &&
                    !eraDesafioClasseVencido &&
                    !eraLordeDeDesafioVencido &&
                    game.player.magiasAdquiridas.includes("n_extracao_sombras")) {
                    game.player.lastDefeatedMonsterInfo = {
                        nome: monstro.nome, rank: monstro.rank,
                        vidaMax: monstro.vidaMax, danoFisico: monstro.danoFisico, danoMagico: monstro.danoMagico,
                        isBoss: monstro.isBoss
                    };
                } else {
                    game.player.lastDefeatedMonsterInfo = null;
                }
                if (game.player.sombraAtiva) game.player.sombraAtiva = null;

                let xpGanhoBase = monstro.xpGanho;

                if (monstro.isBoss && !eraDesafioClasseVencido && !eraLordeDeDesafioVencido) {
                    const isFixedXpBoss = monstro.isMonarchBoss || monstro.isArquiteto || (monstro.isLordeDaMorte && !monstro.isLordeDaMorteDesafio);
                    if (isFixedXpBoss) {
                        xpGanhoBase *= 2;
                    }
                }

                let xpFinal = Math.floor(xpGanhoBase * (1 + game.player.xpBonus));
                if (game.player.isMarcado) {
                    xpFinal *= 2;
                }
                game.player.xp += xpFinal;

                let moedasGanhas = 0;
                if (!eraDesafioClasseVencido && !eraLordeDeDesafioVencido) {
                    moedasGanhas = randomInt(5, 20) * (rankToIndex(monstro.rank) + 1) * (monstro.isBoss ? 5 : 1);
                    game.player.moedas += moedasGanhas;
                }

                for (const attr in game.player.atributos) {
                    game.player.atributos[attr] = +(game.player.atributos[attr] + 0.1).toFixed(1);
                }
                game.player.vidaAtual = Math.min(game.player.vidaAtual + Math.floor(game.player.vidaMax * 0.3), game.player.vidaMax);
                game.player.manaAtual = Math.min(game.player.manaAtual + Math.floor(game.player.manaMax * 0.3), game.player.manaMax);
                game.player.activeBuffs = [];

                let itensDropadosParaMensagem = [];
                if (!eraDesafioClasseVencido && !eraLordeDeDesafioVencido) {
                    const dropChance = monstro.isBoss ? 1.0 : 0.7;
                    if (Math.random() < dropChance) {
                        const numeroDeItensADropar = monstro.isBoss ? 3 : 1;
                        const rankIndexMonstroBase = rankToIndex(monstro.rank);

                        for (let i = 0; i < numeroDeItensADropar; i++) {
                            let itemRankForDropIndex = rankIndexMonstroBase;
                            if (!monstro.isBoss) {
                                const roll = Math.random();
                                if (roll < 0.15) itemRankForDropIndex = Math.min(RANKS.length - 1, rankIndexMonstroBase + 1);
                                else if (roll < 0.70) itemRankForDropIndex = rankIndexMonstroBase;
                                else itemRankForDropIndex = Math.max(0, rankIndexMonstroBase - 1);
                            } else {
                                const bossItemRoll = Math.random();
                                if (bossItemRoll < 0.20 && rankIndexMonstroBase > 0) itemRankForDropIndex = rankIndexMonstroBase - 1;
                                else if (bossItemRoll < 0.60 && rankIndexMonstroBase < RANKS.length - 1) itemRankForDropIndex = rankIndexMonstroBase + 1;
                            }
                            itemRankForDropIndex = clamp(itemRankForDropIndex, 0, RANKS.length - 1);
                            const rankDoItemGerado = indexToRank(itemRankForDropIndex);

                            let monstroPermiteDropAtomicFlag = false;
                            if (rankToIndex(monstro.rank) >= rankToIndex("S")) {
                                monstroPermiteDropAtomicFlag = true;
                            }
                            if (monstro.isBoss && (monstro.rank === "SSS" || monstro.isMonarchBoss) && Math.random() < 0.1) {
                                monstroPermiteDropAtomicFlag = true;
                            }

                            const itemGerado = gerarItem(rankDoItemGerado, monstroPermiteDropAtomicFlag);
                            if (itemGerado) {
                                if (itemGerado.isUnique && game.player.inventario.some(invItem => invItem.id === itemGerado.id || invItem.nome === itemGerado.nome)) {
                                    continue;
                                }
                                addItemToInventory(itemGerado);
                                itensDropadosParaMensagem.push(`${itemGerado.nome} (Rank ${itemGerado.rank})`);
                            }
                        }
                    }
                }

                let leveledUp = false;
                let levelUpMessages = [];
                while (game.player.xp >= game.player.xpProximoNivel) {
                    leveledUp = true; game.player.xp -= game.player.xpProximoNivel; game.player.nivel++;
                    game.player.pontosDistribuir += 5;
                    for (const attr in game.player.atributos) { game.player.atributos[attr] = +(game.player.atributos[attr] + 1).toFixed(1); }
                    levelUpMessages.push(`Você subiu para o nível <span class="font-bold text-emerald-400">${game.player.nivel}</span>, ganhou 5 pontos para distribuir e +1 em todos os atributos!`);
                    game.player.xpProximoNivel = Math.floor(game.player.xpProximoNivel * 1.10);
                    atualizarMercadorVisibilidade();
                    atualizarRank();
                    const novasSkillsMsgs = verificarDesbloqueioHabilidadesClasse();
                    levelUpMessages = levelUpMessages.concat(novasSkillsMsgs);
                }
                atualizarAtributosDerivados();

                let msgVitoria = `Você derrotou o <span class="font-bold text-rose-400">${monstro.nome}</span>!`;
                if (!eraDesafioClasseVencido && !eraLordeDeDesafioVencido) {
                    msgVitoria += `<br/>Ganhou <span class="font-bold text-amber-400">${xpFinal} XP</span>${game.player.isMarcado ? " (Dobrado!)" : ""} e <span class="font-bold text-amber-300">${moedasGanhas}</span> moedas.`;
                } else {
                    msgVitoria += `<br/>Ganhou <span class="font-bold text-amber-400">${xpFinal} XP</span>${game.player.isMarcado ? " (Dobrado!)" : ""} pela vitória no desafio.`;
                }

                if (itensDropadosParaMensagem.length > 0) {
                    msgVitoria += `<br/><br/><span class="font-semibold text-amber-300">${monstro.isBoss ? "O Chefe deixou cair os seguintes tesouros:" : "O monstro deixou cair:"}</span>`;
                    itensDropadosParaMensagem.forEach(nomeItem => {
                        msgVitoria += `<br/>- <span class="font-bold text-sky-400">${nomeItem}</span>`;
                    });
                } else if (monstro.isBoss && !eraDesafioClasseVencido && !eraLordeDeDesafioVencido && !game.dungeon.active) {
                    msgVitoria += `<br/><br/>O Chefe não deixou cair nenhum item utilizável desta vez.`;
                }

                if (levelUpMessages.length > 0) msgVitoria += "<br/><br/>" + levelUpMessages.join("<br/>");

                if (monstro.isLordeDaMorte && !eraLordeDeDesafioVencido) {
                    if (tentarDesbloquearNecromante(monstro)) {
                        const necroUnlockMsgElement = document.getElementById("story-text");
                        const necroUnlockMsg = necroUnlockMsgElement ? necroUnlockMsgElement.innerHTML : "";
                        mostrarMensagem(msgVitoria + "<hr class='my-2 border-slate-600'>" + necroUnlockMsg);
                        return;
                    }
                }

                if (eraLordeDeDesafioVencido && skillDesafioIdVencida) {
                    const skillAprendidaObj = CLASSES_DATA.Necromante.habilidades.find(h => h.id === skillDesafioIdVencida);
                    if (skillAprendidaObj) {
                        if (!game.player.magiasAdquiridas.includes(skillDesafioIdVencida)) game.player.magiasAdquiridas.push(skillDesafioIdVencida);
                        msgVitoria += `<br/><br/><span class="font-bold text-yellow-300 animate-ping">PODER DESBLOQUEADO!</span> Você superou o Lorde da Morte (${tipoDesafioLordeOriginalVencido === "lorde_dominio" ? "Desafio de Domínio" : "Desafio de Exército"}) e dominou <span class="font-bold text-sky-300">${skillAprendidaObj.nome}</span>!`;
                        if (game.player.magiasEquipadas.length < 4 && !game.player.magiasEquipadas.includes(skillDesafioIdVencida)) {
                            game.player.magiasEquipadas.push(skillDesafioIdVencida);
                            msgVitoria += ` A habilidade foi equipada automaticamente.`;
                        }
                    } else {
                        msgVitoria += `<br/><br/><span class="font-bold text-yellow-300">VITÓRIA SOBRE O LORDE!</span> Você sente seu domínio sobre as sombras se aprofundar!`;
                    }
                    mostrarMensagem(msgVitoria + "<br/><br/>Você retorna fortalecido. O que deseja fazer?");
                    limparEscolhas();
                    adicionarEscolha("Ver Habilidades", abrirSkills);
                    adicionarEscolha("Continuar Aventura", abrirInicio);
                    atualizarStatusAtributos(); atualizarSkillsTela(); toggleHeaderNavButtons(false); toggleChatInput(false); updateGoogleSignInUI();
                    return;
                }

                if (eraDesafioClasseVencido && skillDesafioIdVencida) {
                    const skillAprendidaObj = CLASSES_DATA[game.player.classe]?.habilidades.find(h => h.id === skillDesafioIdVencida);
                    if (skillAprendidaObj) {
                        if (!game.player.magiasAdquiridas.includes(skillDesafioIdVencida)) game.player.magiasAdquiridas.push(skillDesafioIdVencida);
                        msgVitoria += `<br/><br/><span class="font-bold text-green-400">Desafio Concluído!</span> Você dominou <span class="font-bold text-sky-400">${skillAprendidaObj.nome}</span>!`;
                        if (game.player.magiasEquipadas.length < 4 && !game.player.magiasEquipadas.includes(skillDesafioIdVencida)) {
                            game.player.magiasEquipadas.push(skillDesafioIdVencida);
                            msgVitoria += ` Equipada automaticamente.`;
                        }
                    } else {
                        msgVitoria += `<br/><br/><span class="font-bold text-green-400">Desafio Concluído!</span> Você sente um novo poder despertar!`;
                    }
                    mostrarMensagem(msgVitoria + "<br/><br/>Você retorna fortalecido. O que deseja fazer?");
                    limparEscolhas();
                    adicionarEscolha("Ver Habilidades", abrirSkills);
                    adicionarEscolha("Continuar Aventura", abrirInicio);
                    atualizarStatusAtributos(); atualizarSkillsTela(); toggleHeaderNavButtons(false); toggleChatInput(false); updateGoogleSignInUI();
                    return;
                }

                if (!game.player.classe && atribuirClasseAleatoriaSeNecessario()) {
                    const classAssignMsgElement = document.getElementById("story-text");
                    const classAssignMsg = classAssignMsgElement ? classAssignMsgElement.innerHTML : "";
                    mostrarMensagem(msgVitoria + "<hr class='my-2 border-slate-600'>" + classAssignMsg);
                    atualizarStatusAtributos();
                    atualizarSkillsTela();
                    return;
                }

                if (game.dungeon.active) {
                    if (monstro.isBoss) {
                        if (rankToIndex(game.dungeon.typeRank) >= rankToIndex("B") && Math.random() < 0.10 && !monstro.isMonarchBoss && !monstro.isArquiteto) {
                            const monarchBoss = gerarMonarcaAleatorio();
                            if (monarchBoss) {
                                msgVitoria += `<br/><br/><span class="font-extrabold text-yellow-300 animate-pulse">MAS ESPERE!</span> Assim que você pensou que a masmorra estava limpa, uma presença avassaladora emerge das ruínas do chefe derrotado! O <span class="font-bold text-red-500">${monarchBoss.nome}</span> está aqui!`;
                                mostrarMensagem(msgVitoria);
                                game.monstroAtual = monarchBoss;
                                game.dungeon.bossDefeated = true;
                                game.estado = "batalha";
                                setTimeout(() => {
                                    toggleHeaderNavButtons(true); toggleChatInput(true);
                                    iniciarBatalha(monarchBoss);
                                }, 3500);
                                updateGoogleSignInUI(); atualizarStatusAtributos();
                                return;
                            }
                        }
                        completarMasmorra(msgVitoria);
                        return;
                    } else {
                        msgVitoria += `<br/><br/>Você avança para a próxima sala da masmorra...`;
                        mostrarMensagem(msgVitoria);
                        atualizarStatusAtributos();
                        setTimeout(() => { game.dungeon.currentRoom++; avancarSalaMasmorra(); }, 2000);
                        return;
                    }
                }

                toggleHeaderNavButtons(false);
                toggleChatInput(false);

                if (leveledUp) {
                    msgVitoria += `<br/><br/>Você tem ${game.player.pontosDistribuir} pontos de atributo para distribuir.`;
                }
                if (game.player.lastDefeatedMonsterInfo && game.player.classe === "Necromante" && game.player.magiasAdquiridas.includes("n_extracao_sombras") && !game.player.lastDefeatedMonsterInfo.isBoss) {
                    msgVitoria += `<br/><br/><span class="text-purple-300">Você sente a essência do ${game.player.lastDefeatedMonsterInfo.nome} pronta para ser extraída...</span>`;
                }

                mostrarMensagem(msgVitoria + "<br/><br/>Retornando à exploração da área...");

                atualizarStatusAtributos();
                atualizarSkillsTela();
                updateGoogleSignInUI();

                setTimeout(() => {
                    try {
                        showBattleInterface(false);
                        if (game.dungeon.active) {

                        } else {
                            abrirInicio();
                        }
                    } catch (e) {
                        console.error("Erro crítico ao tentar retornar à exploração após derrotar monstro (final timeout):", e);
                        mostrarMensagem("ERRO CRÍTICO AO FINALIZAR. Por favor, recarregue a página. Detalhes: " + e.message);
                    }
                }, 3000);
            }

            function usarMagiaMenu() {
                if (game.batalha.monstro?.isArquiteto && game.batalha.arquitetoBattleRefused) {
                    mostrarMensagem("Contra o Arquiteto, após recusar sua oferta, apenas sua arma básica responde. Poções, habilidades e fuga são inúteis.");

                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    return;
                }
                if (game.batalha.tipoDesafioLorde === "lorde_exercito") {
                    mostrarMensagem("Suas habilidades de classe estão seladas neste desafio! Use sua arma.");
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    habilitarBotoesAcaoBatalha();
                    return;
                }
                if (!game.player.classe) {
                    mostrarMensagem("Você precisa de uma classe para usar habilidades!");
                    return;
                }
                const classeAtualData = CLASSES_DATA[game.player.classe];
                if (!classeAtualData) { mostrarMensagem("Erro: Dados da classe não encontrados."); return; }

                const magiasEquipadasDetalhes = game.player.magiasEquipadas
                    .map(id => classeAtualData.habilidades.find(h => h.id === id))
                    .filter(Boolean);

                if (magiasEquipadasDetalhes.length === 0) {
                    mostrarMensagem("Você não tem habilidades de classe equipadas.");
                    return;
                }

                mostrarMensagem("Escolha a habilidade para usar:");
                const submenu = document.getElementById("battle-submenu-choices");
                submenu.innerHTML = "";

                magiasEquipadasDetalhes.forEach(skill => {
                    let skillInfo = `${skill.nome} (Rank ${skill.rank})`;
                    let effectDetails = [];
                    if (skill.danoBase) effectDetails.push(`Dano Base: ${skill.danoBase}`);
                    if (skill.efeito?.tipo === "cura_percentual_vida_max") effectDetails.push(`Cura: ${skill.efeito.valor * 100}% Max Vida`);
                    if (skill.efeito?.tipo === "extracao_sombra") {
                        effectDetails.push(game.player.lastDefeatedMonsterInfo ? `Alvo: ${game.player.lastDefeatedMonsterInfo.nome}` : `Nenhum alvo`);
                    }
                    if (skill.efeito?.tipo === "ataque_exercito_sombras_completo") effectDetails.push(`Ataque de Exército`);

                    const custoMana = calcularGastoMana(skill);
                    skillInfo += ` - Mana: ${custoMana}`;
                    let titleText = skill.descricao;
                    if (effectDetails.length > 0) titleText += " | " + effectDetails.join("; ");

                    let isDisabled = game.player.manaAtual < custoMana;

                    if (skill.efeito?.tipo === "extracao_sombra" && !game.player.lastDefeatedMonsterInfo) {
                        isDisabled = true;
                        skillInfo += " (Sem Alvo)";
                    }
                    if (skill.efeito?.tipo === "ataque_exercito_sombras_completo" && (game.player.recipienteSombras.length === 0 && !game.player.sombraAtiva)) {
                        isDisabled = true;
                        skillInfo += " (Sem Sombras)";
                    }


                    if (skill.efeito?.tipo === "invocar_sombra") {

                        const hasAnyShadowsToManage = game.player.sombraAtiva || game.player.recipienteSombras.length > 0;


                        if (!game.player.metLordeDaMorte && (skill.id === "n_extracao_sombras" || skill.id === "n_invocar_sombra")) {
                            isDisabled = true;
                            skillInfo += " (Requer Lorde da Morte)";
                        } else if (!hasAnyShadowsToManage) {

                            isDisabled = true;
                            skillInfo += " (Recipiente Vazio)";
                        }


                        const displayCost = 10;
                        skillInfo = `${skill.nome} (Rank ${skill.rank}) - Mana: ${displayCost}`;
                        if (isDisabled) {
                            skillInfo += " (Não Disponível)";
                        }

                        adicionarEscolha(skillInfo, () => {

                            mostrarMenuInvocarSombras();

                        }, isDisabled, titleText, "submenu");

                    } else {

                        adicionarEscolha(skillInfo, () => {
                            atacarMonstro("magico", skill);
                            document.getElementById("battle-submenu-choices").innerHTML = "";
                            document.getElementById("battle-submenu-choices").classList.add("hidden");
                            document.getElementById("battle-main-commands").classList.remove("hidden");
                        }, isDisabled, titleText, "submenu");
                    }
                });
                adicionarEscolha("<i class='fas fa-arrow-left mr-2'></i>Voltar", () => {
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    if (game.batalha.emBatalha) mostrarMensagem(`Turno do jogador. O que deseja fazer?`);
                }, false, "Voltar para as ações principais", "submenu");
            }

            function usarPocaoMenu() {
                console.log("usarPocaoMenu called. In battle:", game.batalha.emBatalha, "Player's turn:", game.batalha.turnoJogador, "Player acted:", game.batalha.jogadorAgiuNoTurno);

                if (game.batalha.monstro?.isArquiteto && game.batalha.arquitetoBattleRefused) {
                    mostrarMensagem("Contra o Arquiteto, após recusar sua oferta, apenas sua arma básica responde. Poções, habilidades e fuga são inúteis.");
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    return;
                }
                if (game.batalha.tipoDesafioLorde === "lorde_exercito") {
                    mostrarMensagem("Poções estão seladas neste desafio!");
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    habilitarBotoesAcaoBatalha();
                    return;
                }

                const monstroAtual = game.batalha.monstro;
                // For normal monsters, game.batalha.isBossBattle is FALSE,
                // so this entire 'if' block (and its 'return') should be SKIPPED.
                if (game.batalha.isBossBattle &&
                    !(monstroAtual && (monstroAtual.isLordeDaMorte || monstroAtual.isLordeDaMorteDesafio || monstroAtual.isArquiteto))) {
                    mostrarMensagem("Não é possível usar poções durante esta batalha de chefe (exceto Lorde da Morte ou Arquiteto)!");
                    return;
                }

                const pocaoItens = game.player.inventario.filter(i => i.isPotion && i.quantity > 0);
                if (pocaoItens.length === 0) {
                    mostrarMensagem("Você não tem poções no inventário.");
                    // Ensure main commands are re-enabled if submenu was opened then closed due to no items
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    habilitarBotoesAcaoBatalha();
                    return;
                }

                mostrarMensagem("Escolha a poção para usar:");
                const submenu = document.getElementById("battle-submenu-choices");
                submenu.innerHTML = ""; // Clear existing submenu choices

                pocaoItens.forEach(pocaoStack => {
                    adicionarEscolha(
                        `${pocaoStack.nome} (x${pocaoStack.quantity})`,
                        () => { // Potion button's callback
                            console.log("Potion button clicked for:", pocaoStack.nome); // DEBUG
                            usarPocao(pocaoStack);
                            // UI cleanup is handled by the callback in adicionarEscolha for the potion button
                            document.getElementById("battle-submenu-choices").innerHTML = "";
                            document.getElementById("battle-submenu-choices").classList.add("hidden");
                            document.getElementById("battle-main-commands").classList.remove("hidden");
                            // Note: monstroAtaca() will eventually call habilitarBotoesAcaoBatalha()
                        },
                        false, // Explicitly enabled
                        pocaoStack.descricao,
                        "submenu"
                    );
                });

                adicionarEscolha("<i class='fas fa-arrow-left mr-2'></i>Voltar", () => {
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    if (game.batalha.emBatalha) mostrarMensagem(`Turno do jogador. O que deseja fazer?`);
                    habilitarBotoesAcaoBatalha();
                }, false, "Voltar para as ações principais", "submenu");
            }

            // Function to actually use a potion
            function usarPocao(item) {
                console.log("usarPocao called with item:", item?.nome, ". Player acted:", game.batalha.jogadorAgiuNoTurno, "Is Boss Battle:", game.batalha.isBossBattle); // DEBUG

                if (!game.batalha.emBatalha || !game.batalha.turnoJogador || game.batalha.jogadorAgiuNoTurno) {
                    if (game.batalha.jogadorAgiuNoTurno) mostrarMensagem("Você já agiu neste turno.");
                    else mostrarMensagem("Não é possível usar poção agora.");
                    return;
                }

                const monstroAtual = game.batalha.monstro;
                // This check is redundant if usarPocaoMenu already did it, but safe.
                // For normal monsters, game.batalha.isBossBattle is FALSE, so this is skipped.
                if (game.batalha.isBossBattle &&
                    !(monstroAtual && (monstroAtual.isLordeDaMorte || monstroAtual.isLordeDaMorteDesafio || monstroAtual.isArquiteto))) {
                    mostrarMensagem("Não é possível usar poções durante esta batalha de chefe!");
                    // UI cleanup similar to usarPocaoMenu's early return
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    habilitarBotoesAcaoBatalha();
                    return;
                }

                const pocaoIndex = game.player.inventario.findIndex(invItem => invItem.id === item.id && invItem.isPotion);
                if (pocaoIndex === -1 || game.player.inventario[pocaoIndex].quantity <= 0) {
                    mostrarMensagem("Poção não encontrada ou sem quantidade.");
                    document.getElementById("battle-submenu-choices").innerHTML = "";
                    document.getElementById("battle-submenu-choices").classList.add("hidden");
                    document.getElementById("battle-main-commands").classList.remove("hidden");
                    habilitarBotoesAcaoBatalha();
                    return;
                }

                const pocao = game.player.inventario[pocaoIndex];
                let curaVida = 0;
                let curaMana = 0;
                let msg = `Você usou <span class="font-bold text-emerald-400">${pocao.nome}</span>.`;

                if (pocao.curaVidaPct) {
                    curaVida = Math.floor(game.player.vidaMax * pocao.curaVidaPct);
                    game.player.vidaAtual = Math.min(game.player.vidaMax, game.player.vidaAtual + curaVida);
                    if (curaVida > 0) msg += ` Recuperou <span class="font-bold text-green-400">${curaVida}</span> de Vida.`;
                }
                if (pocao.curaManaPct) {
                    curaMana = Math.floor(game.player.manaMax * pocao.curaManaPct);
                    game.player.manaAtual = Math.min(game.player.manaMax, game.player.manaAtual + curaMana);
                    if (curaMana > 0) msg += ` Recuperou <span class="font-bold text-blue-400">${curaMana}</span> de Mana.`;
                }

                pocao.quantity--;
                if (pocao.quantity <= 0) {
                    game.player.inventario.splice(pocaoIndex, 1);
                }

                msg += `<br/>Vida: ${game.player.vidaAtual}/${game.player.vidaMax}. Mana: ${game.player.manaAtual}/${game.player.manaMax}.`;
                mostrarMensagem(msg);

                game.batalha.jogadorAgiuNoTurno = true;
                desabilitarBotoesAcaoBatalha(); // Main action buttons disabled for this turn

                atualizarInventarioTela();
                updatePlayerBattleDisplay();

                // The monster will attack after the player's action
                setTimeout(() => monstroAtaca(), 1200);
            }
            

            function habilitarBotoesAcaoBatalha() {
                const btnUsarArma = document.getElementById("btn-battle-fight");
                const btnSkill = document.getElementById("btn-battle-skill");
                const btnItem = document.getElementById("btn-battle-item");
                const btnEscape = document.getElementById("btn-battle-escape");

                if (btnUsarArma) btnUsarArma.removeAttribute("disabled");
                if (btnSkill) btnSkill.removeAttribute("disabled");
                if (btnItem) btnItem.removeAttribute("disabled");
                if (btnEscape) btnEscape.removeAttribute("disabled");

                const monstro = game.batalha.monstro;
                const isArquitetoRefused = monstro?.isArquiteto && game.batalha.arquitetoBattleRefused;
                const isDesafioExercito = game.batalha.tipoDesafioLorde === "lorde_exercito";

                if (btnUsarArma) {
                    btnUsarArma.disabled = false;
                    if (isArquitetoRefused && game.player.equipamento.arma?.subTipoArma !== "Atomic") {
                        if (TIPOS_DE_ARMAS[game.player.equipamento.arma?.subTipoArma || "Nenhuma"]?.nomeDisplay !== "Desarmado") {
                            btnUsarArma.disabled = true;
                        }
                    }
                }

                if (btnSkill) {
                    const temClasse = !!game.player.classe;
                    const temSkillsEquipadas = game.player.magiasEquipadas && game.player.magiasEquipadas.length > 0;
                    btnSkill.disabled = isArquitetoRefused || isDesafioExercito || !(temClasse && temSkillsEquipadas);
                }

                if (btnItem) {
                    const temPocoes = game.player.inventario.some(i => i.isPotion && i.quantity > 0);
                    const podeUsarPocaoContraBossAtual = monstro && (monstro.isLordeDaMorte || !monstro.isBoss || monstro.isLordeDaMorteDesafio || monstro.isArquiteto);
                    btnItem.disabled = isArquitetoRefused || isDesafioExercito || !temPocoes || (monstro?.isBoss && !podeUsarPocaoContraBossAtual);
                }

                if (btnEscape) {
                    let naoPodeFugir = false;
                    if (monstro) {
                        naoPodeFugir = monstro.isBoss || monstro.isLordeDaMorteDesafio || monstro.isMonarchBoss;
                    }
                    if (isArquitetoRefused) naoPodeFugir = true;

                    const temTrocaSombras = game.player.magiasEquipadas.includes("ms_troca_sombras") &&
                        game.player.classe === "Necromante" &&
                        game.player.isMarcado;

                    btnEscape.disabled = naoPodeFugir && !temTrocaSombras;
                }
            }

            function desabilitarBotoesAcaoBatalha() {
                document.getElementById("btn-battle-fight")?.setAttribute("disabled", "true");
                document.getElementById("btn-battle-skill")?.setAttribute("disabled", "true");
                document.getElementById("btn-battle-item")?.setAttribute("disabled", "true");
                document.getElementById("btn-battle-escape")?.setAttribute("disabled", "true");
            }




            function gameOver() {
    showBattleInterface(false);
    toggleHeaderNavButtons(true); // Desabilita navegação durante game over
    toggleChatInput(true);     // Desabilita chat
    game.estado = "gameover";

    // Limpa estados de masmorra e batalha
    if (game.dungeon.active) {
        game.dungeon.active = false;
    }
    game.batalha.emBatalha = false;
    game.batalha.isBossBattle = false; // Garante que não está em batalha de chefe
    game.batalha.isDesafioClasse = false; // Garante que não está em desafio
    game.batalha.tipoDesafioLorde = null;


    // Só deleta o save da nuvem se não for uma falha em desafio específico
    // que tem sua própria lógica de "penalidade" sem apagar tudo.
    // A lógica de falha em desafio já deve ter sido tratada ANTES de chamar gameOver,
    // se gameOver for chamado após uma falha de desafio, é um erro lógico.
    // Para uma morte "normal", o save é deletado.
    if (currentFirebaseUser && !game.batalha.skillEmDesafioId && !game.batalha.tipoDesafioLorde) {
        // Adicionado log para ter certeza quando isso é chamado
        console.log("GAME OVER: Deletando save da nuvem para usuário:", currentFirebaseUser.uid);
        deleteGameFromCloud(currentFirebaseUser.uid);
    } else if (currentFirebaseUser) {
        console.log("GAME OVER: Morte em desafio, save da nuvem NÃO será deletado por esta função.");
    }


    if (game.player.sombraAtiva) game.player.sombraAtiva = null;

    mostrarMensagem(`<span class="text-rose-600 font-extrabold text-3xl">Você morreu!</span><br/>O mundo de <span class="font-bold text-sky-400">Arkham</span> não foi gentil desta vez.<br/>Seu progresso salvo na nuvem (se houver e se não foi uma falha de desafio recuperável) pode ter sido apagado.<br/><br/>Deseja recomeçar?`);
    limparEscolhas();
    adicionarEscolha("Recomeçar do Zero", () => {
        game.estado = "characterSetup"; // Força setup de personagem
        iniciarJogo(true); // true para forçar reset completo
    });
    // updateAuthUI foi removido pois updateGoogleSignInUI é mais específico aqui
    updateGoogleSignInUI();
}
            function falharDesafioHabilidade() {
                mostrarMensagem(`Você não conseguiu superar o desafio para dominar <span class="font-bold text-sky-400">${CLASSES_DATA[game.player.classe].habilidades.find(h => h.id === game.batalha.skillEmDesafioId)?.nome || "esta habilidade"}</span>.<br/>Tente novamente quando estiver mais forte.`);
                game.batalha.isDesafioClasse = false;
                game.batalha.skillEmDesafioId = null;
                game.batalha.desafioBossOriginalStats = null;
                game.batalha.emBatalha = false;
                atualizarStatusAtributos();

                limparEscolhas();
                adicionarEscolha("Retornar à tela de Habilidades", abrirSkills);
                adicionarEscolha("Voltar ao Início", abrirInicio);
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
            }


            function abrirAtributos() {
                game.estado = "atributos";
                atualizarRank();
                atualizarAtributosDerivados();
                atualizarStatusAtributos();

                document.getElementById("game-screen")?.classList.add("hidden");
                document.getElementById("atributos-screen")?.classList.remove("hidden");
                document.getElementById("inventario-screen")?.classList.add("hidden");
                document.getElementById("mercador-screen")?.classList.add("hidden");
                document.getElementById("skills-screen")?.classList.add("hidden");
                document.getElementById("character-setup-screen")?.classList.add("hidden");

                atualizarTelaAtributos();
                updateGoogleSignInUI();
            }

            function atualizarTelaAtributos() {
                const a = game.player.atributos;
                document.getElementById("forca-val").textContent = a.forca.toFixed(1);
                document.getElementById("forca-rank").textContent = getAtributoRank(a.forca);

                document.getElementById("agilidade-val").textContent = a.agilidade.toFixed(1);
                document.getElementById("agilidade-rank").textContent = getAtributoRank(a.agilidade);

                document.getElementById("inteligencia-val").textContent = a.inteligencia.toFixed(1);
                document.getElementById("inteligencia-rank").textContent = getAtributoRank(a.inteligencia);

                document.getElementById("resistencia-val").textContent = a.resistencia.toFixed(1);
                document.getElementById("resistencia-rank").textContent = getAtributoRank(a.resistencia);

                document.getElementById("vitalidade-val").textContent = a.vitalidade.toFixed(1);
                document.getElementById("vitalidade-rank").textContent = getAtributoRank(a.vitalidade);

                document.getElementById("percepcao-val").textContent = a.percepcao.toFixed(1);
                document.getElementById("percepcao-rank").textContent = getAtributoRank(a.percepcao);

                document.getElementById("pontos-disponiveis").textContent = game.player.pontosDistribuir.toString();
                atualizarStatusAtributos();
            }


            function manipularBotaoAtributo(e) {
                const btn = e.target.closest(".btn-attr");
                const modeBtn = e.target.closest(".attribute-mode-btn");

                if (modeBtn) {
                    game.player.attributeAddAmount = parseInt(modeBtn.dataset.amount);
                    document.querySelectorAll('.attribute-mode-btn').forEach(b => b.classList.remove('active'));
                    modeBtn.classList.add('active');
                    return;
                }

                if (!btn) return;

                const attr = btn.dataset.attr;
                const action = btn.dataset.action;

                if (!attr || !action || !game.player.atributos.hasOwnProperty(attr)) return;

                const valAtual = parseFloat(game.player.atributos[attr]);

                if (action === "inc") {
                    const amountToSpend = game.player.attributeAddAmount;
                    if (game.player.pontosDistribuir >= amountToSpend) {
                        const effectiveAttributeIncrease = game.player.isMarcado ? amountToSpend * 2 : amountToSpend;
                        game.player.atributos[attr] = +(valAtual + effectiveAttributeIncrease).toFixed(1);
                        game.player.pontosDistribuir -= amountToSpend;
                    } else {
                        alert(`Você não tem ${amountToSpend} ponto(s) de atributo para distribuir. Você tem ${game.player.pontosDistribuir} disponíveis.`);
                    }
                } else if (action === "dec") {
                    const pointsToRefund = 1;
                    const attributeValueDecrease = game.player.isMarcado ? 2 : 1;

                    if (valAtual - attributeValueDecrease >= (BASE_STATS[attr] !== undefined ? BASE_STATS[attr] : 0)) {
                        game.player.atributos[attr] = +(valAtual - attributeValueDecrease).toFixed(1);
                        game.player.pontosDistribuir += pointsToRefund;
                    } else if (valAtual - 1 >= (BASE_STATS[attr] !== undefined ? BASE_STATS[attr] : 0) && !game.player.isMarcado) {
                        game.player.atributos[attr] = +(valAtual - 1).toFixed(1);
                        game.player.pontosDistribuir += pointsToRefund;
                    }
                }

                atualizarAtributosDerivados();
                atualizarTelaAtributos();
            }

            function salvarAtributos() {
                atualizarRank();
                atualizarAtributosDerivados();
                atualizarStatusAtributos();
                abrirInicio();
            }


            function abrirInicio() {
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
                game.estado = "inicio";
                game.dungeon.active = false;
                game.dungeon.isBossRoomConfirmation = false;
                game.batalha.isBossBattle = false;

                if (!game.batalha.emBatalha) {
                    game.player.activeBuffs = [];
                }


                document.getElementById("game-screen")?.classList.remove("hidden");
                document.getElementById("atributos-screen")?.classList.add("hidden");
                document.getElementById("inventario-screen")?.classList.add("hidden");
                document.getElementById("mercador-screen")?.classList.add("hidden");
                document.getElementById("skills-screen")?.classList.add("hidden");
                document.getElementById("character-setup-screen")?.classList.add("hidden");


                if (game.player.metLordeDaMorte && !game.player.classe) {
                    const mockLorde = { isLordeDaMorte: true };
                    if (tentarDesbloquearNecromante(mockLorde)) return;
                }
                if (!game.player.classe && atribuirClasseAleatoriaSeNecessario()) {
                    return;
                }

                let inicioMsg = `Você está na <span class="font-bold text-sky-400">Área ${DUNGEON_CONFIG[game.player.currentArea].name}</span> do mundo de Arkham.<br/><br/>O que deseja fazer?`;
                if (game.player.lastDefeatedMonsterInfo && game.player.classe === "Necromante" && game.player.magiasAdquiridas.includes("n_extracao_sombras")) {
                    inicioMsg = `Você está na <span class="font-bold text-sky-400">Área <span class="math-inline">\{game\.player\.currentArea\}</span\>\. A essência do <span class\="text\-purple\-300"\></span>{game.player.lastDefeatedMonsterInfo.nome}</span> ainda paira, pronta para extração.<br/><br/>O que deseja fazer?`;
                }

                mostrarMensagem(inicioMsg);
                limparEscolhas();

                if (game.player.classe === "Necromante" && game.player.lastDefeatedMonsterInfo && game.player.magiasAdquiridas.includes("n_extracao_sombras")) {
                    const extracaoSkill = CLASSES_DATA.Necromante.habilidades.find(h => h.id === "n_extracao_sombras");
                    if (extracaoSkill) {
                        adicionarEscolha(`Usar ${extracaoSkill.nome} (Mana: ${calcularGastoMana(extracaoSkill)})`, () => {
                            const manaCost = calcularGastoMana(extracaoSkill);
                            if (game.player.manaAtual >= manaCost) {
                                game.player.manaAtual -= manaCost;
                                const lastMonster = game.player.lastDefeatedMonsterInfo;
                                const newRankIndex = Math.max(0, rankToIndex(lastMonster.rank) - 1);
                                const shadowRank = indexToRank(newRankIndex);
                                const shadowId = crypto.randomUUID();
                                const newShadow = {
                                    id: shadowId, nomeOriginal: lastMonster.nome, nomeSombra: `Sombra de ${lastMonster.nome}`,
                                    rankOriginal: lastMonster.rank, rankSombra: shadowRank,
                                    statsOriginais: { vidaMax: lastMonster.vidaMax, danoFisico: lastMonster.danoFisico, danoMagico: lastMonster.danoMagico }
                                };

                                if (game.player.recipienteSombras.length < game.player.recipienteCapacity) {
                                    game.player.recipienteSombras.push(newShadow);
                                    game.player.lastDefeatedMonsterInfo = null;
                                    atualizarRecipienteSombrasTela();
                                    abrirInicio();
                                } else {
                                    mostrarMensagem(`Seu Recipiente de Sombras está cheio (<span class="math-inline">\{game\.player\.recipienteSombras\.length\}/</span>{game.player.recipienteCapacity}). Não foi possível extrair a sombra. Mana não gasta.`);
                                    game.player.manaAtual += manaCost;
                                    abrirInicio();
                                }
                            } else {
                                mostrarMensagem(`Mana insuficiente para Extração de Sombras. (${manaCost} necessário).`);
                                abrirInicio();
                            }
                            atualizarStatusAtributos();
                        }, game.player.manaAtual < calcularGastoMana(extracaoSkill) || game.player.recipienteSombras.length >= game.player.recipienteCapacity, extracaoSkill.descricao);
                    }
                }

                adicionarEscolha("Explorar a área", explorarArea);
                adicionarEscolha(`Entrar na Masmorra (${DUNGEON_CONFIG[game.player.currentArea].name})`, () => entrarMasmorra(game.player.currentArea));
                adicionarEscolha("Ver atributos", abrirAtributos, game.batalha.emBatalha);
                adicionarEscolha("Abrir habilidades", abrirSkills, game.batalha.emBatalha);
                adicionarEscolha("Abrir inventário", abrirInventario, game.batalha.emBatalha);
                if (game.player.nivel >= 10) {
                    adicionarEscolha("Mudar de Área", abrirTelaMudarArea, game.batalha.emBatalha);
                }

                updateGoogleSignInUI();
                atualizarStatusAtributos();
            }

            function abrirInventario() {
                game.estado = "inventario";


                document.getElementById("game-screen")?.classList.add("hidden");
                document.getElementById("atributos-screen")?.classList.add("hidden");
                document.getElementById("inventario-screen")?.classList.remove("hidden");
                document.getElementById("mercador-screen")?.classList.add("hidden");
                document.getElementById("skills-screen")?.classList.add("hidden");
                document.getElementById("character-setup-screen")?.classList.add("hidden");

                atualizarInventarioTela();
                atualizarRecipienteSombrasTela();
                updateGoogleSignInUI();
            }

            function atualizarRecipienteSombrasTela() {
                const containerDiv = document.getElementById("recipiente-sombras-container");
                const listaSombrasUL = document.getElementById("lista-sombras-recipiente");
                if (!containerDiv || !listaSombrasUL) return;
                listaSombrasUL.innerHTML = "";

                if (game.player.classe === "Necromante") {
                    containerDiv.classList.remove("hidden");

                    let hasContent = false;


                    if (game.player.sombraAtiva) {
                        hasContent = true;
                        const sombra = game.player.sombraAtiva;
                        const liAtiva = document.createElement("li");
                        liAtiva.className = "bg-slate-500 border border-amber-500 rounded p-3 shadow-lg mb-3";

                        const ativaInfoDiv = document.createElement("div");
                        ativaInfoDiv.className = "flex flex-col sm:flex-row justify-between sm:items-center";

                        const ativaNomeSpan = document.createElement("span");
                        ativaNomeSpan.className = "font-bold text-amber-300 text-lg";
                        ativaNomeSpan.innerHTML = `${sombra.nomeSombra} <span class="text-sm font-normal text-amber-200">(Rank ${sombra.rankSombra})</span> - ATIVA`;
                        ativaInfoDiv.appendChild(ativaNomeSpan);

                        const ativaStatsSpan = document.createElement("span");
                        ativaStatsSpan.className = "text-xs text-amber-100 mt-1 sm:mt-0";
                        ativaStatsSpan.textContent = `HP: <span class="math-inline">\{sombra\.statsAtuais?\.vidaAtual \|\| 'N/A'\}/</span>{sombra.statsAtuais?.vidaMax || 'N/A'}, Dano Base: ${sombra.statsAtuais?.danoBase || 'N/A'}`;
                        ativaInfoDiv.appendChild(ativaStatsSpan);

                        liAtiva.appendChild(ativaInfoDiv);

                        const btnGuardar = document.createElement("button");
                        btnGuardar.className = "mt-2 bg-sky-700 hover:bg-sky-600 text-white px-3 py-1.5 text-sm rounded-md w-full sm:w-auto";
                        btnGuardar.textContent = "Guardar Sombra Ativa";
                        btnGuardar.title = "Devolve a sombra ativa para o recipiente.";
                        btnGuardar.addEventListener("click", () => {
                            if (game.batalha.emBatalha) {
                                alert("Você não pode guardar uma sombra ativa durante uma batalha.");
                                return;
                            }
                            if (game.player.recipienteSombras.length >= game.player.recipienteCapacity) {
                                alert("Seu recipiente de sombras está cheio! Libere espaço antes de guardar.");
                                return;
                            }
                            game.player.recipienteSombras.push(game.player.sombraAtiva);
                            const nomeSombraGuardada = game.player.sombraAtiva.nomeSombra;
                            game.player.sombraAtiva = null;
                            mostrarMensagem(`${nomeSombraGuardada} foi guardada no recipiente.`);
                            atualizarRecipienteSombrasTela();
                            updateSummonBattleDisplay();
                            atualizarStatusAtributos();
                        });

                        const actionsDivAtiva = document.createElement("div");
                        actionsDivAtiva.className = "mt-2 text-right";
                        actionsDivAtiva.appendChild(btnGuardar);
                        liAtiva.appendChild(actionsDivAtiva);

                        listaSombrasUL.appendChild(liAtiva);
                    }


                    if (game.player.recipienteSombras.length > 0) {
                        hasContent = true;
                        game.player.recipienteSombras.forEach(sombra => {
                            const li = document.createElement("li");
                            li.className = "bg-slate-600 rounded p-3 shadow-sm mb-2";

                            const itemContentDiv = document.createElement("div");
                            itemContentDiv.className = "flex flex-col space-y-2";

                            const nomeSombraSpan = document.createElement("span");
                            nomeSombraSpan.className = "text-purple-300 font-semibold text-md";
                            nomeSombraSpan.textContent = `${sombra.nomeSombra} (Rank ${sombra.rankSombra}, Original: ${sombra.rankOriginal})`;
                            itemContentDiv.appendChild(nomeSombraSpan);

                            const statsOriginaisSpan = document.createElement("span");
                            statsOriginaisSpan.className = "text-xs text-slate-400";
                            statsOriginaisSpan.textContent = `Origem Stats - HP: ${sombra.statsOriginais.vidaMax}, Dano Fís: ${sombra.statsOriginais.danoFisico || 0}, Dano Mág: ${sombra.statsOriginais.danoMagico || 0}`;
                            itemContentDiv.appendChild(statsOriginaisSpan);

                            const botoesSombraDiv = document.createElement("div");
                            botoesSombraDiv.className = "flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mt-2 sm:justify-end";

                            const btnInvocar = document.createElement("button");
                            btnInvocar.className = "bg-emerald-700 hover:bg-emerald-600 text-white px-3 py-1.5 text-sm rounded-md";
                            btnInvocar.textContent = game.player.sombraAtiva ? "Trocar pela Ativa" : "Invocar";
                            btnInvocar.title = game.player.sombraAtiva ? "Guarda a sombra ativa atual e invoca esta (fora de combate)." : "Define esta sombra como ativa (fora de combate).";
                            btnInvocar.onclick = () => {
                                if (game.batalha.emBatalha) {
                                    alert("Você não pode trocar de sombra durante uma batalha. Use a habilidade 'Invocar Sombra' em combate se desejar.");
                                    return;
                                }
                                let msgFeedback = "";
                                if (game.player.sombraAtiva) {
                                    if (game.player.recipienteSombras.length >= game.player.recipienteCapacity + 1) {
                                        alert("Seu recipiente de sombras está cheio! Libere espaço antes de trocar.");
                                        return;
                                    }
                                    game.player.recipienteSombras.push(game.player.sombraAtiva);
                                    msgFeedback = `${game.player.sombraAtiva.nomeSombra} guardada. `;
                                }

                                const vidaAtiva = Math.max(1, Math.floor(sombra.statsOriginais.vidaMax * 0.5));
                                const danoBaseAtivo = Math.max(1, Math.floor((sombra.statsOriginais.danoFisico || 0) * 0.5));
                                game.player.sombraAtiva = {
                                    ...sombra,
                                    statsAtuais: { vidaMax: vidaAtiva, vidaAtual: vidaAtiva, danoBase: danoBaseAtivo }
                                };
                                game.player.recipienteSombras = game.player.recipienteSombras.filter(sh => sh.id !== sombra.id);

                                msgFeedback += `${sombra.nomeSombra} é agora sua sombra ativa.`;
                                mostrarMensagem(msgFeedback);
                                atualizarRecipienteSombrasTela();
                                updateSummonBattleDisplay();
                                atualizarStatusAtributos();
                            };
                            botoesSombraDiv.appendChild(btnInvocar);

                            const btnDispensar = document.createElement("button");
                            btnDispensar.className = "bg-rose-800 hover:bg-rose-700 text-white px-3 py-1.5 text-sm rounded-md";
                            btnDispensar.textContent = "Dispensar";
                            btnDispensar.title = "Libera a sombra permanentemente do recipiente.";
                            btnDispensar.onclick = () => {
                                if (confirm(`Deseja realmente dispensar ${sombra.nomeSombra} do recipiente? Esta ação é permanente.`)) {
                                    game.player.recipienteSombras = game.player.recipienteSombras.filter(sh => sh.id !== sombra.id);
                                    mostrarMensagem(`${sombra.nomeSombra} foi dispensada permanentemente.`);
                                    atualizarRecipienteSombrasTela();
                                }
                            };
                            botoesSombraDiv.appendChild(btnDispensar);
                            itemContentDiv.appendChild(botoesSombraDiv);
                            li.appendChild(itemContentDiv);
                            listaSombrasUL.appendChild(li);
                        });
                    }


                    const capacityLi = document.createElement("li");
                    capacityLi.className = "text-slate-400 italic text-center py-2";
                    capacityLi.textContent = `Capacidade do Recipiente: ${game.player.recipienteSombras.length + (game.player.sombraAtiva ? 1 : 0)} / ${game.player.recipienteCapacity}`;
                    listaSombrasUL.appendChild(capacityLi);

                    if (!hasContent && game.player.recipienteSombras.length === 0 && !game.player.sombraAtiva) {
                        listaSombrasUL.innerHTML = `<li class="text-slate-400 italic text-center py-3">Seu recipiente de sombras está vazio e nenhuma sombra está ativa. Derrote inimigos e use 'Extração de Sombras'.</li>`;
                    }

                } else {
                    containerDiv.classList.add("hidden");
                }
            }

            function atualizarInventarioTela() {
                const lista = document.getElementById("lista-itens");
                if (!lista) return;
                lista.innerHTML = "";
                if (game.player.inventario.length === 0) {
                    const li = document.createElement("li"); li.className = "text-slate-400 italic";
                    li.textContent = "Inventário vazio."; lista.appendChild(li);
                } else {
                    game.player.inventario.forEach((item) => {
                        const li = document.createElement("li");
                        li.className = "bg-slate-600 rounded p-2 flex flex-col sm:flex-row sm:justify-between sm:items-center";
                        const itemInfoDiv = document.createElement("div");
                        itemInfoDiv.className = "flex-grow";
                        const nomeSpan = document.createElement("span");
                        nomeSpan.className = "font-semibold text-sky-400";
                        let displayName = `${item.nome} (Rank ${item.rank})`;
                        if (item.quantity > 1) displayName += ` (x${item.quantity})`;
                        nomeSpan.textContent = displayName;
                        itemInfoDiv.appendChild(nomeSpan);
                        const efeitosSpan = document.createElement("span");
                        efeitosSpan.className = "text-xs text-slate-300 mt-1 sm:mt-0 sm:ml-0 block";
                        if (item.isPotion) {
                            efeitosSpan.textContent = item.descricao;
                        } else {
                            efeitosSpan.innerHTML = Object.entries(item.efeitos || {}).map(([chave, val]) => {
                                let desc = "";
                                switch (chave) {
                                    case "forca": desc = `+${val} Força`; break; case "agilidade": desc = `+${val} Agilidade`; break;
                                    case "inteligencia": desc = `+${val} Inteligência`; break; case "resistencia": desc = `+${val} Resistência`; break;
                                    case "vitalidade": desc = `+${val} Vitalidade`; break; case "percepcao": desc = `+${val} Percepção`; break;
                                    case "refinoMagico": desc = `+${val}% Refino Mágico`; break; default: desc = `<span class="math-inline">\{chave\}\: \+</span>{val}`;
                                } return desc;
                            }).join(", ");
                        }
                        itemInfoDiv.appendChild(efeitosSpan);
                        li.appendChild(itemInfoDiv);
                        const botoesDiv = document.createElement("div");
                        botoesDiv.className = "mt-2 sm:mt-0 sm:ml-4 flex space-x-2 flex-shrink-0";
                        if (!item.isPotion) {
                            const btnEquipar = document.createElement("button");
                            btnEquipar.className = "bg-emerald-600 hover:bg-emerald-500 rounded px-3 py-1 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-400";
                            btnEquipar.textContent = "Equipar";
                            btnEquipar.addEventListener("click", () => equiparItem(item));
                            botoesDiv.appendChild(btnEquipar);
                        }
                        const btnDescartar = document.createElement("button");
                        btnDescartar.className = "bg-rose-600 hover:bg-rose-500 rounded px-3 py-1 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-rose-400";
                        btnDescartar.textContent = "Descartar";
                        btnDescartar.addEventListener("click", () => descartarItem(item));
                        botoesDiv.appendChild(btnDescartar);
                        li.appendChild(botoesDiv);
                        lista.appendChild(li);
                    });
                }
                atualizarEquipamentosTela();
            }

            function atualizarEquipamentosTela() {
                const equipSlots = {
                    capacete: document.getElementById("equip-capacete"),
                    peitoral: document.getElementById("equip-peitoral"),
                    calca: document.getElementById("equip-calca"),
                    botas: document.getElementById("equip-botas"),
                    arma: document.getElementById("equip-arma"),
                    escudo: document.getElementById("equip-escudo"),
                    anel: document.getElementById("equip-anel"),
                    colar: document.getElementById("equip-colar")
                };

                for (const slotName in equipSlots) {
                    const element = equipSlots[slotName];
                    const item = game.player.equipamento[slotName];
                    if (element) {
                        if (item) {
                            element.textContent = `${item.nome} (Rank ${item.rank})`;
                            element.classList.remove("italic");
                            element.title = Object.entries(item.efeitos || {}).map(([key, val]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: +${val}`).join(' | ');
                        } else {
                            element.textContent = "Nenhum";
                            element.classList.add("italic");
                            element.title = "";
                        }
                    }
                }
            }

            function equiparItem(itemFromInventoryStack) {
                if (itemFromInventoryStack.isPotion || itemFromInventoryStack.quantity <= 0) return;
                let slotParaEquipar = null;
                switch (itemFromInventoryStack.tipo) {
                    case "Capacete": slotParaEquipar = "capacete"; break;
                    case "Peitoral": slotParaEquipar = "peitoral"; break;
                    case "Calça": slotParaEquipar = "calca"; break;
                    case "Botas": slotParaEquipar = "botas"; break;
                    case "Arma": slotParaEquipar = "arma"; break;
                    case "Escudo": slotParaEquipar = "escudo"; break;
                    case "Anel": slotParaEquipar = "anel"; break;
                    case "Colar": slotParaEquipar = "colar"; break;
                    default: console.warn("Tipo de item desconhecido para equipamento:", itemFromInventoryStack.tipo); return;
                }
                if (slotParaEquipar) {
                    if (game.player.equipamento[slotParaEquipar]) {
                        addItemToInventory(game.player.equipamento[slotParaEquipar]);
                    }
                    const itemToEquip = { ...itemFromInventoryStack };
                    delete itemToEquip.quantity;
                    game.player.equipamento[slotParaEquipar] = itemToEquip;
                    itemFromInventoryStack.quantity--;
                    if (itemFromInventoryStack.quantity <= 0) {
                        game.player.inventario = game.player.inventario.filter(i => i !== itemFromInventoryStack);
                    }
                    atualizarAtributosDerivados();
                    atualizarInventarioTela();
                    atualizarStatusAtributos();
                }
            }

            function descartarItem(itemInInventory) {
                if (!itemInInventory || itemInInventory.quantity <= 0) return;
                if (confirm(`Deseja realmente descartar UMA unidade de ${itemInInventory.nome}?`)) {
                    itemInInventory.quantity--;
                    if (itemInInventory.quantity <= 0) {
                        game.player.inventario = game.player.inventario.filter(i => i !== itemInInventory);
                    }
                    atualizarInventarioTela();
                }
            }

            function aplicarEfeitosEquipamento() {
                let totalRefinoMagicoBonus = 0;
                for (const slot in game.player.equipamento) {
                    const equip = game.player.equipamento[slot];
                    if (equip && equip.efeitos && typeof equip.efeitos.refinoMagico === 'number') {
                        totalRefinoMagicoBonus += equip.efeitos.refinoMagico;
                    }
                }
                game.player.refinoMagicoPct = totalRefinoMagicoBonus / 100;
            }

            function abrirMercador() {
                toggleHeaderNavButtons(true);
                toggleChatInput(true);
                game.estado = "mercador";
                document.getElementById("game-screen")?.classList.add("hidden");
                document.getElementById("atributos-screen")?.classList.add("hidden");
                document.getElementById("inventario-screen")?.classList.add("hidden");
                document.getElementById("mercador-screen")?.classList.remove("hidden");
                document.getElementById("skills-screen")?.classList.add("hidden");
                gerarItensMercador();
                atualizarTelaMercador();
                mostrarMensagem(`O mercador cumprimenta você. Você tem <span class="font-bold text-amber-300">${game.player.moedas}</span> moedas.<br/><br/>Selecione os itens que deseja comprar.`);
                updateGoogleSignInUI();
            }

            function gerarItensMercador() {
                game.mercador.itens = [];
                game.mercador.selecionados.clear();
                const qtd = randomInt(5, 8);
                const playerRankIdx = rankToIndex(game.player.rank);

                for (let i = 0; i < qtd; i++) {
                    let itemRankIdx;
                    const chanceRoll = Math.random();


                    if (chanceRoll < 0.05 && playerRankIdx < RANKS.length - 2) {
                        itemRankIdx = playerRankIdx + 2;
                    } else if (chanceRoll < 0.20 && playerRankIdx < RANKS.length - 1) {
                        itemRankIdx = playerRankIdx + 1;
                    } else if (chanceRoll < 0.70) {
                        itemRankIdx = playerRankIdx;
                    } else {
                        itemRankIdx = playerRankIdx - 1;
                    }


                    itemRankIdx = clamp(itemRankIdx, 0, RANKS.length - 1);

                    const rank = indexToRank(itemRankIdx);
                    let item = gerarItem(rank);


                    if (item.isPotion && item.id !== POTIONS.compra.id) {
                        const pocaoBaseCompra = POTIONS.compra;
                        item.id = pocaoBaseCompra.id;
                        item.nome = pocaoBaseCompra.nome;
                        item.curaVidaPct = pocaoBaseCompra.curaVidaPct;
                        item.curaManaPct = pocaoBaseCompra.curaManaPct;
                        item.descricao = pocaoBaseCompra.descricao;
                        item.preco = 50;
                        item.rank = "C";
                    } else if (item.isPotion && item.id === POTIONS.compra.id) {
                        item.preco = 50;
                    }


                    game.mercador.itens.push(item);
                }
            }

            function atualizarTelaMercador() {
                const lista = document.getElementById("lista-mercador");
                if (!lista) return;
                lista.innerHTML = "";
                if (game.mercador.itens.length === 0) {
                    const li = document.createElement("li"); li.className = "text-slate-400 italic";
                    li.textContent = "O mercador não tem mais itens para vender no momento."; lista.appendChild(li);
                    atualizarBotaoComprar(); return;
                }
                game.mercador.itens.forEach((item) => {
                    const li = document.createElement("li");
                    li.className = "bg-slate-600 rounded p-3 flex flex-col sm:flex-row sm:justify-between sm:items-center";
                    const infoDiv = document.createElement("div"); infoDiv.className = "flex flex-col flex-grow";
                    const nomeSpan = document.createElement("span"); nomeSpan.className = "font-semibold text-sky-400";
                    nomeSpan.textContent = `${item.nome} (Rank ${item.rank})`; infoDiv.appendChild(nomeSpan);
                    const efeitosSpan = document.createElement("span"); efeitosSpan.className = "text-xs text-slate-300 mt-1";
                    if (item.isPotion) {
                        efeitosSpan.textContent = item.descricao;
                    } else {
                        efeitosSpan.innerHTML = Object.entries(item.efeitos || {}).map(([chave, val]) => {
                            let desc = "";
                            switch (chave) {
                                case "forca": desc = `+${val} Força`; break; case "agilidade": desc = `+${val} Agilidade`; break;
                                case "inteligencia": desc = `+${val} Inteligência`; break; case "resistencia": desc = `+${val} Resistência`; break;
                                case "vitalidade": desc = `+${val} Vitalidade`; break; case "percepcao": desc = `+${val} Percepção`; break;
                                case "refinoMagico": desc = `+${val}% Refino Mágico`; break; default: desc = `<span class="math-inline">\{chave\}\: \+</span>{val}`;
                            } return desc;
                        }).join(", ");
                    }
                    infoDiv.appendChild(efeitosSpan); li.appendChild(infoDiv);
                    const compraDiv = document.createElement("div");
                    compraDiv.className = "flex items-center space-x-3 mt-3 sm:mt-0 flex-shrink-0";
                    const precoSpan = document.createElement("span"); precoSpan.className = "font-semibold text-amber-300";
                    precoSpan.textContent = `${item.preco} moedas`; compraDiv.appendChild(precoSpan);
                    const checkbox = document.createElement("input"); checkbox.type = "checkbox";
                    checkbox.className = "w-5 h-5 cursor-pointer form-checkbox text-sky-500 bg-slate-800 border-slate-500 focus:ring-sky-400";
                    checkbox.checked = game.mercador.selecionados.has(item);
                    checkbox.addEventListener("change", (e) => {
                        if (e.target.checked) { game.mercador.selecionados.add(item); } else { game.mercador.selecionados.delete(item); }
                        atualizarBotaoComprar();
                    });
                    compraDiv.appendChild(checkbox); li.appendChild(compraDiv); lista.appendChild(li);
                });
                atualizarBotaoComprar();
            }

            function atualizarBotaoComprar() {
                const btn = document.getElementById("btn-comprar-mercador");
                if (!btn) return;
                if (game.mercador.selecionados.size === 0) {
                    btn.disabled = true; btn.textContent = "Comprar Selecionados"; return;
                }
                let totalPreco = 0; game.mercador.selecionados.forEach(item => totalPreco += item.preco);
                btn.disabled = totalPreco > game.player.moedas || totalPreco === 0;
                btn.textContent = `Comprar (${totalPreco} moedas)`;
            }

            function comprarItensMercador() {
                if (game.mercador.selecionados.size === 0) return;
                let totalPreco = 0; const itensCompradosNomes = [];
                game.mercador.selecionados.forEach(item => totalPreco += item.preco);
                if (totalPreco > game.player.moedas) { alert("Você não tem moedas suficientes."); return; }
                game.player.moedas -= totalPreco;
                game.mercador.selecionados.forEach(item => {
                    addItemToInventory(item); itensCompradosNomes.push(item.nome);
                    game.mercador.itens = game.mercador.itens.filter(merchantItem => merchantItem !== item);
                });
                alert(`Você comprou: ${itensCompradosNomes.join(", ")} por ${totalPreco} moedas.`);
                game.mercador.selecionados.clear();
                atualizarTelaMercador();
                atualizarStatusAtributos();
                atualizarInventarioTela();
                const mercadorBtn = document.getElementById("btn-mercador");
                if (mercadorBtn) mercadorBtn.classList.add("hidden");
                abrirInicio();
            }

            function abrirSkills() {
                game.estado = "skills";


                document.getElementById("game-screen")?.classList.add("hidden");
                document.getElementById("atributos-screen")?.classList.add("hidden");
                document.getElementById("inventario-screen")?.classList.add("hidden");
                document.getElementById("mercador-screen")?.classList.add("hidden");
                document.getElementById("skills-screen")?.classList.remove("hidden");
                document.getElementById("character-setup-screen")?.classList.add("hidden");

                atualizarSkillsTela();
                updateGoogleSignInUI();
            }
            function atualizarSkillsTela() {
                const lista = document.getElementById("lista-skills");
                const classeInfoDiv = document.getElementById("classe-info-skills");
                if (!lista || !classeInfoDiv) {
                    console.error("ERRO: Elementos da tela de skills não encontrados ('lista-skills' ou 'classe-info-skills').");
                    return;
                }
                lista.innerHTML = "";
                classeInfoDiv.innerHTML = "";

                let currentClassName = game.player.classe;
                let currentClassDesc = "Nenhuma classe foi definida ainda.";
                let classTitleColor = "text-amber-400";

                if (game.player.classe) {
                    const baseClassData = CLASSES_DATA[game.player.classe];
                    if (game.player.classe === "Necromante" && game.player.isMarcado) {
                        currentClassName = "Monarca das Sombras";
                        currentClassDesc = "Aquele que ascendeu além da morte, comandando as próprias sombras da existência.";
                        classTitleColor = "text-purple-300";
                    } else if (baseClassData) {
                        currentClassName = baseClassData.nomeDisplay;
                        currentClassDesc = baseClassData.descricao;
                        classTitleColor = "text-sky-300";
                    }
                } else {
                    currentClassDesc = `<p class="text-sm text-slate-400">Alcance Nível 10 e Rank D para que seu destino revele sua classe (aleatoriamente), ou derrote o Lorde da Morte para um caminho mais sombrio. Torne-se Marcado para desbloquear evoluções.</p>`;
                }

                classeInfoDiv.innerHTML = `
<p class="text-xl ${classTitleColor} font-semibold">Classe: ${currentClassName || "Nenhuma"}</p>
<p class="text-sm text-slate-300">${currentClassDesc}</p>
`;

                if (!game.player.classe) {
                    lista.innerHTML = `<p class="text-slate-400 italic">Nenhuma habilidade disponível sem uma classe.</p>`;
                    return;
                }

                const actualClassData = CLASSES_DATA[game.player.classe];
                if (!actualClassData || !actualClassData.habilidades || actualClassData.habilidades.length === 0) {
                    lista.innerHTML = `<p class="text-slate-400 italic">Esta classe não possui habilidades definidas.</p>`;
                    return;
                }

                let algumaSkillVisivel = false;

                actualClassData.habilidades.forEach(skill => {
                    const isMonarcaSkill = !!skill.monarcaOnly;
                    if (isMonarcaSkill && !(game.player.classe === "Necromante" && game.player.isMarcado)) {
                        return;
                    }

                    algumaSkillVisivel = true;
                    const isAcquired = game.player.magiasAdquiridas.includes(skill.id);
                    const div = document.createElement("div");
                    let divClasses = "bg-slate-600 rounded p-3 flex flex-col sm:flex-row sm:justify-between sm:items-start";

                    const playerLevelOk = game.player.nivel >= skill.unlockLevel;
                    let isEffectivelyLocked = false;
                    let lockReason = "";

                    if (!isAcquired) {
                        if (isMonarcaSkill) {
                            if (!playerLevelOk) {
                                isEffectivelyLocked = true;
                                lockReason = `(Bloqueada - Requer Nv. ${skill.unlockLevel} de Monarca)`;
                            } else {
                                lockReason = `(Disponível para aprender - Nv. ${skill.unlockLevel})`;
                            }
                        } else if (game.player.classe === "Necromante" && (skill.id === "n_extracao_sombras" || skill.id === "n_invocar_sombra")) {
                            if (!game.player.metLordeDaMorte) { isEffectivelyLocked = true; lockReason = "(Bloqueada - Derrote o Lorde da Morte)"; }
                            else if (!playerLevelOk) { isEffectivelyLocked = true; lockReason = `(Bloqueada - Requer Nv. ${skill.unlockLevel})`; }
                            else { lockReason = `(Disponível para aprender - Nv. ${skill.unlockLevel})`; }
                        } else if (skill.requerDesafio) {
                            if (game.player.classe === "Necromante" && (skill.id === "n_dominio_sombras" || skill.id === "n_exercito_sombras")) {
                                if (!game.player.metLordeDaMorte) { isEffectivelyLocked = true; lockReason = "(Bloqueada - Derrote o Lorde da Morte p/ desafio)"; }
                                else if (!playerLevelOk) { isEffectivelyLocked = true; lockReason = `(Bloqueada - Requer Nv. ${skill.unlockLevel} p/ desafio)`; }
                                else { lockReason = `(Desafio Disponível - Nv. ${skill.unlockLevel})`; }
                            } else {
                                if (!playerLevelOk) { isEffectivelyLocked = true; lockReason = `(Bloqueada - Requer Nv. ${skill.unlockLevel})`; }
                                else { lockReason = `(Desafio Disponível - Nv. ${skill.unlockLevel})`; }
                            }
                        } else if (!playerLevelOk) {
                            isEffectivelyLocked = true; lockReason = `(Bloqueada - Requer Nv. ${skill.unlockLevel})`;
                        } else {
                            lockReason = `(Disponível para aprender - Nv. ${skill.unlockLevel})`;
                        }
                    }

                    if (isEffectivelyLocked && !isAcquired) {
                        divClasses += ' opacity-60';
                    }
                    div.className = divClasses;

                    const infoDiv = document.createElement("div");
                    infoDiv.className = "flex flex-col flex-grow mb-2 sm:mb-0";

                    const nomeSpan = document.createElement("span");
                    let skillDisplayName = skill.nome;
                    let skillTitleColorClassName = "text-sky-400";
                    if (game.player.classe === "Necromante" && game.player.isMarcado && isMonarcaSkill) {
                        skillDisplayName = skillDisplayName.replace("[Monarca] ", "");
                        skillTitleColorClassName = "text-purple-300";
                    } else if (game.player.classe === "Necromante") {
                        skillTitleColorClassName = "text-purple-400";
                    }

                    nomeSpan.className = `font-semibold text-lg ${skillTitleColorClassName}`;
                    nomeSpan.textContent = `${skillDisplayName} (Rank ${skill.rank})`;
                    infoDiv.appendChild(nomeSpan);

                    const descSpan = document.createElement("span");
                    descSpan.className = "text-xs text-slate-300 mt-1";
                    let skillDescText = skill.descricao;
                    skillDescText += ` Custo Mana: ${calcularGastoMana(skill)}.`;

                    if (isAcquired) {
                        skillDescText += ` <span class="text-emerald-400">(Adquirida)</span>`;
                    } else if (lockReason) {
                        skillDescText += ` <span class="text-yellow-500">${lockReason}</span>`;
                    }
                    descSpan.innerHTML = skillDescText;
                    infoDiv.appendChild(descSpan);
                    div.appendChild(infoDiv);

                    const btnDiv = document.createElement("div");
                    btnDiv.className = "mt-2 sm:mt-0 sm:ml-3 flex-shrink-0 skill-actions";

                    if (isAcquired) {
                        const btnEquipar = document.createElement("button");
                        btnEquipar.textContent = game.player.magiasEquipadas.includes(skill.id) ? "Desequipar" : "Equipar";
                        btnEquipar.addEventListener("click", () => {
                            if (game.player.magiasEquipadas.includes(skill.id)) {
                                game.player.magiasEquipadas = game.player.magiasEquipadas.filter(id => id !== skill.id);
                            } else {
                                if (game.player.magiasEquipadas.length >= 4) { alert("Você só pode equipar até 4 habilidades."); return; }
                                game.player.magiasEquipadas.push(skill.id);
                            }
                            atualizarSkillsTela();
                        });
                        btnDiv.appendChild(btnEquipar);
                    } else if (!isEffectivelyLocked && playerLevelOk) {
                        if (skill.requerDesafio) {
                            const btnDesafio = document.createElement("button");
                            btnDesafio.textContent = "Iniciar Desafio";
                            btnDesafio.title = `Enfrente um desafio para aprender ${skill.nome}`;
                            btnDesafio.addEventListener("click", () => {
                                if (game.batalha.emBatalha || game.dungeon.active) { alert("Você não pode iniciar um desafio durante uma batalha ou dentro de uma masmorra."); return; }
                                if (confirm(`Você tem certeza que deseja enfrentar o desafio para aprender ${skill.nome}? Prepare-se!`)) {
                                    if (game.player.classe === "Necromante" && (skill.id === "n_dominio_sombras" || skill.id === "n_exercito_sombras")) {
                                        if (!game.player.metLordeDaMorte) { alert("Você precisa derrotar o Lorde da Morte primeiro para liberar este desafio!"); return; }
                                        iniciarDesafioLordeDaMorte(skill.requerDesafio, skill.id);
                                    } else {
                                        iniciarDesafioHabilidade(skill);
                                    }
                                }
                            });
                            btnDiv.appendChild(btnDesafio);
                        } else {
                            const btnAprender = document.createElement("button");
                            btnAprender.textContent = "Aprender Habilidade";
                            btnAprender.title = `Aprenda ${skill.nome}.`;
                            btnAprender.addEventListener("click", () => {
                                if (game.player.magiasAdquiridas.includes(skill.id)) { alert("Você já aprendeu esta habilidade."); return; }
                                game.player.magiasAdquiridas.push(skill.id);
                                alert(`Você aprendeu ${skill.nome}!`);
                                if (game.player.magiasEquipadas.length < 4) { game.player.magiasEquipadas.push(skill.id); alert(`${skill.nome} equipada automaticamente.`); }
                                atualizarSkillsTela();
                            });
                            btnDiv.appendChild(btnAprender);
                        }
                    }

                    if (btnDiv.hasChildNodes()) div.appendChild(btnDiv);
                    lista.appendChild(div);
                });

                if (!algumaSkillVisivel) {
                    const p = document.createElement("p");
                    p.className = "text-slate-400 italic text-center py-4";
                    p.textContent = "Nenhuma habilidade disponível para sua classe e nível atuais, ou desafios pendentes.";
                    lista.appendChild(p);
                }
            }

            function iniciarDesafioHabilidade(skillAlvo) {
                if (!game.player.classe) {
                    mostrarMensagem("Você precisa de uma classe para enfrentar desafios de habilidade.");
                    return;
                }
                mostrarMensagem(`Você se prepara para o desafio de dominar <span class="font-bold text-sky-400">${skillAlvo.nome}</span>...<br/>Um eco de suas próprias proezas se materializa!`);
                limparEscolhas();

                const bossClone = gerarBossDesafioClasse(skillAlvo);
                game.batalha.isDesafioClasse = true;
                game.batalha.skillEmDesafioId = skillAlvo.id;
                game.monstroAtual = bossClone;

                setTimeout(() => {
                    iniciarBatalha(bossClone);
                }, 2500);
            }

            function iniciarDesafioLordeDaMorte(tipoDesafio, skillIdAlvo) {
                mostrarMensagem(`Você se prepara para enfrentar o Lorde da Morte em um desafio para <span class="font-bold text-sky-400">${CLASSES_DATA.Necromante.habilidades.find(h => h.id === skillIdAlvo)?.nome || 'uma nova habilidade'}</span>...`);
                limparEscolhas();

                const lordeParaDesafio = gerarLordeDaMorteParaDesafio(tipoDesafio);
                game.monstroAtual = lordeParaDesafio;

                game.batalha.isDesafioClasse = false;
                game.batalha.monstro = lordeParaDesafio;
                game.batalha.skillEmDesafioId = skillIdAlvo;
                game.batalha.tipoDesafioLorde = tipoDesafio;

                if (tipoDesafio === "lorde_exercito") {
                    mostrarMensagem(`Você sente suas energias arcanas e poções seladas! Apenas sua arma responderá neste confronto.`);
                }

                setTimeout(() => {
                    iniciarBatalha(lordeParaDesafio);
                }, 3000);
            }

            function entrarMasmorra(dungeonTypeRank) {
                const config = DUNGEON_CONFIG[dungeonTypeRank];
                if (!config) {
                    mostrarMensagem(`A masmorra de Rank ${dungeonTypeRank} ainda não está acessível ou não existe.`);
                    adicionarEscolha("Voltar", abrirInicio); return;
                }
                game.estado = "dungeon"; game.dungeon.active = true; game.dungeon.typeRank = dungeonTypeRank;
                game.dungeon.name = `${config.name} (Dungeon: ${config.name})`;
                game.dungeon.totalRooms = randomInt(config.roomsMin, config.roomsMax);
                game.dungeon.currentRoom = 0;
                game.dungeon.monsterRankForRooms = config.monsterRank;
                game.dungeon.bossRankForDungeon = config.bossRank;
                game.dungeon.bossDefeated = false; game.dungeon.isBossRoomConfirmation = false;
                game.player.lastDefeatedMonsterInfo = null;

                toggleChatInput(true);
                toggleHeaderNavButtons(true);
                mostrarMensagem(`Você adentrou a <span class="font-bold text-violet-400">${game.dungeon.name}</span>. Ela parece ter ${game.dungeon.totalRooms} salas.<br/>A primeira sala se aproxima...`);
                limparEscolhas();
                adicionarEscolha("Avançar para a primeira sala", avancarSalaMasmorra);
                updateGoogleSignInUI();
            }

            function avancarSalaMasmorra() {
                limparEscolhas();
                if (game.dungeon.currentRoom === game.dungeon.totalRooms - 1) {
                    game.dungeon.isBossRoomConfirmation = true;
                    let bossApproachMsg = `Você chegou à antessala da última câmara d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>.<br/>Você sente um calafrio. Uma presença poderosa emana da próxima sala.<br/><br/>Deseja continuar?`;
                    const dungeonConfig = DUNGEON_CONFIG[game.dungeon.typeRank];
                    if (dungeonConfig && dungeonConfig.lordeDaMorteChance &&
                        !game.player.classe && game.player.nivel >= 20 && rankToIndex(game.player.rank) >= rankToIndex("B") &&
                        !game.player.metLordeDaMorte && dungeonConfig.lordeDaMorteChance > 0) {
                        bossApproachMsg = `Você chegou à antessala da última câmara d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>.<br/>Um ar <span class="text-purple-500 font-semibold">gélido e pútrido</span> emana da próxima sala, prometendo um confronto diferente de qualquer outro...<br/><br/>Deseja continuar?`;
                    }
                    mostrarMensagem(bossApproachMsg);
                    adicionarEscolha("Continuar e enfrentar o perigo", confirmarEntradaBoss);
                    adicionarEscolha("Recuar da masmorra por agora", () => fugirDaMasmorra(true));
                } else {
                    const monstro = gerarMonstroMasmorra(game.dungeon.monsterRankForRooms);
                    game.monstroAtual = monstro;
                    setTimeout(() => iniciarBatalha(monstro), 1000);
                }
                updateGoogleSignInUI();
            }

            function confirmarEntradaBoss() {
    game.dungeon.isBossRoomConfirmation = false;

    let boss;
    const dungeonConfig = DUNGEON_CONFIG[game.dungeon.typeRank];
    let isArquitetoScenario = false;

    if (game.dungeon.typeRank === "D" && dungeonConfig.arquitetoChance && Math.random() < dungeonConfig.arquitetoChance) {
        if (!game.player.isMarcado) {
            boss = { ...ARQUITETO_STATS, vidaAtual: ARQUITETO_STATS.vidaMax };
            isArquitetoScenario = true;
        }
    }

    if (!isArquitetoScenario) {
        boss = gerarBossMasmorra(game.dungeon.typeRank, game.dungeon.bossRankForDungeon);
    }

    game.monstroAtual = boss;

    if (!boss || typeof boss !== 'object' || typeof boss.nome === 'undefined') {
        mostrarMensagem("Erro ao preparar o chefe da masmorra. Retornando ao menu inicial.");
        limparEscolhas();
        adicionarEscolha("Voltar ao Início", () => {
            if (game.dungeon.active) {
                game.dungeon.active = false;
            }
            abrirInicio();
        });
        return;
    }

    if (isArquitetoScenario) {
        game.batalha.pendingArquitetoEncounter = false;
        mostrarMensagem(`Uma figura imponente e etérea surge. É o <span class="font-bold text-cyan-300">Arquiteto</span>.<br/>Ele o encara e uma pergunta ecoa em sua mente: <span class="font-bold text-yellow-300">"Você deseja se tornar um 'Marcado'?"</span>`);
        limparEscolhas();
        adicionarEscolha("Sim, aceito o fardo e o poder.", () => {
            game.player.isMarcado = true;
            if (game.player.classe === "Necromante") {
                game.player.isMonarcaDasSombras = true;
            }
            mostrarMensagem(`O Arquiteto acena com a cabeça. Uma marca sutil surge em você.<br/>"Que seu caminho seja... interessante."<br/>Ele desaparece, deixando um sentimento de poder e um fardo desconhecido.<br/><br/>Você conquistou a masmorra de uma forma inesperada.`);
            game.dungeon.bossDefeated = true;
            setTimeout(() => completarMasmorra("Você se tornou um Marcado!"), 2000);
        });
        adicionarEscolha("Não, recuso tal destino.", () => {
            mostrarMensagem(`O Arquiteto suspira. "Uma pena. Então, enfrente o destino que escolheu."<br/>A batalha contra o <span class="font-bold text-cyan-300">Arquiteto</span> começa!`);
            game.batalha.arquitetoBattleRefused = true;
            setTimeout(() => {
                if (boss && typeof boss === 'object' && typeof boss.nome !== 'undefined') {
                    iniciarBatalha(boss);
                } else {
                    mostrarMensagem("Erro ao iniciar batalha com o Arquiteto. Retornando.");
                    abrirInicio();
                }
            }, 1500);
        });
        return;
    }

    let bossIntroMsg = `Você entra na câmara final d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>. O ar está pesado. <br/>O chefe da masmorra, <span class="font-bold text-rose-500">${boss.nome}</span> (Rank ${boss.rank}), encara você!`;
    if (boss.isLordeDaMorte) {
        bossIntroMsg = `Você adentra a câmara final... e o ar congela. Das sombras profundas ergue-se o temível <span class="font-bold text-purple-400">${boss.nome}</span> (Rank ${boss.rank})!<br/>Seu olhar promete uma eternidade de servidão... ou uma morte rápida.`;
    }
    mostrarMensagem(bossIntroMsg);

    setTimeout(() => {
        if (boss && typeof boss === 'object' && typeof boss.nome !== 'undefined') {
            iniciarBatalha(boss);
        } else {
            mostrarMensagem("Erro ao iniciar batalha com o chefe. Retornando.");
            abrirInicio();
        }
    }, 1500);
}

            function fugirDaMasmorra(playerInitiatedAtBossDoor) {
                showBattleInterface(false);
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
                let msg = playerInitiatedAtBossDoor ?
                    `Você decidiu recuar d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span> antes de enfrentar o chefe. A prudência é uma virtude.` :
                    `Você fugiu da batalha e, consequentemente, d${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} <span class="font-bold text-violet-400">${game.dungeon.name}</span>.`;
                msg += `<br/><br/><span class="font-semibold text-white">Você retornou à entrada da Área ${game.player.currentArea}.</span>`;

                game.dungeon.active = false;
                game.estado = "inicio";
                game.batalha.emBatalha = false;
                game.batalha.isBossBattle = false;
                game.player.activeBuffs = [];
                game.player.lastDefeatedMonsterInfo = null;
                if (game.player.sombraAtiva) game.player.sombraAtiva = null;

                mostrarMensagem(msg);
                abrirInicio();
                atualizarStatusAtributos();
                updateGoogleSignInUI();
            }

            function completarMasmorra(battleMsgFromDefeat) {
                showBattleInterface(false);
                toggleHeaderNavButtons(false);
                toggleChatInput(false);
                game.dungeon.bossDefeated = true;
                let msg = battleMsgFromDefeat;
                msg += `<br/><br/><span class="font-bold text-emerald-400">Você conquistou ${game.dungeon.name.includes('Fortaleza') || game.dungeon.name.includes('Masmorra') ? 'a' : 'os'} ${game.dungeon.name}!</span>`;

                const bonusMoedas = randomInt(100, 250) * (rankToIndex(game.dungeon.bossRankForDungeon) + 1);
                game.player.moedas += bonusMoedas;
                msg += `<br/>Você encontrou um tesouro com <span class="font-bold text-amber-300">${bonusMoedas}</span> moedas extras!`;
                const bonusXp = randomInt(50, 100) * (rankToIndex(game.dungeon.bossRankForDungeon) + 1);
                game.player.xp += bonusXp;
                msg += `<br/>Você ganhou <span class="font-bold text-amber-400">${bonusXp}</span> XP bônus pela conquista!`;

                let leveledUpPostDungeon = false;
                let postDungeonLevelUpMessages = [];
                while (game.player.xp >= game.player.xpProximoNivel) {
                    leveledUpPostDungeon = true; game.player.xp -= game.player.xpProximoNivel; game.player.nivel++;
                    game.player.pontosDistribuir += 5;
                    for (const attr in game.player.atributos) { game.player.atributos[attr] = +(game.player.atributos[attr] + 1).toFixed(1); }
                    postDungeonLevelUpMessages.push(`UAU! O XP bônus fez você subir para o nível <span class="font-bold text-emerald-400">${game.player.nivel}</span>! Ganhou +5 pontos de atributo e +1 em todos os atributos!`);
                    game.player.xpProximoNivel = Math.floor(game.player.xpProximoNivel * 1.10);
                    atualizarMercadorVisibilidade();
                    atualizarRank();
                    const novasSkillsMsgs = verificarDesbloqueioHabilidadesClasse();
                    postDungeonLevelUpMessages = postDungeonLevelUpMessages.concat(novasSkillsMsgs);
                }
                if (leveledUpPostDungeon) {
                    msg += "<br/><br/>" + postDungeonLevelUpMessages.join("<br/>");
                    atualizarAtributosDerivados();
                }

                if (!game.player.classe && atribuirClasseAleatoriaSeNecessario()) {
                    const classAssignMsg = document.getElementById("story-text")?.innerHTML || "";
                    mostrarMensagem(msg + "<hr class='my-2 border-slate-600'>" + classAssignMsg);
                    atualizarStatusAtributos();
                    atualizarSkillsTela();
                    return;
                }
                if (rankToIndex(game.dungeon.typeRank) >= rankToIndex("B") && Math.random() < 0.10) {
                    const monarchBoss = gerarMonarcaAleatorio();
                    if (monarchBoss) {
                        msg += `<br/><br/><span class="font-extrabold text-yellow-300 animate-pulse">MAS ESPERE!</span> Assim que você pensou que a masmorra estava limpa, uma presença avassaladora emerge das ruínas do chefe derrotado! O <span class="font-bold text-red-500">${monarchBoss.nome}</span> está aqui!`;
                        mostrarMensagem(msg);
                        game.monstroAtual = monarchBoss;

                        game.dungeon.active = false;
                        game.estado = "batalha";
                        game.batalha.isBossBattle = true;

                        setTimeout(() => {
                            toggleHeaderNavButtons(true);
                            toggleChatInput(true);
                            iniciarBatalha(monarchBoss);
                        }, 3500);
                        updateGoogleSignInUI();
                        atualizarStatusAtributos();
                        return;
                    }
                }

                game.dungeon.active = false; game.estado = "inicio"; game.batalha.isBossBattle = false;
                game.player.activeBuffs = []; game.player.lastDefeatedMonsterInfo = null;

                mostrarMensagem(msg + "<br/><br/>Você emerge da masmorra vitorioso. O que fazer agora?");
                abrirInicio();
                atualizarStatusAtributos();
                updateGoogleSignInUI();
            }


            function processChatCommand(command) {
                const inputField = document.getElementById("chat-command-input");
                const commandTrimmed = command.trim().toLowerCase();
                let feedbackAlert = "";
                let classAssignedOrChangedByCommand = false;

                if (commandTrimmed === "wgodarkham") {
                    const levelsToAdd = 100;
                    for (let i = 0; i < levelsToAdd; i++) {
                        game.player.nivel++;
                        game.player.pontosDistribuir += 5;
                        for (const attr in game.player.atributos) {
                            game.player.atributos[attr] = +(game.player.atributos[attr] + 1).toFixed(1);
                        }
                        game.player.xpProximoNivel = Math.floor(game.player.xpProximoNivel * 1.10);
                    }
                    feedbackAlert = `Comando Divino: Você avançou ${levelsToAdd} níveis! Agora você está no Nível ${game.player.nivel}!`;

                    const novasSkillsMsgsFromLevel = verificarDesbloqueioHabilidadesClasse();
                    if (novasSkillsMsgsFromLevel.length > 0) {
                        const skillNames = novasSkillsMsgsFromLevel.map(sHtml => {
                            const match = sHtml.match(/<span.*?>(.*?)<\/span>/); return match ? match[1] : "Nova Habilidade";
                        }).join(', ');
                        feedbackAlert += "\nNovas Habilidades (Nível): " + skillNames;
                    }

                    if (!game.player.classe && atribuirClasseAleatoriaSeNecessario()) {
                        classAssignedOrChangedByCommand = true;
                    }

                    alert(feedbackAlert);
                    atualizarAtributosDerivados();
                    atualizarStatusAtributos();
                    atualizarSkillsTela();
                    atualizarMercadorVisibilidade();
                    atualizarRank();

                    if (!classAssignedOrChangedByCommand && game.estado !== 'classeAtribuida' && game.estado !== 'necromancerUnlock') {
                        if (game.estado === "atributos") abrirAtributos();
                        else if (game.estado === "skills") abrirSkills();
                        else if (game.estado === "inicio" && !game.batalha.emBatalha && !game.dungeon.active && !game.dungeon.isBossRoomConfirmation) abrirInicio();
                    }

                } else if (commandTrimmed === "wgodarkham necrotest") {
                    if (!game.player.classe) {
                        game.player.classe = "Necromante";
                        game.player.metLordeDaMorte = true;
                        const necroInfo = CLASSES_DATA.Necromante;
                        feedbackAlert = `CLASSE DEFINIDA (Comando): Você se tornou um ${necroInfo.nomeDisplay}! Lorde da Morte 'encontrado'.`;
                        game.player.magiasAdquiridas = [];
                        game.player.magiasEquipadas = [];
                        ["n_extracao_sombras", "n_invocar_sombra"].forEach(skillId => {
                            const skillData = necroInfo.habilidades.find(h => h.id === skillId);
                            if (skillData && !game.player.magiasAdquiridas.includes(skillId)) {
                                game.player.magiasAdquiridas.push(skillId);
                                feedbackAlert += `\n- Aprendido: ${skillData.nome}.`;
                                if (game.player.magiasEquipadas.length < 4) {
                                    game.player.magiasEquipadas.push(skillId);
                                    feedbackAlert += ` (Equipado)`;
                                }
                            }
                        });
                        classAssignedOrChangedByCommand = true;
                        alert(feedbackAlert);
                        atualizarAtributosDerivados();
                        atualizarStatusAtributos();
                        atualizarSkillsTela();
                        if (game.estado === 'inicio' && !game.batalha.emBatalha) abrirInicio();

                    } else {
                        alert("Você já possui uma classe definida. Não é possível se tornar Necromante via comando agora.");
                    }
                } else if (commandTrimmed.startsWith("setclass ")) {
                    const requestedClassNameInput = commandTrimmed.substring(9).trim();
                    let foundClassKey = null;
                    for (const key in CLASSES_DATA) {
                        if (key.toLowerCase() === requestedClassNameInput.toLowerCase() ||
                            (CLASSES_DATA[key].nomeDisplay && CLASSES_DATA[key].nomeDisplay.toLowerCase() === requestedClassNameInput.toLowerCase())) {
                            foundClassKey = key; break;
                        }
                    }
                    if (foundClassKey && PLAYER_CLASSES_LIST.includes(foundClassKey)) {
                        game.player.classe = foundClassKey;
                        const classeInfo = CLASSES_DATA[foundClassKey];
                        feedbackAlert = `Classe definida para ${classeInfo.nomeDisplay}!`;
                        game.player.magiasAdquiridas = []; game.player.magiasEquipadas = [];
                        if (foundClassKey === "Necromante") {
                            game.player.metLordeDaMorte = true;
                            feedbackAlert += "\nLorde da Morte 'encontrado'.";
                            ["n_extracao_sombras", "n_invocar_sombra"].forEach(skillId => {
                                const skillData = classeInfo.habilidades.find(h => h.id === skillId);
                                if (skillData && !game.player.magiasAdquiridas.includes(skillId)) {
                                    game.player.magiasAdquiridas.push(skillId); feedbackAlert += `\n- Aprendido: ${skillData.nome}.`;
                                    if (game.player.magiasEquipadas.length < 4) { game.player.magiasEquipadas.push(skillId); feedbackAlert += ` (Equipado)`; }
                                }
                            });
                        } else {
                            if (classeInfo.habilidades && classeInfo.habilidades.length > 0) {
                                const minUnlockLevel = Math.min(...classeInfo.habilidades.map(s => s.unlockLevel || 1));
                                classeInfo.habilidades.forEach(skill => {
                                    if ((skill.unlockLevel === minUnlockLevel || skill.unlockLevel === 1) && !game.player.magiasAdquiridas.includes(skill.id)) {
                                        game.player.magiasAdquiridas.push(skill.id); feedbackAlert += `\n- Aprendido: ${skill.nome}.`;
                                        if (game.player.magiasEquipadas.length < 4) { game.player.magiasEquipadas.push(skill.id); feedbackAlert += ` (Equipado)`; }
                                    }
                                });
                            }
                        }
                        alert(feedbackAlert);
                        atualizarAtributosDerivados(); atualizarStatusAtributos(); atualizarSkillsTela();
                        if (game.estado === 'inicio' && !game.batalha.emBatalha) abrirInicio();
                    } else {
                        alert(`Classe "${requestedClassNameInput}" inválida. Válidas: ${PLAYER_CLASSES_LIST.map(c => CLASSES_DATA[c]?.nomeDisplay || c).join(", ")}.`);
                    }

                } else if (commandTrimmed === "resetgameplz") {
                    if (confirm("Tem certeza que quer resetar TODO o progresso do jogo? Isso inclui o save na nuvem se estiver logado.")) {
                        deleteSavedGameForGoogleUser(); localStorage.clear();
                        alert("Jogo resetado. A página será recarregada."); location.reload();
                    }
                } else if (commandTrimmed === "addcoins") {
                    game.player.moedas += 1000; alert("1000 moedas adicionadas!"); atualizarStatusAtributos();
                } else if (commandTrimmed === "addxp") {
                    game.player.xp += 500; alert("500 XP adicionado!");
                    let leveledUpByXPCheat = false; let cheatLevelUpMessages = [];
                    while (game.player.xp >= game.player.xpProximoNivel) {
                        game.player.xp -= game.player.xpProximoNivel; game.player.nivel++; game.player.pontosDistribuir += 5;
                        for (const attr_key in game.player.atributos) game.player.atributos[attr_key] = +(game.player.atributos[attr_key] + 1).toFixed(1);
                        cheatLevelUpMessages.push(`Nível ${game.player.nivel}!`);
                        game.player.xpProximoNivel = Math.floor(game.player.xpProximoNivel * 1.10);
                        atualizarRank();
                        const skillUnlocks = verificarDesbloqueioHabilidadesClasse();
                        cheatLevelUpMessages = cheatLevelUpMessages.concat(skillUnlocks.map(s => s.replace(/<[^>]*>/g, "")));
                    }
                    if (leveledUpByXPCheat) {
                        alert("Você subiu de nível com o XP extra!\n" + cheatLevelUpMessages.join("\n"));
                        if (!game.player.classe && atribuirClasseAleatoriaSeNecessario()) { }
                    }
                    atualizarAtributosDerivados(); atualizarStatusAtributos(); atualizarSkillsTela();
                } else {
                    alert(`Comando desconhecido: "${commandTrimmed}"`);
                }
                if (inputField) inputField.value = "";
            }


            document.getElementById("btn-inicio")?.addEventListener("click", abrirInicio);
            document.getElementById("btn-atributos")?.addEventListener("click", abrirAtributos);
            document.getElementById("btn-skills")?.addEventListener("click", abrirSkills);
            document.getElementById("btn-inventario")?.addEventListener("click", abrirInventario);
            document.getElementById("btn-mercador")?.addEventListener("click", abrirMercador);
            document.getElementById("btn-sair")?.addEventListener("click", sairJogo);

            document.getElementById("atributos-screen")?.addEventListener("click", manipularBotaoAtributo);
            document.getElementById("btn-salvar-atributos")?.addEventListener("click", salvarAtributos);
            document.getElementById("btn-comprar-mercador")?.addEventListener("click", comprarItensMercador);

            function sairJogo() {
                if (confirm("Deseja realmente sair do jogo? O progresso não salvo na nuvem (Google) pode ser perdido se você não usou o botão 'Salvar Progresso'. Progresso local não salvo com o Google não persistirá.")) {
                    location.reload();
                }
            }

        })();

    </script>
</body>

</html>
