<html lang="pt-BR" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aethel RPG - Jogo de Texto</title>
<script src="https://cdn.tailwindcss.com"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
/>
<style>
  /* Scrollbar for inventory and merchant */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">

<header class="bg-gradient-to-r from-indigo-900 via-purple-900 to-indigo-900 p-4 flex justify-between items-center shadow-lg sticky top-0 z-50">
  <h1 class="text-2xl font-extrabold tracking-wide select-none">Aethel RPG</h1>
  <nav class="flex space-x-4">
    <button id="btn-inicio" aria-label="Início" class="text-indigo-300 hover:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Início">
      <i class="fas fa-home fa-lg"></i>
    </button>
    <button id="btn-atributos" aria-label="Distribuir Atributos" class="text-indigo-300 hover:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Distribuir Atributos">
      <i class="fas fa-dumbbell fa-lg"></i>
    </button>
    <button id="btn-skills" aria-label="Habilidades" class="text-indigo-300 hover:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Habilidades">
      <i class="fas fa-book fa-lg"></i>
    </button>
    <button id="btn-inventario" aria-label="Inventário" class="text-indigo-300 hover:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Inventário">
      <i class="fas fa-box-open fa-lg"></i>
    </button>
    <button id="btn-mercador" aria-label="Mercador" class="text-indigo-300 hover:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded p-2 hidden" title="Mercador">
      <i class="fas fa-store fa-lg"></i>
    </button>
    <button id="btn-sair" aria-label="Sair do Jogo" class="text-red-400 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-400 rounded p-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Sair do Jogo">
      <i class="fas fa-sign-out-alt fa-lg"></i>
    </button>
  </nav>
</header>

<div class="flex-1 flex flex-col overflow-hidden">

    <main id="main-content" class="flex-1 p-6 overflow-y-auto max-h-screen">
        <section id="game-screen" class="max-w-4xl mx-auto space-y-6">
      <div id="story-text" class="bg-gray-800 rounded-lg p-6 text-lg leading-relaxed min-h-[180px] select-text"></div>
      <div id="choices" class="flex flex-col space-y-3"></div>
    </section>

        <section id="atributos-screen" class="max-w-4xl mx-auto space-y-6 hidden">
      <h2 class="text-2xl font-bold mb-4 text-indigo-300">Distribuir Atributos</h2>
      <div class="bg-gray-800 rounded-lg p-4 mb-6">
        <h3 class="text-xl font-semibold text-indigo-400 mb-3">Status do Jogador</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-indigo-300 text-sm select-none">
          <div><i class="fas fa-heart text-red-500"></i> Vida: <span id="status-vida">0</span></div>
          <div><i class="fas fa-bolt text-blue-400"></i> Mana: <span id="status-mana">0</span></div>
          <div><i class="fas fa-star text-yellow-400"></i> Rank: <span id="status-rank">E</span></div>
          <div><i class="fas fa-level-up-alt text-green-400"></i> Nível: <span id="status-nivel">1</span></div>
          <div><i class="fas fa-dice-d20 text-purple-400"></i> XP: <span id="status-xp">0</span> / <span id="status-xpProximo">100</span></div>
          <div><i class="fas fa-coins text-yellow-300"></i> Moedas: <span id="status-moedas">0</span></div>
          <div><i class="fas fa-user-tag text-indigo-400"></i> Classe: <span id="status-classe">Nenhuma</span></div>
        </div>
        <div class="mt-4 border-t border-gray-700 pt-4">
            <h3 class="text-xl font-semibold text-indigo-400 mb-3">Bônus Atuais</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-300 text-sm select-none">
                <div>Dano Físico: <span id="bonus-dano-fisico">0</span></div>
                <div>Vida Máxima: <span id="bonus-vida-max">0</span></div>
                <div>Mana Máxima: <span id="bonus-mana-max">0</span></div>
                <div>Redução de Dano: <span id="bonus-resistencia">0</span>%</div>
                <div>Chance de Fuga: <span id="bonus-fuga">0</span>%</div>
                <div>Chance de Esquiva: <span id="bonus-esquiva">0</span>%</div>
                <div>Dano Mágico: <span id="bonus-dano-magico">0</span></div>
            </div>
        </div>
      </div>
      <p class="mb-2">Você tem <span id="pontos-disponiveis" class="font-semibold text-indigo-400">0</span> pontos para distribuir.</p>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center space-y-2">
          <span class="font-semibold text-indigo-300">Força</span>
          <div class="flex items-center space-x-2">
            <button data-attr="forca" data-action="dec" class="btn-attr px-3 py-1 rounded bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 text-white"><i class="fas fa-minus"></i></button>
            <span id="forca-val" class="w-8 text-center font-mono">0</span>
            <button data-attr="forca" data-action="inc" class="btn-attr px-3 py-1 rounded bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 text-white"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center space-y-2">
          <span class="font-semibold text-indigo-300">Agilidade</span>
          <div class="flex items-center space-x-2">
            <button data-attr="agilidade" data-action="dec" class="btn-attr px-3 py-1 rounded bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 text-white"><i class="fas fa-minus"></i></button>
            <span id="agilidade-val" class="w-8 text-center font-mono">0</span>
            <button data-attr="agilidade" data-action="inc" class="btn-attr px-3 py-1 rounded bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 text-white"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center space-y-2">
          <span class="font-semibold text-indigo-300">Inteligência / Mana</span>
          <div class="flex items-center space-x-2">
            <button data-attr="inteligencia" data-action="dec" class="btn-attr px-3 py-1 rounded bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 text-white"><i class="fas fa-minus"></i></button>
            <span id="inteligencia-val" class="w-8 text-center font-mono">0</span>
            <button data-attr="inteligencia" data-action="inc" class="btn-attr px-3 py-1 rounded bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 text-white"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center space-y-2">
          <span class="font-semibold text-indigo-300">Resistência</span>
          <div class="flex items-center space-x-2">
            <button data-attr="resistencia" data-action="dec" class="btn-attr px-3 py-1 rounded bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 text-white"><i class="fas fa-minus"></i></button>
            <span id="resistencia-val" class="w-8 text-center font-mono">0</span>
            <button data-attr="resistencia" data-action="inc" class="btn-attr px-3 py-1 rounded bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 text-white"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center space-y-2">
          <span class="font-semibold text-indigo-300">Vitalidade</span>
          <div class="flex items-center space-x-2">
            <button data-attr="vitalidade" data-action="dec" class="btn-attr px-3 py-1 rounded bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 text-white"><i class="fas fa-minus"></i></button>
            <span id="vitalidade-val" class="w-8 text-center font-mono">0</span>
            <button data-attr="vitalidade" data-action="inc" class="btn-attr px-3 py-1 rounded bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 text-white"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center space-y-2">
          <span class="font-semibold text-indigo-300">Percepção</span>
          <div class="flex items-center space-x-2">
            <button data-attr="percepcao" data-action="dec" class="btn-attr px-3 py-1 rounded bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 text-white"><i class="fas fa-minus"></i></button>
            <span id="percepcao-val" class="w-8 text-center font-mono">0</span>
            <button data-attr="percepcao" data-action="inc" class="btn-attr px-3 py-1 rounded bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 text-white"><i class="fas fa-plus"></i></button>
          </div>
        </div>
      </div>
      <button id="btn-salvar-atributos" class="mt-6 bg-indigo-600 hover:bg-indigo-700 rounded px-6 py-2 font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-400">Salvar Atributos</button>
    </section>

        <section id="skills-screen" class="max-w-4xl mx-auto space-y-6 hidden">
      <h2 class="text-2xl font-bold mb-4 text-indigo-300">Habilidades</h2>
      <p class="mb-4">Aqui estão as magias que você adquiriu e equipou. Use-as nas batalhas para causar dano mágico.</p>
      <div id="lista-skills" class="bg-gray-800 rounded-lg p-4 max-h-[400px] overflow-y-auto space-y-4">
      </div>
      <p class="mt-4 text-sm text-indigo-400 italic">Você pode adquirir novas magias ao subir de nível. Magias de rank mais alto são mais poderosas, raras e gastam mais mana.</p>
    </section>

        <section id="inventario-screen" class="max-w-4xl mx-auto space-y-6 hidden">
      <h2 class="text-2xl font-bold mb-4 text-indigo-300">Inventário</h2>
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1 bg-gray-800 rounded-lg p-4 max-h-[400px] overflow-y-auto">
          <h3 class="font-semibold mb-2 text-indigo-400">Itens</h3>
          <ul id="lista-itens" class="space-y-2 text-sm"></ul>
        </div>
        <div class="flex-1 bg-gray-800 rounded-lg p-4 max-h-[400px] overflow-y-auto">
          <h3 class="font-semibold mb-2 text-indigo-400">Equipamentos</h3>
          <div class="space-y-4">
            <div>
              <span class="font-semibold">Armadura:</span>
              <div id="equip-armadura" class="mt-1 text-sm text-gray-300 italic">Nenhuma equipada</div>
            </div>
            <div>
              <span class="font-semibold">Espada:</span>
              <div id="equip-espada" class="mt-1 text-sm text-gray-300 italic">Nenhuma equipada</div>
            </div>
            <div>
              <span class="font-semibold">Anel:</span>
              <div id="equip-anel" class="mt-1 text-sm text-gray-300 italic">Nenhum equipado</div>
            </div>
            <div>
              <span class="font-semibold">Colar:</span>
              <div id="equip-colar" class="mt-1 text-sm text-gray-300 italic">Nenhum equipado</div>
            </div>
          </div>
        </div>
      </div>
    </section>

        <section id="mercador-screen" class="max-w-4xl mx-auto space-y-6 hidden">
      <h2 class="text-2xl font-bold mb-4 text-indigo-300">Mercador</h2>
      <p class="mb-4">O mercador aparece a cada 5 níveis e oferece itens para venda.</p>
      <div class="bg-gray-800 rounded-lg p-4 max-h-[400px] overflow-y-auto">
        <ul id="lista-mercador" class="space-y-4"></ul>
      </div>
      <button id="btn-comprar-mercador" class="mt-4 bg-green-600 hover:bg-green-700 rounded px-6 py-2 font-semibold focus:outline-none focus:ring-2 focus:ring-green-400 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Comprar Selecionados</button>
    </section>
  </main>
</div>

<script>
(() => {
  "use strict";

  const RANKS = ["E", "D", "C", "B", "A", "S"];
  const RANK_MIN_TOTAL = {
    E: 20,
    D: 100,
    C: 200,
    B: 300,
    A: 400,
    S: 600,
  };
  const BASE_STATS = {
    forca: 0,
    agilidade: 0,
    inteligencia: 0,
    resistencia: 0,
    vitalidade: 0,
    percepcao: 0,
  };
  const BASE_HP = 100;
  const BASE_MANA = 10;
  const BASE_DANO_FISICO = 10;
  const BASE_DANO_MAGICO = 10;
  const BASE_RESISTENCIA = 0;
  const FUGIR_PCT_DECREMENTO = 0.07;
  // const XP_BASE_MIN = 5; // Not directly used for new monster XP calculation logic
  // const XP_BASE_MAX = 10; // Not directly used for new monster XP calculation logic
  // const XP_RANK_MULTIPLIER = 0.1; // Not directly used for new monster XP calculation logic
  const XP_BONUS_GLOBAL = 1.0; // MODIFIED: Increased XP Bonus to 100%

  // MODIFIED: Mana cost scaling based on user request
  const MANA_GASTO_PCT = {
    E: 0.10, // Rank E: 10% of total mana
    D: 0.15, // Rank D: 15%
    C: 0.20, // Rank C: 20%
    B: 0.25, // Rank B: 25%
    A: 0.30, // Rank A: 30%
    S: 0.35, // Rank S: 35%
  };
  const CLASSES = ["Guerreiro", "Arqueiro", "Mago", "Assassino", "Paladino", "Bardo", ];

  const ITEM_RANKS = ["E", "D", "C", "B", "A", "S"];
  const ITEM_BASE_PRICE = {
    E: 10,
    D: 25,
    C: 50,
    B: 100,
    A: 200,
    S: 400,
  };

  const ITEM_ATRIBUTOS_POR_RANK = {
    E: { min: 1, max: 3 },
    D: { min: 3, max: 5 },
    C: { min: 5, max: 7 },
    B: { min: 7, max: 10 },
    A: { min: 15, max: 20 },
    S: { min: 30, max: 40 },
  };

  const MAGIAS_POSSIVEIS = [ // manaBase is no longer directly used for cost calculation by calcularGastoMana
    { id: "fireball", nome: "Bola de Fogo", rank: "E", danoBase: 15, manaBase: 30 },
    { id: "ice_shard", nome: "Fragmento de Gelo", rank: "D", danoBase: 25, manaBase: 50 },
    { id: "lightning_strike", nome: "Golpe de Raio", rank: "C", danoBase: 40, manaBase: 60 },
    { id: "arcane_blast", nome: "Explosão Arcana", rank: "B", danoBase: 60, manaBase: 80 },
    { id: "meteor", nome: "Meteoro", rank: "A", danoBase: 90, manaBase: 120 },
    { id: "divine_wrath", nome: "Ira Divina", rank: "S", danoBase: 130, manaBase: 200 },
  ];

  const POTIONS = {
    drop: {
      id: "potion_drop", // This ID is used for stacking
      nome: "Poção Básica",
      curaVidaPct: 0.4, // Corrected to 0.4 as per description
      curaManaPct: 0.2, // Corrected to 0.2 as per description
      descricao: "Recupera 40% da vida e 20% da mana.",
    },
    compra: {
      id: "potion_compra", // This ID is used for stacking
      nome: "Poção Avançada",
      curaVidaPct: 0.7,
      curaManaPct: 0.5,
      descricao: "Recupera 70% da vida e 50% da mana.",
    }
  };

  // Dungeon Configuration
  const DUNGEON_CONFIG = {
    "E": { // Rank E Dungeon
        name: "Masmorra Esquecida",
        roomsMin: 4,
        roomsMax: 6,
        monsterRank: "D", // Monsters in E dungeon are Rank D
        bossRank: "C",     // Boss in E dungeon is Rank C
        bossBaseStats: {
            vidaMin: 280, vidaMax: 350,   // C Rank Boss stats
            danoMin: 25, danoMax: 40,
            xpMin: 120, xpMax: 180,
        }
    },
    "D": { // Rank D Dungeon
        name: "Covil Profundo",
        roomsMin: 5,
        roomsMax: 7,
        monsterRank: "C", // Monsters in D dungeon are Rank C
        bossRank: "B",     // Boss in D dungeon is Rank B
        bossBaseStats: {
            vidaMin: 550, vidaMax: 700,   // B Rank Boss stats
            danoMin: 45, danoMax: 65,
            xpMin: 350, xpMax: 500,
        }
    },
    "C": { // Rank C Dungeon
        name: "Cidadela Sombria",
        roomsMin: 6,
        roomsMax: 8,
        monsterRank: "B", // Monsters in C dungeon are Rank B
        bossRank: "A",     // Boss in C dungeon is Rank A
        bossBaseStats: {
            vidaMin: 900, vidaMax: 1100,  // A Rank Boss stats
            danoMin: 70, danoMax: 95,
            xpMin: 700, xpMax: 1000,
        }
    },
    "B": { // Rank B Dungeon
        name: "Fortaleza Dracônica",
        roomsMin: 7,
        roomsMax: 9,
        monsterRank: "A", // Monsters in B dungeon are Rank A
        bossRank: "S",     // Boss in B dungeon is Rank S
        bossBaseStats: { // Using provided S rank boss stats from original example
            vidaMin: 1000, vidaMax: 2280, // S Rank Boss stats
            danoMin: 100, danoMax: 155,
            xpMin: 1400, xpMax: 2500, // Adjusted max slightly from original 5500 for smoother curve with monster XP
        }
    },
    "A": { // Rank A Dungeon
        name: "Abismo Infernal",
        roomsMin: 8,
        roomsMax: 10,
        monsterRank: "S", // Monsters in A dungeon are Rank S
        bossRank: "S",     // Boss in A dungeon is also Rank S (can be stronger variant)
        bossBaseStats: {
            vidaMin: 1800, vidaMax: 3000, // Stronger S Rank Boss stats
            danoMin: 150, danoMax: 220,
            xpMin: 2000, xpMax: 3500,
        }
    },
    "S": { // Rank S Dungeon
        name: "Domínio Celestial Despedaçado",
        roomsMin: 9,
        roomsMax: 12,
        monsterRank: "S", // Monsters are super strong S
        bossRank: "S",     // Boss is an ultimate S rank variant
        bossBaseStats: {
            vidaMin: 3000, vidaMax: 5500, // Ultimate S Rank Boss stats
            danoMin: 250, danoMax: 350,
            xpMin: 4000, xpMax: 6000,
        }
    }
    // Future dungeon ranks can be added here
  };


  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
  function randomChoice(arr) {
    return arr[randomInt(0, arr.length - 1)];
  }
  function clamp(num, min, max) {
    return Math.min(Math.max(num, min), max);
  }
  function rankToIndex(rank) {
    return RANKS.indexOf(rank);
  }
  function indexToRank(index) {
    return RANKS[clamp(index, 0, RANKS.length - 1)];
  }

  let game = {
    player: {
      nome: "Herói",
      classe: null, // Initialized to null, will be set by iniciarJogo or class unlock logic
      nivel: 1,
      xp: 0,
      xpProximoNivel: 100,
      rank: "E",
      atributos: { ...BASE_STATS },
      pontosDistribuir: 0,
      vidaMax: BASE_HP,
      vidaAtual: BASE_HP,
      manaMax: BASE_MANA,
      manaAtual: BASE_MANA,
      danoFisicoBase: BASE_DANO_FISICO,
      danoMagicoBase: BASE_DANO_MAGICO,
      resistenciaPct: BASE_RESISTENCIA,
      refinoMagicoPct: 0,
      percepcaoPct: 0,
      agilidadePctFuga: 0,
      forcaPctDano: 0,
      vitalidadePctVida: 0,
      inventario: [], // Will store objects with { ...itemProps, quantity: X }
      equipamento: {
        armadura: null,
        espada: null,
        anel: null,  
        colar: null,  
      },
      moedas: 100,
      rodadas: 0,
      xpBonus: XP_BONUS_GLOBAL,  
      classeLiberada: false,
      magiasAdquiridas: [],
      magiasEquipadas: [],
      currentArea: "E",
      currentDanoFisico: BASE_DANO_FISICO,
      currentReducaoDano: BASE_RESISTENCIA,
      currentChanceFuga: 0,
      currentChanceEsquiva: 0,
      currentDanoMagico: BASE_DANO_MAGICO,
    },
    mundo: "Aethel",
    estado: "inicio", // Can be: inicio, batalha, atributos, inventario, mercador, skills, dungeon, boss_confirmation
    monstroAtual: null,
    batalha: {
      emBatalha: false,
      monstro: null,
      turnoJogador: true,
      danoRecebido: 0,
      isBossBattle: false, // New: Flag for boss battles
    },
    mercador: {
      itens: [], // Mercador items are individual, stacking happens on purchase
      selecionados: new Set(),
    },
    dungeon: { // New: Dungeon state
        active: false,
        name: "",  
        typeRank: "E",  
        totalRooms: 0,
        currentRoom: 0,
        monsterRankForRooms: "D",  
        bossRankForDungeon: "C",  
        bossDefeated: false,
        isBossRoomConfirmation: false,  
    }
  };

  const MONSTRO_NOMES = {
    E: ["Goblin Fraco", "Rato Gigante", "Lobo Selvagem", "Esqueleto Fraco", "Aranha Venenosa"],
    D: ["Goblin Guerreiro", "Lobo Alfa", "Esqueleto Guerreiro", "Aranha Gigante", "Zumbi"],
    C: ["Orc Brutal", "Troll", "Mago Sombrio", "Lobo Fantasma", "Zumbi Corrompido", "Guardião da Masmorra"], // Added a generic boss name
    B: ["Orc Chefe", "Troll Ancião", "Mago Negro", "Dragão Jovem", "Zumbi Rei", "Grão-Guardião"],
    A: ["Dragão Adulto", "Lorde Orc", "Mago Supremo", "Demônio Menor", "Zumbi Lendário", "Protetor Ancestral"],
    S: ["Dragão Ancião", "Lorde Demônio", "Mago Lendário", "Deus Caído", "Zumbi Imortal", "Avatar da Destruição"],
  };

  function gerarMonstro(rank) {
    const rankIndex = rankToIndex(rank); // E=0, D=1, C=2, B=3, A=4, S=5
    const nome = randomChoice(MONSTRO_NOMES[rank]);

    // SCALED: Monster Health
    const vidaMax = Math.floor(50 * Math.pow(1.9, rankIndex) + randomInt(0, 20 * Math.pow(1.6, rankIndex)));

    // SCALED: Monster Damage Calculation
    const baseDanoFisicoRankE = 8; // Slightly lowered base to make early game less punishing with new scaling
    let calculatedDanoFisico = (rank === "E") ? baseDanoFisicoRankE : Math.floor(baseDanoFisicoRankE * Math.pow(1.85, rankIndex));
    const danoFisico = Math.max(1, calculatedDanoFisico + randomInt(Math.floor(-calculatedDanoFisico * 0.15), Math.floor(calculatedDanoFisico * 0.15)));

    const baseDanoMagicoProportion = 0.6; 
    const baseDanoMagicoRankE = Math.max(1, Math.floor(baseDanoFisicoRankE * baseDanoMagicoProportion)); 
    let calculatedDanoMagico = (rank === "E") ? baseDanoMagicoRankE : Math.floor(baseDanoMagicoRankE * Math.pow(1.85, rankIndex));
    const danoMagico = Math.max(0, calculatedDanoMagico + randomInt(Math.floor(-calculatedDanoMagico * 0.15), Math.floor(calculatedDanoMagico * 0.15)));

    // SCALED: XP Gain Calculation (Higher rank monsters give more XP)
    const baseXpRankE = 10; // Adjusted base XP
    const xpGanho = (rank === "E") ? baseXpRankE : Math.floor(baseXpRankE * Math.pow(2.3, rankIndex));
    
    const fugaPct = clamp(0.67 - 0.07 * rankIndex, 0.05, 0.67); 
    return { nome, rank, vidaMax, vidaAtual: vidaMax, danoFisico, danoMagico, xpGanho, fugaPct, isBoss: false };
  }

  // New: Generates monsters specifically for dungeon rooms (not bosses)
  function gerarMonstroMasmorra(monsterRank) {
    const monstro = gerarMonstro(monsterRank); // Use existing monster generation
    monstro.xpGanho = Math.floor(monstro.xpGanho * 1.1); // Slightly more XP for dungeon mobs
    // Dungeon monsters could have slightly higher stats if desired, e.g.:
    // monstro.vidaMax = Math.floor(monstro.vidaMax * 1.05);
    // monstro.vidaAtual = monstro.vidaMax;
    // monstro.danoFisico = Math.floor(monstro.danoFisico * 1.05);
    return monstro;
  }
  
  // New: Calculates stat multiplier for bosses based on their rank compared to C
  // This function seems less critical if bossBaseStats in DUNGEON_CONFIG are already well-scaled per rank.
  // However, it can be used if a dungeon of a certain rank wants to feature a boss of a *different* rank.
  function getBossStatMultiplier(targetBossRank) {
    const baseCRankIndex = rankToIndex("C");
    const targetBossRankIndex = rankToIndex(targetBossRank);
    const diff = targetBossRankIndex - baseCRankIndex;

    if (diff === 0) return 1.0; // Rank C is base
    if (diff === -1) return 0.8; // Rank D boss (0.8x of C)
    if (diff === -2) return 0.6; // Rank E boss (0.6x of C)

    // Scaling up from C
    let multiplier = 1.0;
    if (diff >= 1) multiplier *= 1.5; // For Rank B (C -> B)
    if (diff >= 2) multiplier *= 2.0; // For Rank A (B -> A, effectively 1.5 * 2.0 = 3.0 from C)
    if (diff >= 3) multiplier *= 2.5; // For Rank S (A -> S, effectively 3.0 * 2.5 = 7.5 from C)
    
    return multiplier;
  }

  // New: Generates the dungeon boss
  function gerarBossMasmorra(dungeonTypeRank, actualBossRank) {
    const config = DUNGEON_CONFIG[dungeonTypeRank]; // Config of the dungeon itself
    // The actualBossRank is specified by the dungeon's config.bossRank
    // So, we use the bossBaseStats from the dungeon's own rank configuration.

    if (!config || !config.bossBaseStats) {
        console.error(`Configuração de bossBaseStats não encontrada para dungeon rank ${dungeonTypeRank}`);
        // Fallback to a generic C rank boss if config is missing for the dungeonTypeRank
        const fallbackBossRank = actualBossRank || "C";
        const fallbackStats = DUNGEON_CONFIG["E"].bossBaseStats; // Default to E dungeon's C boss stats as a last resort
        return { 
            ...gerarMonstro(fallbackBossRank), 
            nome: `Boss ${fallbackBossRank} Desconhecido`, 
            isBoss: true, 
            vidaMax: fallbackStats.vidaMin, 
            vidaAtual: fallbackStats.vidaMin, 
            danoFisico: fallbackStats.danoMin, 
            danoMagico: Math.floor(fallbackStats.danoMin * 0.3), 
            xpGanho: fallbackStats.xpMin 
        };
    }

    // Use the specific bossBaseStats defined for this dungeonTypeRank
    const baseStats = config.bossBaseStats; 
    // The actualBossRank is ALREADY factored into the selection of baseStats if DUNGEON_CONFIG is set up correctly.
    // The multiplier might be redundant if each rank in DUNGEON_CONFIG has its own well-defined boss stats.
    // Let's assume actualBossRank IS config.bossRank.
    // If we still want to use getBossStatMultiplier, it should compare actualBossRank to the rank the baseStats *represent*.
    // For simplicity, we'll assume baseStats in DUNGEON_CONFIG[dungeonTypeRank] are for the config.bossRank.

    const nome = randomChoice(MONSTRO_NOMES[actualBossRank] || [`Boss ${actualBossRank}`]);
    const vidaMax = randomInt(baseStats.vidaMin, baseStats.vidaMax);
    const danoFisico = randomInt(baseStats.danoMin, baseStats.danoMax);
    const danoMagico = Math.floor(danoFisico * randomInt(30,70) / 100); // Bosses have some magic damage, more variable
    const xpGanho = randomInt(baseStats.xpMin, baseStats.xpMax);

    return {
        nome: `${nome} (Boss da Masmorra)`,
        rank: actualBossRank,
        vidaMax,
        vidaAtual: vidaMax,
        danoFisico,
        danoMagico, 
        xpGanho,
        fugaPct: 0, // Cannot flee from boss
        isBoss: true,
    };
  }


  const ITEM_PREFIXOS = {
    E: ["Simples", "Rústico", "Comum", "Velho", "Frágil"],
    D: ["Robusto", "Resistente", "Forte", "Ágil", "Místico"],
    C: ["Encantado", "Sagrado", "Veloz", "Poderoso", "Duradouro"],
    B: ["Épico", "Lendário", "Mágico", "Imponente", "Vibrante"],
    A: ["Divino", "Celestial", "Supremo", "Inquebrável", "Radiante"],
    S: ["Ancestral", "Mítico", "Eterno", "Soberano", "Infinito"],
  };

  const ITEM_TIPOS_EQUIP = ["Armadura", "Espada", "Anel", "Colar"];  
  const ITEM_TIPOS_ALL = [...ITEM_TIPOS_EQUIP, "Poção"];

  function gerarItem(rank) {
    const tipo = Math.random() < 0.7 ? randomChoice(ITEM_TIPOS_EQUIP) : "Poção";
    
    if (tipo === "Poção") {
      const tipoPocao = Math.random() < 0.5 ? "drop" : "compra"; // Merchant more likely to sell "compra"
      const pocaoBase = POTIONS[tipoPocao];
      return {
        id: pocaoBase.id, 
        nome: pocaoBase.nome,
        tipo: "Poção",
        rank: rank,  // Potions can also have ranks, affecting sell price if nothing else
        efeitos: {}, 
        preco: tipoPocao === "compra" ? 50 : (ITEM_BASE_PRICE[rank] || 10), 
        curaVidaPct: pocaoBase.curaVidaPct,
        curaManaPct: pocaoBase.curaManaPct,
        descricao: pocaoBase.descricao,
        isPotion: true,
      };
    }

    // Equipment generation
    const prefixo = randomChoice(ITEM_PREFIXOS[rank]);
    const nome = `${prefixo} ${tipo}`;
    const efeitos = {};
    const { min, max } = ITEM_ATRIBUTOS_POR_RANK[rank];
    const pontos = randomInt(min, max);

    switch (tipo) {
      case "Armadura":
        efeitos.resistencia = pontos;
        efeitos.vitalidade = randomInt(Math.floor(min / 2), Math.floor(max / 2));  
        break;
      case "Espada":
        efeitos.forca = pontos;
        break;
      case "Anel":
        efeitos.inteligencia = pontos;  
        break;
      case "Colar":
        efeitos.agilidade = pontos;
        efeitos.percepcao = randomInt(Math.floor(min / 2), Math.floor(max / 2));  
        break;
    }

    const preco = ITEM_BASE_PRICE[rank] * (1 + Math.random() * 0.5 + rankToIndex(rank) * 0.1); // Price variation
    return {
      id: crypto.randomUUID(), 
      nome,
      tipo,
      rank,
      efeitos,
      preco: Math.floor(preco),
      isPotion: false,
    };
  }

  function itemsAreIdentical(item1, item2) {
    if (item1.isPotion && item2.isPotion) {
        return item1.id === item2.id;
    }
    if (!item1.isPotion && !item2.isPotion) {
        if (item1.nome !== item2.nome || item1.tipo !== item2.tipo || item1.rank !== item2.rank) {
            return false;
        }
        const effects1 = item1.efeitos || {};
        const effects2 = item2.efeitos || {};
        const keys1 = Object.keys(effects1).sort();
        const keys2 = Object.keys(effects2).sort();
        if (keys1.length !== keys2.length) return false;
        for (let i = 0; i < keys1.length; i++) {
            if (keys1[i] !== keys2[i] || effects1[keys1[i]] !== effects2[keys2[i]]) {
                return false;
            }
        }
        return true;
    }
    return false; 
}

function addItemToInventory(itemToAdd) {
    let foundStack = false;
    for (let invItem of game.player.inventario) {
        if (itemsAreIdentical(invItem, itemToAdd)) {
            invItem.quantity = (invItem.quantity || 1) + 1;
            foundStack = true;
            break;
        }
    }
    if (!foundStack) {
        game.player.inventario.push({ ...itemToAdd, quantity: 1 });
    }
}


  function atualizarRank() {
    const total = Object.values(game.player.atributos).reduce((a, b) => a + b, 0);
    let novoRank = "E";
    for (let i = RANKS.length - 1; i >= 0; i--) {
      if (total >= RANK_MIN_TOTAL[RANKS[i]]) {
        novoRank = RANKS[i];
        break;
      }
    }
    if (novoRank !== game.player.rank) {
      game.player.rank = novoRank;
      // MODIFICATION: Changed level requirement for class unlock check (using 10 as it's the new travel threshold)
      if (game.player.nivel >= 10 && !game.player.classe && rankToIndex(novoRank) >= rankToIndex("D")) {
        game.player.classe = randomChoice(CLASSES);
          setTimeout(() => mostrarMensagem( 
            `Parabéns! Você alcançou o nível ${game.player.nivel} e rank ${novoRank}, desbloqueando a classe <span class="font-bold text-indigo-400">${game.player.classe}</span>!`
          ), 50); 
      }
    }
  }

  function atualizarAtributosDerivados() {
    const a = game.player.atributos;
    let tempForca = a.forca;
    let tempAgilidade = a.agilidade;
    let tempInteligencia = a.inteligencia;
    let tempResistencia = a.resistencia;
    let tempVitalidade = a.vitalidade;
    let tempPercepcao = a.percepcao;

    for (const equipSlot in game.player.equipamento) {
      const equip = game.player.equipamento[equipSlot];
      if (equip) {
        for (const [attr, val] of Object.entries(equip.efeitos)) {
          switch(attr) {
            case 'forca': tempForca += val; break;
            case 'agilidade': tempAgilidade += val; break;
            case 'inteligencia': tempInteligencia += val; break;
            case 'resistencia': tempResistencia += val; break;
            case 'vitalidade': tempVitalidade += val; break;
            case 'percepcao': tempPercepcao += val; break;
          }
        }
      }
    }

    const vitalidadeBonusVida = tempVitalidade * 2; // MODIFIED: Cada 1 ponto de vitalidade aumenta 2 na vida total
    game.player.vidaMax = Math.floor(BASE_HP + vitalidadeBonusVida);
    game.player.vidaAtual = Math.min(game.player.vidaAtual, game.player.vidaMax);  
    game.player.vitalidadePctVida = vitalidadeBonusVida;  

    const inteligenciaBonusMana = tempInteligencia * 10;  
    game.player.manaMax = Math.floor(BASE_MANA + inteligenciaBonusMana);
    game.player.manaAtual = Math.min(game.player.manaAtual, game.player.manaMax);

    const forcaBonusDano = tempForca * 0.5;  
    game.player.currentDanoFisico = BASE_DANO_FISICO + forcaBonusDano;
    game.player.forcaPctDano = forcaBonusDano / BASE_DANO_FISICO;  

    const resistenciaBonusPct = tempResistencia * 0.1;  
    game.player.currentReducaoDano = resistenciaBonusPct;  
    game.player.resistenciaPct = resistenciaBonusPct / 100;  

    const agilidadeBonusFuga = tempAgilidade * 0.05;  
    game.player.currentChanceFuga = agilidadeBonusFuga;  
    game.player.agilidadePctFuga = agilidadeBonusFuga / 100;  

    const percepcaoBonusEsquiva = tempPercepcao * 0.05;  
    game.player.currentChanceEsquiva = percepcaoBonusEsquiva;  
    game.player.percepcaoPct = percepcaoBonusEsquiva / 100;  

    const inteligenciaBonusDanoMagico = tempInteligencia * 0.5;  
    game.player.currentDanoMagico = BASE_DANO_MAGICO + inteligenciaBonusDanoMagico;  
    game.player.danoMagicoBase = BASE_DANO_MAGICO + inteligenciaBonusDanoMagico;
    
    game.player.refinoMagicoPct = 0;  
    aplicarEfeitosEquipamento();  
  }


  function calcularDanoFisico() {
    return Math.floor(game.player.currentDanoFisico);
  }
  function calcularDanoMagico(magia) {
    return Math.floor(game.player.currentDanoMagico + magia.danoBase);
  }

  function calcularDanoRecebido(dano) {
    const danoReduzido = dano * (1 - game.player.resistenciaPct);
    return Math.max(1, Math.floor(danoReduzido));
  }

  function calcularChanceFuga(monstro) {
    if (monstro.isBoss) return 0; 
    const rankIndex = rankToIndex(monstro.rank);
    const baseFuga = clamp(0.67 - 0.07 * rankIndex, 0.05, 0.67);
    return clamp(baseFuga + game.player.agilidadePctFuga, 0, 1);
  }

  function calcularGastoMana(magia) { 
    const pctCusto = MANA_GASTO_PCT[magia.rank]; // Uses the updated MANA_GASTO_PCT
    const custoBase = game.player.manaMax * pctCusto;
    return Math.max(1, Math.floor(custoBase * (1 - game.player.refinoMagicoPct)));
  }

  function atualizarStatusAtributos() {
    document.getElementById("status-vida").textContent = `${game.player.vidaAtual} / ${game.player.vidaMax}`;
    document.getElementById("status-mana").textContent = `${game.player.manaAtual} / ${game.player.manaMax}`;
    document.getElementById("status-rank").textContent = game.player.rank;
    document.getElementById("status-nivel").textContent = game.player.nivel;
    document.getElementById("status-xp").textContent = game.player.xp;
    document.getElementById("status-xpProximo").textContent = game.player.xpProximoNivel;
    document.getElementById("status-moedas").textContent = game.player.moedas;
    document.getElementById("status-classe").textContent = game.player.classe || "Nenhuma";

    document.getElementById("bonus-dano-fisico").textContent = game.player.currentDanoFisico.toFixed(1);
    document.getElementById("bonus-vida-max").textContent = game.player.vidaMax;
    document.getElementById("bonus-mana-max").textContent = game.player.manaMax;
    document.getElementById("bonus-resistencia").textContent = (game.player.currentReducaoDano).toFixed(2);  
    document.getElementById("bonus-fuga").textContent = (game.player.currentChanceFuga * 100).toFixed(2); // Display as percentage
    document.getElementById("bonus-esquiva").textContent = (game.player.currentChanceEsquiva * 100).toFixed(2); // Display as percentage
    document.getElementById("bonus-dano-magico").textContent = game.player.currentDanoMagico.toFixed(1);
  }

  function mostrarMensagem(html) {
    const storyText = document.getElementById("story-text");
    storyText.innerHTML = html;
  }

  function limparEscolhas() {
    const choices = document.getElementById("choices");
    choices.innerHTML = "";
  }

  function adicionarEscolha(texto, callback, disabled = false) {
    const choices = document.getElementById("choices");
    const btn = document.createElement("button");
    if (disabled) {
        btn.className = "bg-gray-600 rounded px-4 py-2 font-semibold cursor-default text-gray-400";
        btn.disabled = true;
    } else {
        btn.className = "bg-indigo-700 hover:bg-indigo-600 rounded px-4 py-2 font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-400";
    }
    btn.innerHTML = texto;
    if (callback && !disabled) {
        btn.addEventListener("click", () => {
          limparEscolhas();
          callback();
        });
    }
    choices.appendChild(btn);
  }

  function toggleHeaderNavButtons(disable) {
    const btnIds = ["btn-inicio", "btn-atributos", "btn-skills", "btn-inventario", "btn-sair"];
    btnIds.forEach(id => {
      const button = document.getElementById(id);
      if (button) {
        button.disabled = disable;
      }
    });
  }

  function iniciarJogo() {
    toggleHeaderNavButtons(false); // Ensure buttons are enabled at game start
    game.estado = "inicio";
    game.player.nivel = 1;
    game.player.xp = 0;
    game.player.xpProximoNivel = 100;
    game.player.rank = "E";
    game.player.atributos = { ...BASE_STATS };
    game.player.pontosDistribuir = 115; // Initial points
    game.player.vidaMax = BASE_HP;
    game.player.vidaAtual = BASE_HP;
    game.player.manaMax = BASE_MANA;
    game.player.manaAtual = BASE_MANA;
    game.player.danoFisicoBase = BASE_DANO_FISICO;
    game.player.danoMagicoBase = BASE_DANO_MAGICO;
    game.player.resistenciaPct = BASE_RESISTENCIA;
    game.player.refinoMagicoPct = 0;
    game.player.percepcaoPct = 0;
    game.player.agilidadePctFuga = 0;
    game.player.forcaPctDano = 0;
    game.player.vitalidadePctVida = 0;
    game.player.inventario = [];
    game.player.equipamento = { armadura: null, espada: null, anel: null, colar: null };  
    game.player.moedas = 100;
    game.player.rodadas = 0;
    game.player.classe = "Bixa";
    game.player.classeLiberada = false;
    game.player.magiasAdquiridas = [];
    game.player.magiasEquipadas = [];
    game.player.currentArea = "E";  
    
    game.player.currentDanoFisico = BASE_DANO_FISICO;
    game.player.currentReducaoDano = BASE_RESISTENCIA;
    game.player.currentChanceFuga = 0;
    game.player.currentChanceEsquiva = 0;
    game.player.currentDanoMagico = BASE_DANO_MAGICO;

    // Reset dungeon state
    game.dungeon.active = false;
    game.dungeon.isBossRoomConfirmation = false;
    game.batalha.isBossBattle = false;


    atualizarAtributosDerivados();
    atualizarRank();
    atualizarStatusAtributos();
    atualizarMercadorVisibilidade();
    mostrarMensagem(
      `Você acorda na <span class="font-bold text-indigo-400">Área ${game.player.currentArea}</span> do mundo de Aethel. A névoa envolve tudo e o silêncio é perturbador. Você não lembra como chegou aqui, mas sabe que precisa sobreviver.<br/><br/>O que deseja fazer?`
    );
    limparEscolhas();
    adicionarEscolha("Explorar a área", explorarArea);
    adicionarEscolha("Entrar na Masmorra (Rank E)", () => entrarMasmorra("E")); 
    adicionarEscolha("Ver atributos", abrirAtributos);
    adicionarEscolha("Abrir habilidades", abrirSkills);
    adicionarEscolha("Abrir inventário", abrirInventario);
    // MODIFICATION: Changed level requirement for "Mudar de Área"
    if (game.player.nivel >= 10) {
        adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
    }
  }

  function atualizarMercadorVisibilidade() {
    const mercadorBtn = document.getElementById("btn-mercador");
    if (game.player.nivel > 0 && game.player.nivel % 5 === 0) {
      mercadorBtn.classList.remove("hidden");
    } else {
      mercadorBtn.classList.add("hidden");
    }
  }

  function explorarArea() {
    game.player.rodadas++;

    const evento = Math.random();
    if (evento < 0.7) { // Encounter monster
        const currentAreaRankIndex = rankToIndex(game.player.currentArea);
        const rankForMonsters = [];
        rankForMonsters.push(RANKS[currentAreaRankIndex]); // Monsters of the area's rank

        // Chance for a slightly stronger monster (one rank above area, if not S)
        if (currentAreaRankIndex + 1 < RANKS.length && Math.random() < 0.3) { 
            rankForMonsters.push(RANKS[currentAreaRankIndex + 1]);
        }
        
        const chosenRankForMonster = randomChoice(rankForMonsters);
        const monstro = gerarMonstro(chosenRankForMonster); // Monsters are stronger in higher rank areas and give more XP
        game.monstroAtual = monstro;
        iniciarBatalha(monstro);
    } else { // No monster
      mostrarMensagem(
        `Você explora a <span class="font-bold text-indigo-400">Área ${game.player.currentArea}</span> e encontra um lugar tranquilo. O vento sopra suavemente e você aproveita para recuperar suas forças.<br/><br/>O que deseja fazer?`
      );
      limparEscolhas();
      adicionarEscolha("Continuar explorando", explorarArea);
      adicionarEscolha("Entrar na Masmorra (Rank E)", () => entrarMasmorra("E"));
      adicionarEscolha("Ver atributos", abrirAtributos);
      adicionarEscolha("Abrir habilidades", abrirSkills);
      adicionarEscolha("Abrir inventário", abrirInventario);
      // MODIFICATION: Changed level requirement for "Mudar de Área"
      if (game.player.nivel >= 10) {
          adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
      }
    }
    atualizarStatusAtributos(); 
  }

  function abrirTelaMudarArea() {
    game.estado = "mudarAreaScreen";  
    
    const playerRankIndex = rankToIndex(game.player.rank);
    let areaChoicesHtml = `Você está atualmente na <span class="font-bold text-indigo-400">Área ${game.player.currentArea}</span>.<br/><br/>Escolha uma nova área para viajar (Requer Nível 10+ e Rank apropriado):<br/>`; // Updated text slightly
    
    mostrarMensagem(areaChoicesHtml);
    limparEscolhas();

    RANKS.forEach(areaRank => {
        const targetAreaRankIndex = rankToIndex(areaRank);
        // Player can travel to areas up to their own rank.
        // The level 10 check is for accessing this screen, rank check is for accessing specific area.
        if (targetAreaRankIndex <= playerRankIndex) { 
            if (areaRank === game.player.currentArea) {
                 adicionarEscolha(`Área ${areaRank} (Atual)`, null, true);
            } else {
                 adicionarEscolha(`Viajar para Área ${areaRank}`, () => mudarDeArea(areaRank));
            }
        } else {
            const btn = document.createElement("button");
            btn.className = "bg-gray-700 rounded px-4 py-2 font-semibold text-gray-500 cursor-not-allowed";
            btn.innerHTML = `Área ${areaRank} (Requer Rank ${areaRank})`;
            btn.disabled = true;
            document.getElementById("choices").appendChild(btn);
        }
    });

    adicionarEscolha("Voltar", abrirInicio);
}

function mudarDeArea(novaAreaRank) {
    game.player.currentArea = novaAreaRank;
    mostrarMensagem(`Você viajou para a <span class="font-bold text-indigo-400">Área ${novaAreaRank}</span>.<br/><br/>O que deseja fazer?`);
    limparEscolhas();
    adicionarEscolha("Explorar a área", explorarArea);
    adicionarEscolha(`Entrar na Masmorra (Rank ${novaAreaRank})`, () => entrarMasmorra(novaAreaRank)); 
    adicionarEscolha("Ver atributos", abrirAtributos);
    adicionarEscolha("Abrir habilidades", abrirSkills);
    adicionarEscolha("Abrir inventário", abrirInventario);
    // MODIFICATION: Changed level requirement for "Mudar de Área"
    if (game.player.nivel >= 10) {
        adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
    }
}


  function iniciarBatalha(monstro) {
    toggleHeaderNavButtons(true); // Disable header buttons
    game.estado = "batalha";
    game.batalha.emBatalha = true;
    game.batalha.monstro = monstro;
    game.batalha.turnoJogador = true;
    game.batalha.isBossBattle = monstro.isBoss; // Set boss battle flag

    let msg = `Você encontrou um monstro: <span class="font-bold text-red-400">${monstro.nome}</span> (Rank ${monstro.rank})<br/>Vida: ${monstro.vidaAtual} / ${monstro.vidaMax}`;
    if (game.dungeon.active && !monstro.isBoss) {
        msg = `Sala ${game.dungeon.currentRoom + 1} de ${game.dungeon.totalRooms} da <span class="font-bold text-purple-400">${game.dungeon.name}</span>.<br/>` + msg;
    } else if (monstro.isBoss) {
        msg = `<span class="text-red-500 font-bold">BATALHA DE CHEFE!</span><br/>` + msg;
    }
    msg += `<br/><br/>O que deseja fazer?`;

    mostrarMensagem(msg);
    limparEscolhas();
    adicionarEscolha("Atacar fisicamente", () => atacarMonstro("fisico"));
    if (game.player.magiasEquipadas.length > 0) {
      adicionarEscolha("Usar magia", usarMagiaMenu);
    }
    adicionarEscolha("Usar poção", usarPocaoMenu, monstro.isBoss); 
    adicionarEscolha("Tentar fugir", tentarFugir, monstro.isBoss);   
    
    atualizarStatusAtributos();
  }

  function tentarFugir() {
    if (game.batalha.monstro && game.batalha.monstro.isBoss) { 
        mostrarMensagem("Não é possível fugir de uma batalha de chefe!");
        setTimeout(() => {
            iniciarBatalha(game.batalha.monstro);
        }, 1000);
        return;
    }

    const chanceFuga = calcularChanceFuga(game.batalha.monstro);
    const sucesso = Math.random() < chanceFuga;
    if (sucesso) {
      toggleHeaderNavButtons(false); // Enable header buttons
      mostrarMensagem(
        `Você tentou fugir e conseguiu escapar do <span class="font-bold text-red-400">${game.batalha.monstro.nome}</span>!<br/><br/>O que deseja fazer agora?`
      );
      limparEscolhas();
      game.batalha.emBatalha = false;
      game.monstroAtual = null;
      if (game.dungeon.active) {
        fugirDaMasmorra(false); 
      } else {
        adicionarEscolha("Continuar explorando", explorarArea);
        adicionarEscolha("Entrar na Masmorra (Rank E)", () => entrarMasmorra("E"));
        adicionarEscolha("Ver atributos", abrirAtributos);
        adicionarEscolha("Abrir habilidades", abrirSkills);
        adicionarEscolha("Abrir inventário", abrirInventario);
        // MODIFICATION: Changed level requirement for "Mudar de Área"
         if (game.player.nivel >= 10) {
           adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
         }
      }
    } else {
      mostrarMensagem(
        `Você tentou fugir, mas falhou! O <span class="font-bold text-red-400">${game.batalha.monstro.nome}</span> aproveita para atacar você!`
      );
      limparEscolhas();
      setTimeout(() => {
        monstroAtaca();
      }, 1000);
    }
    atualizarStatusAtributos();
  }

  function atacarMonstro(tipo, magia = null) {
    if (!game.batalha.emBatalha) return;
    const monstro = game.batalha.monstro;
    let dano = 0;
    if (tipo === "fisico") {
      dano = calcularDanoFisico();
    } else if (tipo === "magico" && magia) {
      const gastoMana = calcularGastoMana(magia);
      if (game.player.manaAtual < gastoMana) {
        mostrarMensagem(
          `Você não tem mana suficiente para usar a magia <span class="font-bold text-indigo-400">${magia.nome}</span>. Mana necessária: ${gastoMana}`
        );
         adicionarEscolha("Voltar à Batalha", () => iniciarBatalha(game.batalha.monstro));
        return; 
      }
      game.player.manaAtual -= gastoMana;
      dano = calcularDanoMagico(magia);
    }
    monstro.vidaAtual -= dano;
    if (monstro.vidaAtual < 0) monstro.vidaAtual = 0;

    let msg = `Você atacou o <span class="font-bold text-red-400">${monstro.nome}</span> com ${tipo === "fisico" ? "um ataque físico" : `a magia <span class="font-bold text-indigo-400">${magia.nome}</span>`} e causou <span class="font-bold text-yellow-400">${dano}</span> de dano.<br/>Vida do monstro: ${monstro.vidaAtual} / ${monstro.vidaMax}`;
    if (tipo === "magico") {
      msg += `<br/>Mana restante: ${game.player.manaAtual} / ${game.player.manaMax}`;
    }
    mostrarMensagem(msg);
    limparEscolhas(); 

    if (monstro.vidaAtual <= 0) {
      setTimeout(() => {
        derrotarMonstro(monstro);
      }, 1200);
    } else {
      setTimeout(() => {
        monstroAtaca();
      }, 1200);
    }
    atualizarStatusAtributos();
  }

  function usarMagiaMenu() {
    const magias = game.player.magiasEquipadas.map(id => MAGIAS_POSSIVEIS.find(m => m.id === id)).filter(Boolean);
    if (magias.length === 0) {
      mostrarMensagem("Você não tem magias equipadas.");
      adicionarEscolha("Voltar à Batalha", () => iniciarBatalha(game.batalha.monstro)); 
      return;
    }
    mostrarMensagem("Escolha a magia para usar:");
    limparEscolhas();
    magias.forEach(magia => {
      adicionarEscolha(
        `${magia.nome} (Rank ${magia.rank}) - Dano: ${magia.danoBase}, Mana: ${calcularGastoMana(magia)}`,
        () => atacarMonstro("magico", magia)
      );
    });
    adicionarEscolha("Voltar", () => iniciarBatalha(game.batalha.monstro));
  }

  function usarPocaoMenu() {
    if (game.batalha.isBossBattle) { 
        mostrarMensagem("Não é possível usar poções durante uma batalha de chefe!");
        adicionarEscolha("Voltar à Batalha", () => iniciarBatalha(game.batalha.monstro));
        return;
    }

    const pocaoItens = game.player.inventario.filter(i => i.isPotion && i.quantity > 0);
    if (pocaoItens.length === 0) {
      mostrarMensagem("Você não tem poções no inventário.");
      adicionarEscolha("Voltar à Batalha", () => iniciarBatalha(game.batalha.monstro));
      return;
    }
    mostrarMensagem("Escolha a poção para usar:");
    limparEscolhas();
    pocaoItens.forEach(pocaoStack => { 
      adicionarEscolha(
        `${pocaoStack.nome} - ${pocaoStack.descricao} (x${pocaoStack.quantity})`,
        () => usarPocao(pocaoStack) 
      );
    });
    adicionarEscolha("Voltar", () => iniciarBatalha(game.batalha.monstro));
  }

  function usarPocao(pocaoStack) { 
    if (game.batalha.isBossBattle) { 
        alert("Não é possível usar poções em batalhas de chefe.");
        iniciarBatalha(game.batalha.monstro);
        return;
    }
    if (!pocaoStack || pocaoStack.quantity <= 0) {
      alert("Poção não encontrada ou esgotada."); 
      iniciarBatalha(game.batalha.monstro); 
      return;
    }
    const curaVida = Math.floor(game.player.vidaMax * pocaoStack.curaVidaPct);
    const curaMana = Math.floor(game.player.manaMax * pocaoStack.curaManaPct);
    game.player.vidaAtual = Math.min(game.player.vidaAtual + curaVida, game.player.vidaMax);
    game.player.manaAtual = Math.min(game.player.manaAtual + curaMana, game.player.manaMax);
    
    pocaoStack.quantity--; 
    if (pocaoStack.quantity <= 0) { 
        game.player.inventario = game.player.inventario.filter(i => i !== pocaoStack);
    }

    mostrarMensagem(
      `Você usou <span class="font-bold text-indigo-400">${pocaoStack.nome}</span> e recuperou ${curaVida} de vida e ${curaMana} de mana.<br/><br/>O que deseja fazer?`
    );
    limparEscolhas();
    adicionarEscolha("Atacar fisicamente", () => atacarMonstro("fisico"));
    if (game.player.magiasEquipadas.length > 0) adicionarEscolha("Usar magia", usarMagiaMenu);
    adicionarEscolha("Usar poção", usarPocaoMenu); 
    adicionarEscolha("Tentar fugir", tentarFugir);
    
    atualizarStatusAtributos();
  }

  function monstroAtaca() {
    if (!game.batalha.emBatalha || !game.batalha.monstro) return; 
    const monstro = game.batalha.monstro;
    const ataqueMagico = !monstro.isBoss && monstro.danoMagico > 0 && Math.random() < 0.4; // Regular monsters, 40% chance of magic if they have it
    let dano = ataqueMagico ? monstro.danoMagico : monstro.danoFisico;
    
    if (monstro.isBoss) { 
        // Boss might have a different attack pattern. Let's make them use their stronger stat more often, or a mix.
        // For example, always physical + a chance of adding their magical damage, or choose one.
        // Current boss generation gives them both physical and magical.
        if (monstro.danoFisico > monstro.danoMagico) {
            dano = monstro.danoFisico + (Math.random() < 0.3 ? randomInt(0, Math.floor(monstro.danoMagico * 0.5)) : 0) ; // Primarily physical, small chance of some magic bonus
        } else {
            dano = monstro.danoMagico + (Math.random() < 0.3 ? randomInt(0, Math.floor(monstro.danoFisico * 0.5)) : 0); // Primarily magical
        }
        dano = Math.max(dano, monstro.danoFisico, monstro.danoMagico > 0 ? monstro.danoMagico : 0); // Ensure it's at least their base
    }


    dano = calcularDanoRecebido(dano);
    game.player.vidaAtual -= dano;
    if (game.player.vidaAtual < 0) game.player.vidaAtual = 0;
    
    let msg = `O <span class="font-bold text-red-400">${monstro.nome}</span> atacou você com ${
        monstro.isBoss ? "um golpe devastador" : (ataqueMagico ? "magia" : "um ataque físico")
      } e causou <span class="font-bold text-red-500">${dano}</span> de dano.<br/>Sua vida: ${game.player.vidaAtual} / ${game.player.vidaMax}`;

    if (game.player.vidaAtual <= 0) {
      msg += "<br/><br/>Você foi derrotado!";
      mostrarMensagem(msg);
      limparEscolhas();
      setTimeout(() => {
        gameOver();
      }, 1500);
    } else {
      let battleContext = "";
      if (game.dungeon.active && !monstro.isBoss) {
          battleContext = `Sala ${game.dungeon.currentRoom + 1} de ${game.dungeon.totalRooms}.<br/>`;
      } else if (monstro.isBoss) {
          battleContext = `<span class="text-red-500 font-bold">BATALHA DE CHEFE!</span><br/>`;
      }
      msg = battleContext + msg; // Prepend context
      msg += `<br/><br/>Você está enfrentando o <span class="font-bold text-red-400">${monstro.nome}</span> (Rank ${monstro.rank})<br/>Vida do monstro: ${monstro.vidaAtual} / ${monstro.vidaMax}<br/><br/>O que deseja fazer?`;
      mostrarMensagem(msg);
      limparEscolhas();
      adicionarEscolha("Atacar fisicamente", () => atacarMonstro("fisico"));
      if (game.player.magiasEquipadas.length > 0) {
        adicionarEscolha("Usar magia", usarMagiaMenu);
      }
      adicionarEscolha("Usar poção", usarPocaoMenu, monstro.isBoss); 
      adicionarEscolha("Tentar fugir", tentarFugir, monstro.isBoss); 
    }
    atualizarStatusAtributos();
  }

  function derrotarMonstro(monstro) {
    game.batalha.emBatalha = false;
    // game.batalha.isBossBattle = false; // Reset specifically when battle ends
    // game.monstroAtual = null; // This will be handled by dungeon logic or regular exploration flow

    let xpGanhoBase = monstro.xpGanho;
    let xpFinal = Math.floor(xpGanhoBase * (1 + game.player.xpBonus)); 
    
    game.player.xp += xpFinal;
    const moedasGanhas = randomInt(5, 20) * (rankToIndex(monstro.rank) + 1) * (monstro.isBoss ? 5 : 1); 
    game.player.moedas += moedasGanhas;

    for (const attr in game.player.atributos) {
      game.player.atributos[attr] = +(game.player.atributos[attr] + 0.1).toFixed(1);
    }
    
    game.player.vidaAtual = Math.min(game.player.vidaAtual + Math.floor(game.player.vidaMax * 0.3), game.player.vidaMax);
    game.player.manaAtual = Math.min(game.player.manaAtual + Math.floor(game.player.manaMax * 0.3), game.player.manaMax);

    const dropChance = monstro.isBoss ? 1.0 : 0.7; 
    let itemDrop = null;
    if (Math.random() < dropChance) {
      const rankIndexMonstro = rankToIndex(monstro.rank);
      // MODIFICATION: Enhanced item drop logic for more varied/better loot
      let itemRankForDropIndex = rankIndexMonstro; // Default to monster's rank
      if (!monstro.isBoss) {
          const roll = Math.random();
          if (roll < 0.15) { // 15% chance for one rank higher (e.g., C monster drops B)
              itemRankForDropIndex = Math.min(RANKS.length - 1, rankIndexMonstro + 1);
          } else if (roll < 0.70) { // 55% chance for same rank (0.70 - 0.15 = 0.55)
              itemRankForDropIndex = rankIndexMonstro;
          } else { // 30% chance for one rank lower
              itemRankForDropIndex = Math.max(0, rankIndexMonstro - 1);
          }
      } // Bosses still drop items of their own rank (itemRankForDropIndex remains rankIndexMonstro).
      
      const rankItem = indexToRank(itemRankForDropIndex); // This ensures "item rank acima do C seja dropavel" from appropriate monsters
      itemDrop = gerarItem(rankItem); // Higher rank monsters (from tougher areas) will naturally use higher rankItem here
      addItemToInventory(itemDrop); 
    }

    let leveledUp = false;
    let novaMagiaAdquirida = null;
    let levelUpMessages = [];

    while (game.player.xp >= game.player.xpProximoNivel) {
      leveledUp = true;
      game.player.xp -= game.player.xpProximoNivel;
      game.player.nivel++;
      game.player.pontosDistribuir += 5;
      for (const attr in game.player.atributos) {
        game.player.atributos[attr] = +(game.player.atributos[attr] + 1).toFixed(1);
      }
      levelUpMessages.push(`Você subiu para o nível <span class="font-bold text-green-400">${game.player.nivel}</span>, ganhou 5 pontos para distribuir e +1 em todos os atributos!`);
      game.player.xpProximoNivel = Math.floor(game.player.xpProximoNivel * 1.25);
      atualizarMercadorVisibilidade();
      atualizarRank();  

      const rankIndexJogador = rankToIndex(game.player.rank);
      const magiasDisponiveis = MAGIAS_POSSIVEIS.filter(m => rankToIndex(m.rank) <= rankIndexJogador && !game.player.magiasAdquiridas.includes(m.id));
      if (magiasDisponiveis.length > 0) {
        novaMagiaAdquirida = randomChoice(magiasDisponiveis);
        game.player.magiasAdquiridas.push(novaMagiaAdquirida.id);
        if (game.player.magiasEquipadas.length < 4) {
          game.player.magiasEquipadas.push(novaMagiaAdquirida.id);
          levelUpMessages.push(`Nova magia: <span class="font-bold text-indigo-400">${novaMagiaAdquirida.nome}</span> (Rank ${novaMagiaAdquirida.rank}) foi adquirida e equipada.`);
        } else {
          levelUpMessages.push(`Nova magia: <span class="font-bold text-indigo-400">${novaMagiaAdquirida.nome}</span> (Rank ${novaMagiaAdquirida.rank}) foi adquirida. Equipe-a na tela de Habilidades.`);
        }
        novaMagiaAdquirida = null; 
      }
    }
    
    atualizarAtributosDerivados();  

    let msg = `Você derrotou o <span class="font-bold text-red-400">${monstro.nome}</span>!<br/>Ganhou <span class="font-bold text-yellow-400">${xpFinal}</span> XP e <span class="font-bold text-yellow-300">${moedasGanhas}</span> moedas.`;
    if (itemDrop) {
      msg += `<br/>O monstro deixou cair: <span class="font-bold text-indigo-400">${itemDrop.nome}</span> (Rank ${itemDrop.rank})`;
    }
    if (levelUpMessages.length > 0) {
        msg += "<br/><br/>" + levelUpMessages.join("<br/>");
    }
    
    if (game.dungeon.active) { // If in a dungeon
        if (monstro.isBoss) {
            game.batalha.isBossBattle = false; // Explicitly reset boss battle flag after boss is defeated
            completarMasmorra(msg); 
            return;
        } else { // Monster in dungeon room, not boss
            msg += `<br/><br/>Você avança para a próxima sala da masmorra...`;
            mostrarMensagem(msg);
            atualizarStatusAtributos();
            // Buttons remain disabled, avancarSalaMasmorra will handle states
            setTimeout(() => {
                game.dungeon.currentRoom++; 
                avancarSalaMasmorra();
            }, 2000); 
            return;
        }
    }
    
    // If NOT in dungeon (or if the above dungeon logic didn't return)
    toggleHeaderNavButtons(false); // Enable buttons as battle is over and not in dungeon flow
    game.batalha.isBossBattle = false; // Reset if not in dungeon or non-boss defeated in dungeon

    // Standard post-battle if not in dungeon
    if (leveledUp) {
        msg += `<br/><br/>Você tem ${game.player.pontosDistribuir} pontos de atributo para distribuir.`;
        mostrarMensagem(msg);
        atualizarStatusAtributos();
        atualizarSkillsTela();  
        limparEscolhas();
        adicionarEscolha("Distribuir Atributos", abrirAtributos);
        adicionarEscolha("Continuar explorando", explorarArea);
        adicionarEscolha("Entrar na Masmorra (Rank E)", () => entrarMasmorra("E"));
        // MODIFICATION: Changed level requirement for "Mudar de Área"
        if (game.player.nivel >= 10) {
            adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
        }
        return;
    }

    // If no level up and not in dungeon
    msg += `<br/><br/>O que deseja fazer?`;
    mostrarMensagem(msg);
    limparEscolhas();
    adicionarEscolha("Continuar explorando", explorarArea);
    adicionarEscolha("Entrar na Masmorra (Rank E)", () => entrarMasmorra("E"));
    adicionarEscolha("Ver atributos", abrirAtributos);
    adicionarEscolha("Abrir habilidades", abrirSkills);
    adicionarEscolha("Abrir inventário", abrirInventario);
    // MODIFICATION: Changed level requirement for "Mudar de Área"
    if (game.player.nivel >= 10) {
        adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
    }
    atualizarStatusAtributos();
  }

  function gameOver() {
    toggleHeaderNavButtons(true); // MODIFIED: Disable header buttons on game over
    game.estado = "gameover";
    if (game.dungeon.active) { 
        game.dungeon.active = false; 
        game.batalha.isBossBattle = false; // Ensure boss flag is off
    }
    mostrarMensagem(
      `<span class="text-red-600 font-extrabold text-3xl">Você morreu!</span><br/>O mundo de <span class="font-bold text-indigo-400">Aethel</span> não foi gentil desta vez.<br/><br/>Deseja recomeçar?`
    );
    limparEscolhas();
    adicionarEscolha("Recomeçar", iniciarJogo);
  }

  function abrirAtributos() {
    game.estado = "atributos";
    atualizarRank();
    atualizarAtributosDerivados();  
    atualizarStatusAtributos();
    document.getElementById("game-screen").classList.add("hidden");
    document.getElementById("atributos-screen").classList.remove("hidden");
    document.getElementById("inventario-screen").classList.add("hidden");
    document.getElementById("mercador-screen").classList.add("hidden");
    document.getElementById("skills-screen").classList.add("hidden");
    atualizarTelaAtributos();  
  }

  function atualizarTelaAtributos() {
    const a = game.player.atributos;
    document.getElementById("forca-val").textContent = a.forca.toFixed(1);
    document.getElementById("agilidade-val").textContent = a.agilidade.toFixed(1);
    document.getElementById("inteligencia-val").textContent = a.inteligencia.toFixed(1);
    document.getElementById("resistencia-val").textContent = a.resistencia.toFixed(1);
    document.getElementById("vitalidade-val").textContent = a.vitalidade.toFixed(1);
    document.getElementById("percepcao-val").textContent = a.percepcao.toFixed(1);
    document.getElementById("pontos-disponiveis").textContent = game.player.pontosDistribuir;
    atualizarStatusAtributos(); 
  }

  function manipularBotaoAtributo(e) {
    if (!e.target.closest(".btn-attr")) return;
    const btn = e.target.closest(".btn-attr");
    const attr = btn.dataset.attr;
    const action = btn.dataset.action;
    if (!attr || !action) return;
    const valAtual = game.player.atributos[attr];
    if (action === "inc") {
      if (game.player.pontosDistribuir > 0) {
        game.player.atributos[attr] = +(valAtual + 1).toFixed(1);
        game.player.pontosDistribuir--;
      }
    } else if (action === "dec") {
        // Allow decrease only if attribute value is greater than its BASE_STATS equivalent (0)
        // AND it won't make the attribute negative (which +(valAtual - 1) could if valAtual is small like 0.1)
        // A more complex system would track "spent points" vs "base points from level ups"
        // For now, this allows reclaiming points as long as the stat itself > 0 and some points were spent to make it > base
        if (valAtual > BASE_STATS[attr] && valAtual -1 >= BASE_STATS[attr]) { 
            game.player.atributos[attr] = +(valAtual - 1).toFixed(1);
            game.player.pontosDistribuir++;
        } else if (valAtual > 0 && valAtual - 1 < BASE_STATS[attr] && game.player.atributos[attr] !== BASE_STATS[attr]) {
          // Special case: if decrementing would go below base_stat but current is not base_stat
          // (e.g. current is 0.5, base is 0, you want to reclaim the 0.5 to get back to 0)
          // This is tricky with the 0.1 increments from monster defeats.
          // Simpler: only allow decrement if current val is at least 1 above base.
          // Let's stick to: if (valAtual > BASE_STATS[attr] && (valAtual - 1) >= BASE_STATS[attr])
          // This prevents going below the "natural" base from direct level ups + monster defeat small gains.
          // The current logic `if (valAtual > 0)` is simpler but might allow reclaiming "permanent" small gains.
          // For now, the existing `if (valAtual > 0)` and `game.player.atributos[attr] = +(valAtual - 1).toFixed(1);`
          // will work, players can reduce to 0 if they wish.
          // Let's stick to the original logic for decreasing as it's simpler:
           if (valAtual > 0) { // Simplified: can always decrease if > 0
              game.player.atributos[attr] = +(Math.max(0, valAtual - 1)).toFixed(1); // Ensure not negative
              game.player.pontosDistribuir++;
           }
        }
    }
    atualizarAtributosDerivados();  
    atualizarTelaAtributos();  
  }

  function salvarAtributos() {
    atualizarRank();
    atualizarAtributosDerivados();  
    atualizarStatusAtributos();
    abrirInicio();
  }

  function abrirInicio() {
    toggleHeaderNavButtons(false); // Enable header buttons
    game.estado = "inicio";
    // Crucial: Reset dungeon and boss flags when returning to main menu
    game.dungeon.active = false; 
    game.dungeon.isBossRoomConfirmation = false;
    game.batalha.isBossBattle = false;


    document.getElementById("game-screen").classList.remove("hidden");
    document.getElementById("atributos-screen").classList.add("hidden");
    document.getElementById("inventario-screen").classList.add("hidden");
    document.getElementById("mercador-screen").classList.add("hidden");
    document.getElementById("skills-screen").classList.add("hidden");
    mostrarMensagem(
      `Você está na <span class="font-bold text-indigo-400">Área ${game.player.currentArea}</span> do mundo de Aethel.<br/><br/>O que deseja fazer?`
    );
    limparEscolhas();
    adicionarEscolha("Explorar a área", explorarArea);
    adicionarEscolha(`Entrar na Masmorra (Rank ${game.player.currentArea})`, () => entrarMasmorra(game.player.currentArea)); // Dynamic dungeon based on area
    adicionarEscolha("Ver atributos", abrirAtributos);
    adicionarEscolha("Abrir habilidades", abrirSkills);
    adicionarEscolha("Abrir inventário", abrirInventario);
    // MODIFICATION: Changed level requirement for "Mudar de Área"
    if (game.player.nivel >= 10) {
        adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
    }
  }

  function abrirInventario() {
    game.estado = "inventario";
    document.getElementById("game-screen").classList.add("hidden");
    document.getElementById("atributos-screen").classList.add("hidden");
    document.getElementById("inventario-screen").classList.remove("hidden");
    document.getElementById("mercador-screen").classList.add("hidden");
    document.getElementById("skills-screen").classList.add("hidden");
    atualizarInventarioTela();
  }

  function atualizarInventarioTela() {
    const lista = document.getElementById("lista-itens");
    lista.innerHTML = "";
    if (game.player.inventario.length === 0) {
      const li = document.createElement("li");
      li.className = "text-gray-400 italic";
      li.textContent = "Inventário vazio.";
      lista.appendChild(li);
    } else {
        game.player.inventario.forEach((item) => { 
            const li = document.createElement("li");
            li.className = "bg-gray-700 rounded p-2 flex flex-col sm:flex-row sm:justify-between sm:items-center";
            
            const nomeSpan = document.createElement("span");
            nomeSpan.className = "font-semibold text-indigo-300";
            let displayName = `${item.nome} (Rank ${item.rank})`;
            if (item.quantity > 1) {
                displayName += ` (x${item.quantity})`;
            }
            nomeSpan.textContent = displayName;

            const efeitosSpan = document.createElement("span");
            efeitosSpan.className = "text-xs text-gray-300 mt-1 sm:mt-0 sm:ml-4";
            if(item.isPotion){
                efeitosSpan.textContent = item.descricao;
            } else {
                efeitosSpan.innerHTML = Object.entries(item.efeitos || {})
                .map(([chave, val]) => {
                    let desc = "";
                    switch (chave) {
                    case "forca": desc = `+${val} Força`; break;
                    case "agilidade": desc = `+${val} Agilidade`; break;
                    case "inteligencia": desc = `+${val} Inteligência`; break;
                    case "resistencia": desc = `+${val} Resistência`; break;
                    case "vitalidade": desc = `+${val} Vitalidade`; break;
                    case "percepcao": desc = `+${val} Percepção`; break;
                    case "refinoMagico": desc = `+${val}% Refino Mágico`; break;
                    default: desc = `${chave}: +${val}`;
                    }
                    return desc;
                })
                .join(", ");
            }
            const botoesDiv = document.createElement("div");
            botoesDiv.className = "mt-2 sm:mt-0 sm:ml-4 flex space-x-2";

            if(!item.isPotion){ 
                const btnEquipar = document.createElement("button");
                btnEquipar.className = "bg-green-600 hover:bg-green-700 rounded px-3 py-1 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-green-400";
                btnEquipar.textContent = "Equipar";
                btnEquipar.addEventListener("click", () => equiparItem(item)); 
                botoesDiv.appendChild(btnEquipar);
            }

            const btnDescartar = document.createElement("button");
            btnDescartar.className = "bg-red-600 hover:bg-red-700 rounded px-3 py-1 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-red-400";
            btnDescartar.textContent = "Descartar";
            btnDescartar.addEventListener("click", () => descartarItem(item)); 
            botoesDiv.appendChild(btnDescartar);

            li.appendChild(nomeSpan);
            li.appendChild(efeitosSpan);
            li.appendChild(botoesDiv);
            lista.appendChild(li);
        });
    }
    atualizarEquipamentosTela();
  }


  function atualizarEquipamentosTela() {
    document.getElementById("equip-armadura").textContent = game.player.equipamento.armadura ?  
      `${game.player.equipamento.armadura.nome} (Rank ${game.player.equipamento.armadura.rank})` : "Nenhuma equipada";
    document.getElementById("equip-espada").textContent = game.player.equipamento.espada ?  
      `${game.player.equipamento.espada.nome} (Rank ${game.player.equipamento.espada.rank})` : "Nenhuma equipada";
    document.getElementById("equip-anel").textContent = game.player.equipamento.anel ?  
      `${game.player.equipamento.anel.nome} (Rank ${game.player.equipamento.anel.rank})` : "Nenhum equipado";
    document.getElementById("equip-colar").textContent = game.player.equipamento.colar ?  
      `${game.player.equipamento.colar.nome} (Rank ${game.player.equipamento.colar.rank})` : "Nenhum equipado";
  }

  function equiparItem(itemFromInventoryStack) { 
    if (itemFromInventoryStack.isPotion || itemFromInventoryStack.quantity <=0) {
        alert("Este item não pode ser equipado ou não há mais unidades.");
        return;
    }

    let slotParaEquipar = null;
    switch (itemFromInventoryStack.tipo) {
      case "Armadura": slotParaEquipar = "armadura"; break;
      case "Espada":   slotParaEquipar = "espada";   break;
      case "Anel":     slotParaEquipar = "anel";     break;
      case "Colar":    slotParaEquipar = "colar";    break;
      default:  
        alert("Tipo de item desconhecido para equipamento.");
        return;
    }

    if (slotParaEquipar) {
      if (game.player.equipamento[slotParaEquipar]) {
        addItemToInventory(game.player.equipamento[slotParaEquipar]);
      }
      
      const itemToEquip = { ...itemFromInventoryStack };
      delete itemToEquip.quantity; 

      game.player.equipamento[slotParaEquipar] = itemToEquip;
      
      itemFromInventoryStack.quantity--;
      if (itemFromInventoryStack.quantity <= 0) {
        game.player.inventario = game.player.inventario.filter(i => i !== itemFromInventoryStack);
      }
      
      atualizarAtributosDerivados();  
      atualizarInventarioTela();  
      atualizarStatusAtributos();  
      alert(`Você equipou: ${itemToEquip.nome}`);
    }
  }

  function descartarItem(itemInInventory) { 
    if (!itemInInventory || itemInInventory.quantity <=0) return;

    if (confirm(`Deseja realmente descartar UMA unidade de ${itemInInventory.nome}?`)) {
      itemInInventory.quantity--;
      if (itemInInventory.quantity <= 0) {
        game.player.inventario = game.player.inventario.filter(i => i !== itemInInventory);
      }
      atualizarInventarioTela();
    }
  }

  function aplicarEfeitosEquipamento() {
    let totalRefinoMagicoBonus = 0;
    for (const slot in game.player.equipamento) {
        const equip = game.player.equipamento[slot];
        if (equip && equip.efeitos && typeof equip.efeitos.refinoMagico === 'number') {
            totalRefinoMagicoBonus += equip.efeitos.refinoMagico;
        }
    }
    game.player.refinoMagicoPct = totalRefinoMagicoBonus / 100; 
  }


  function abrirMercador() { 
    toggleHeaderNavButtons(true); // MODIFIED: Disable navigation buttons when merchant is open
    game.estado = "mercador";
    document.getElementById("game-screen").classList.add("hidden");
    document.getElementById("atributos-screen").classList.add("hidden");
    document.getElementById("inventario-screen").classList.add("hidden");
    document.getElementById("mercador-screen").classList.remove("hidden");
    document.getElementById("skills-screen").classList.add("hidden");
    gerarItensMercador(); 
    atualizarTelaMercador();
    mostrarMensagem(  
        `O mercador cumprimenta você. Você tem <span class="font-bold text-yellow-300">${game.player.moedas}</span> moedas.<br/><br/>Selecione os itens que deseja comprar.`
    );
  }

  function gerarItensMercador() {
    game.mercador.itens = []; 
    const qtd = randomInt(5, 8);
    const playerRankIdx = rankToIndex(game.player.rank);

    for (let i = 0; i < qtd; i++) {
      const rankOffset = randomInt(-1, 1); 
      const itemRankIdx = clamp(playerRankIdx + rankOffset, 0, RANKS.length - 1);
      const rank = indexToRank(itemRankIdx);
      
      let item = gerarItem(rank); 
      if (item.isPotion) {
        const pocaoBaseCompra = POTIONS.compra;
        item.id = pocaoBaseCompra.id; 
        item.nome = pocaoBaseCompra.nome;
        item.curaVidaPct = pocaoBaseCompra.curaVidaPct;
        item.curaManaPct = pocaoBaseCompra.curaManaPct;
        item.descricao = pocaoBaseCompra.descricao;
        item.preco = 50; 
      }
      game.mercador.itens.push(item);
    }
    game.mercador.selecionados.clear();
  }

  function atualizarTelaMercador() {
    const lista = document.getElementById("lista-mercador");
    lista.innerHTML = "";
    if (game.mercador.itens.length === 0) {
      const li = document.createElement("li");
      li.className = "text-gray-400 italic";
      li.textContent = "O mercador não tem mais itens para vender no momento.";
      lista.appendChild(li);
      atualizarBotaoComprar();
      return;
    }
    game.mercador.itens.forEach((item, index) => { 
      const li = document.createElement("li");
      li.className = "bg-gray-700 rounded p-3 flex flex-col sm:flex-row sm:justify-between sm:items-center";
      const infoDiv = document.createElement("div");
      infoDiv.className = "flex flex-col";
      const nomeSpan = document.createElement("span");
      nomeSpan.className = "font-semibold text-indigo-300";
      nomeSpan.textContent = `${item.nome} (Rank ${item.rank})`;
      
      const efeitosSpan = document.createElement("span");
      efeitosSpan.className = "text-xs text-gray-300 mt-1";
      if(item.isPotion){
        efeitosSpan.textContent = item.descricao;
      } else {
        efeitosSpan.innerHTML = Object.entries(item.efeitos || {})
          .map(([chave, val]) => {
              let desc = "";
            switch (chave) {
              case "forca": desc = `+${val} Força`; break;
              case "agilidade": desc = `+${val} Agilidade`; break;
              case "inteligencia": desc = `+${val} Inteligência`; break;
              case "resistencia": desc = `+${val} Resistência`; break;
              case "vitalidade": desc = `+${val} Vitalidade`; break;
              case "percepcao": desc = `+${val} Percepção`; break;
              case "refinoMagico": desc = `+${val}% Refino Mágico`; break;
              default: desc = `${chave}: +${val}`;
            }
            return desc;
          })
          .join(", ");
      }
      infoDiv.appendChild(nomeSpan);
      infoDiv.appendChild(efeitosSpan);

      const compraDiv = document.createElement("div");
      compraDiv.className = "flex items-center space-x-3 mt-3 sm:mt-0";

      const precoSpan = document.createElement("span");
      precoSpan.className = "font-semibold text-yellow-300";
      precoSpan.textContent = `${item.preco} moedas`;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = item.id + "_" + index; 
      checkbox.className = "w-5 h-5 cursor-pointer form-checkbox text-indigo-600 bg-gray-800 border-gray-600 focus:ring-indigo-500";
      checkbox.checked = game.mercador.selecionados.has(item); 

      checkbox.addEventListener("change", (e) => {
        if (e.target.checked) {
          game.mercador.selecionados.add(item); 
        } else {
          game.mercador.selecionados.delete(item);
        }
        atualizarBotaoComprar();
      });

      compraDiv.appendChild(precoSpan);
      compraDiv.appendChild(checkbox);

      li.appendChild(infoDiv);
      li.appendChild(compraDiv);
      lista.appendChild(li);
    });
    atualizarBotaoComprar();
  }

  function atualizarBotaoComprar() {
    const btn = document.getElementById("btn-comprar-mercador");
    if (game.mercador.selecionados.size === 0) {
      btn.disabled = true;
      return;
    }
    let totalPreco = 0;
    game.mercador.selecionados.forEach(item => totalPreco += item.preco); 
    btn.disabled = totalPreco > game.player.moedas || totalPreco === 0;
  }

  function comprarItensMercador() {
    if (game.mercador.selecionados.size === 0) return;
    let totalPreco = 0;
    const itensCompradosNomes = []; 

    game.mercador.selecionados.forEach(item => totalPreco += item.preco);

    if (totalPreco > game.player.moedas) {
      alert("Você não tem moedas suficientes para comprar esses itens.");
      return;
    }
    game.player.moedas -= totalPreco;
    
    game.mercador.selecionados.forEach(item => {
        addItemToInventory(item); 
        itensCompradosNomes.push(item.nome);
        game.mercador.itens = game.mercador.itens.filter(merchantItem => merchantItem !== item);
    });
    
    alert(`Você comprou: ${itensCompradosNomes.join(", ")} por ${totalPreco} moedas.`);
    game.mercador.selecionados.clear();
    atualizarTelaMercador(); 
    atualizarStatusAtributos(); 

    // MODIFIED: Open inventory and hide merchant button, re-enable 'inicio'
    document.getElementById("btn-mercador").classList.add("hidden");
    abrirInventario();
    document.getElementById("btn-inicio").disabled = false; // Allow returning to main screen
  }

  function abrirSkills() {
    game.estado = "skills";
    document.getElementById("game-screen").classList.add("hidden");
    document.getElementById("atributos-screen").classList.add("hidden");
    document.getElementById("inventario-screen").classList.add("hidden");
    document.getElementById("mercador-screen").classList.add("hidden");
    document.getElementById("skills-screen").classList.remove("hidden");
    atualizarSkillsTela();
  }

  function atualizarSkillsTela() {
    const lista = document.getElementById("lista-skills");
    lista.innerHTML = "";

    if (game.player.magiasAdquiridas.length === 0) {
      const p = document.createElement("p");
      p.className = "text-gray-400 italic";
      p.textContent = "Você ainda não adquiriu nenhuma magia.";
      lista.appendChild(p);
      return;
    }

    game.player.magiasAdquiridas.forEach(magiaId => {
      const magia = MAGIAS_POSSIVEIS.find(m => m.id === magiaId);
      if (!magia) return;

      const div = document.createElement("div");
      div.className = "bg-gray-700 rounded p-3 flex flex-col sm:flex-row sm:justify-between sm:items-center";

      const infoDiv = document.createElement("div");
      infoDiv.className = "flex flex-col";

      const nomeSpan = document.createElement("span");
      nomeSpan.className = "font-semibold text-indigo-300";
      nomeSpan.textContent = `${magia.nome} (Rank ${magia.rank})`;

      const descSpan = document.createElement("span");
      descSpan.className = "text-xs text-gray-300 mt-1";
      descSpan.textContent = `Dano base: ${magia.danoBase}, Custo de mana: ${calcularGastoMana(magia)}`; 

      infoDiv.appendChild(nomeSpan);
      infoDiv.appendChild(descSpan);

      const btnDiv = document.createElement("div");
      btnDiv.className = "mt-3 sm:mt-0";

      const btnEquipar = document.createElement("button");
      btnEquipar.className = "bg-indigo-600 hover:bg-indigo-700 rounded px-3 py-1 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-400";
      btnEquipar.textContent = game.player.magiasEquipadas.includes(magia.id) ? "Desequipar" : "Equipar";
      btnEquipar.addEventListener("click", () => {
        if (game.player.magiasEquipadas.includes(magia.id)) {
          game.player.magiasEquipadas = game.player.magiasEquipadas.filter(id => id !== magia.id);
        } else {
          if (game.player.magiasEquipadas.length >= 4) {
            alert("Você só pode equipar até 4 magias.");
            return;
          }
          game.player.magiasEquipadas.push(magia.id);
        }
        atualizarSkillsTela(); 
      });

      btnDiv.appendChild(btnEquipar);
      div.appendChild(infoDiv);
      div.appendChild(btnDiv);
      lista.appendChild(div);
    });
  }

  // --- DUNGEON FUNCTIONS ---
  function entrarMasmorra(dungeonTypeRank) {
    const config = DUNGEON_CONFIG[dungeonTypeRank];
    if (!config) {
        mostrarMensagem(`A masmorra de Rank ${dungeonTypeRank} ainda não está acessível ou não existe.`);
        adicionarEscolha("Voltar", abrirInicio);
        return;
    }

    game.estado = "dungeon";
    game.dungeon.active = true;
    game.dungeon.typeRank = dungeonTypeRank; // e.g. "E"
    game.dungeon.name = `${config.name} (Dungeon Rank ${dungeonTypeRank})`;
    game.dungeon.totalRooms = randomInt(config.roomsMin, config.roomsMax);
    game.dungeon.currentRoom = 0; 
    game.dungeon.monsterRankForRooms = config.monsterRank; // e.g. "D" for an "E" dungeon
    game.dungeon.bossRankForDungeon = config.bossRank;       // e.g. "C" for an "E" dungeon
    game.dungeon.bossDefeated = false;
    game.dungeon.isBossRoomConfirmation = false;

    mostrarMensagem(`Você adentrou a <span class="font-bold text-purple-400">${game.dungeon.name}</span>. Ela parece ter ${game.dungeon.totalRooms} salas.<br/>A primeira sala se aproxima...`);
    limparEscolhas();
    adicionarEscolha("Avançar para a primeira sala", avancarSalaMasmorra);
  }

  function avancarSalaMasmorra() {
    limparEscolhas();
    // currentRoom is 0-indexed. totalRooms is the count.
    // If totalRooms is 5, rooms are 0, 1, 2, 3, 4.
    // Boss is in room 4 (game.dungeon.totalRooms - 1).
    if (game.dungeon.currentRoom >= game.dungeon.totalRooms -1 ) { 
        toggleHeaderNavButtons(false); // Enable buttons for boss confirmation choice
        game.dungeon.isBossRoomConfirmation = true;
        mostrarMensagem(`Você chegou à antessala da última câmara da <span class="font-bold text-purple-400">${game.dungeon.name}</span>.<br/>Você sente um calafrio. Uma presença poderosa emana da próxima sala.<br/><br/>Deseja continuar?`);
        adicionarEscolha("Continuar e enfrentar o perigo", confirmarEntradaBoss);
        adicionarEscolha("Recuar da masmorra por agora", () => fugirDaMasmorra(true)); 
    } else {
        // Buttons remain disabled if already in battle sequence, iniciarBatalha will handle re-disabling
        const monstro = gerarMonstroMasmorra(game.dungeon.monsterRankForRooms);
        game.monstroAtual = monstro;
        setTimeout(() => {
            iniciarBatalha(monstro); 
        }, 1000); // Reduced delay for quicker room transitions
    }
  }
  
  function confirmarEntradaBoss() {
    // Buttons will be disabled by iniciarBatalha
    game.dungeon.isBossRoomConfirmation = false; 
    const boss = gerarBossMasmorra(game.dungeon.typeRank, game.dungeon.bossRankForDungeon);
    game.monstroAtual = boss;
    mostrarMensagem(`Você entra na câmara final da <span class="font-bold text-purple-400">${game.dungeon.name}</span>. O ar está pesado. <br/>O chefe da masmorra, <span class="font-bold text-red-500">${boss.nome}</span> (Rank ${boss.rank}), encara você!`);
    setTimeout(() => {
        iniciarBatalha(boss);
    }, 1500);
  }

  function fugirDaMasmorra(playerInitiatedAtBossDoor) {
    toggleHeaderNavButtons(false); // Enable header buttons
    let msg = "";
    if (playerInitiatedAtBossDoor) {
        msg = `Você decidiu recuar da <span class="font-bold text-purple-400">${game.dungeon.name}</span> antes de enfrentar o chefe. A prudência é uma virtude.`;
    } else {
        msg = `Você fugiu da batalha e, consequentemente, da <span class="font-bold text-purple-400">${game.dungeon.name}</span>.`;
    }
    msg += "<br/><br/>Você retorna à entrada da área.";
    
    game.dungeon.active = false;
    game.estado = "inicio"; 
    game.batalha.emBatalha = false; 
    game.batalha.isBossBattle = false;


    mostrarMensagem(msg);
    limparEscolhas(); 
    adicionarEscolha("Explorar a área", explorarArea);
    adicionarEscolha(`Entrar na Masmorra (Rank ${game.player.currentArea})`, () => entrarMasmorra(game.player.currentArea));
    adicionarEscolha("Ver atributos", abrirAtributos);
    adicionarEscolha("Abrir habilidades", abrirSkills);
    adicionarEscolha("Abrir inventário", abrirInventario);
    // MODIFICATION: Changed level requirement for "Mudar de Área"
    if (game.player.nivel >= 10) {
        adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
    }
    atualizarStatusAtributos();
  }

  function completarMasmorra(battleMsg) {
    toggleHeaderNavButtons(false); // Enable header buttons
    game.dungeon.bossDefeated = true;
    let msg = battleMsg; 
    
    msg += `<br/><br/><span class="font-bold text-green-400">Você conquistou a ${game.dungeon.name}!</span>`;
    const bonusMoedas = randomInt(100, 250) * (rankToIndex(game.dungeon.bossRankForDungeon) + 1);
    game.player.moedas += bonusMoedas;
    msg += `<br/>Você encontrou um tesouro com <span class="font-bold text-yellow-300">${bonusMoedas}</span> moedas extras!`;
    
    const bonusXp = randomInt(50,100) * (rankToIndex(game.dungeon.bossRankForDungeon) +1);
    game.player.xp += bonusXp;
    msg += `<br/>Você ganhou <span class="font-bold text-yellow-400">${bonusXp}</span> XP bônus pela conquista!`;
    // Check for level up after bonus XP (simplified - full check is in derrotarMonstro)
    let leveledUpPostDungeon = false;
    while (game.player.xp >= game.player.xpProximoNivel) {
        leveledUpPostDungeon = true;
        game.player.xp -= game.player.xpProximoNivel;
        game.player.nivel++;
        game.player.pontosDistribuir += 5;
        msg += `<br/>UAU! O XP bônus fez você subir para o nível <span class="font-bold text-green-400">${game.player.nivel}</span>! Ganhou +5 pontos de atributo.`;
        game.player.xpProximoNivel = Math.floor(game.player.xpProximoNivel * 1.25);
        atualizarRank();
    }
    if(leveledUpPostDungeon) atualizarAtributosDerivados();


    game.dungeon.active = false;
    game.estado = "inicio";
    game.batalha.isBossBattle = false; // Ensure boss flag is off

    mostrarMensagem(msg + "<br/><br/>Você emerge da masmorra vitorioso. O que fazer agora?");
    limparEscolhas();
    adicionarEscolha("Explorar a área", explorarArea);
    adicionarEscolha(`Entrar em outra Masmorra (Rank ${game.player.currentArea})`, () => entrarMasmorra(game.player.currentArea)); 
    adicionarEscolha("Ver atributos", abrirAtributos);
    adicionarEscolha("Abrir habilidades", abrirSkills);
    adicionarEscolha("Abrir inventário", abrirInventario);
    // MODIFICATION: Changed level requirement for "Mudar de Área"
     if (game.player.nivel >= 10) {
        adicionarEscolha("Mudar de Área", abrirTelaMudarArea);
    }
    atualizarStatusAtributos();
  }

  // Event Listeners
  document.getElementById("btn-inicio").addEventListener("click", abrirInicio);
  document.getElementById("btn-atributos").addEventListener("click", abrirAtributos);
  document.getElementById("btn-skills").addEventListener("click", abrirSkills);
  document.getElementById("btn-inventario").addEventListener("click", abrirInventario);
  document.getElementById("btn-mercador").addEventListener("click", abrirMercador);
  document.getElementById("btn-sair").addEventListener("click", sairJogo);

  document.getElementById("atributos-screen").addEventListener("click", manipularBotaoAtributo);
  document.getElementById("btn-salvar-atributos").addEventListener("click", salvarAtributos);

  document.getElementById("btn-comprar-mercador").addEventListener("click", comprarItensMercador);

  function sairJogo() {
    if (confirm("Deseja realmente sair do jogo? O progresso não salvo será perdido.")) {
      location.reload(); 
    }
  }

  // Start the game
  iniciarJogo();

})();
</script>

</body>
</html>
